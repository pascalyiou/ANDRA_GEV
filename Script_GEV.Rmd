---
title: "Script GEV"
author: "HASBINI Laura"
date: "2023-02-13"
output: html_document
---

```{r, warning=FALSE, error=FALSE, message=FALSE}
library(tidyverse)
library(ggplot2)
library(ncdf4)
library(extRemes)
source("caldat.R")
source("gev_gdp.R")
library(dplyr)
library(patchwork)
library(zoo)
library(Dict)
library(cowplot)
fig_path = '/home/estimr3/lhasbini/ANDRA/R_fig/'
data_path = '/home/estimr3/lhasbini/ANDRA/R_data/'
CMIP6_Ajust_path_R2D2 = "/home/estimr3/yiou/ANDRA2022/CMIP6_R2D2/GrandEst/"
CMIP6_Ajust_path_CDFt = "/home/estimr3/yiou/ANDRA2022/CMIP6_CDFt-L-1V-0L/GrandEst/"
CMIP6_path = "/home/estimr3/lhasbini/CMIP6/"
```

# Preparation of the data
## Extract and create dataframe

```{r, init of global param}
#### Initializatin of global parameters ####
variable='tasmin'
stations = c('Bure','St Dizier','Cirfontaines')
scenarios = c('historical', 'ssp126', 'ssp245', 'ssp370', 'ssp585')
groups = c('MPI-M', 'AS-RCEC', 'BCC', 'CCCma', 'CNRM-CERFACS', 'CSIRO', 'EC-Earth-Consortium', 'IPSL',  'MRI', 'NOAA-GFDL')  
models = c('MPI-ESM1-2-LR', 'TaiESM1', 'BCC-CSM2-MR', 'CanESM5', 'CNRM-ESM2-1', 'ACCESS-ESM1-5', 'EC-Earth3','IPSL-CM6A-LR', 'MRI-ESM2-0', 'GFDL-ESM4') 

groups_no_GFDL = c('MPI-M', 'AS-RCEC', 'BCC', 'CCCma', 'CNRM-CERFACS', 'CSIRO', 'EC-Earth-Consortium', 'IPSL',  'MRI')  
models_no_GFDL = c('MPI-ESM1-2-LR', 'TaiESM1', 'BCC-CSM2-MR', 'CanESM5', 'CNRM-ESM2-1', 'ACCESS-ESM1-5', 'EC-Earth3','IPSL-CM6A-LR', 'MRI-ESM2-0') 

#### Extract CMIP6 data ####
tas_global = data_CMIP6_fldmean_yearmean_to_df(models, CMIP6_path, 'tas', scenarios, 'Global')
tas_Europe = data_CMIP6_fldmean_yearmean_to_df(models, CMIP6_path, 'tas', scenarios, 'Europe')

tasmax_CMIP6_GE = data_CMIP6_GE_to_df(models, CMIP6_path, 'tasmax', scenarios)
#tasmax_CMIP6_GE.JJA = data_CMIP6_GE_to_df(models, CMIP6_path, 'tasmax', scenarios, season = 'JJA')

TX_CMIP6_GE = data_CMIP_to_varn_max(tasmax_CMIP6_GE)
TX_CMIP6_GE = TX_CMIP6_GE %>% mutate(station='GrandEst')

#### extract Adjust data tasmax, TX ####
tasmax_adjust_stations = data_adjust_to_df(groups, models, CMIP6_Ajust_path_R2D2, 'tasmax', scenarios, stations, 'R2D2')
tasmax_adjust_stations.JJA = data_adjust_to_df(groups, models, CMIP6_Ajust_path_R2D2, 'tasmax', scenarios, stations, 'R2D2', 'JJA')
tasmax_adjust_CDFt_stations = data_adjust_to_df(groups_no_GFDL, models_no_GFDL, paste0(CMIP6_Ajust_path_CDFt,"tasmax/"), 'tasmax', scenarios, stations, 'CDFt')

#Compute yearly mean temperature
TX_adjust_stations = data_to_varn_max(tasmax_adjust_stations)
TX_adjust_CDFt_stations = data_to_varn_max(tasmax_adjust_CDFt_stations)
#TX_adjust_stations.JJA = data_to_varn_max(tasmax_adjust_stations.JJA)

#### extract Adjust data tasmin, TN ####
tasmin_CMIP6_GE = data_CMIP6_GE_to_df(models, CMIP6_path, 'tasmin', scenarios)
tasmin_CMIP6_GE.DJF = data_CMIP6_GE_to_df(models, CMIP6_path, 'tasmin', scenarios, season = 'DJF')

#TN_CMIP6_GE = data_CMIP_to_varn_min(tasmin_CMIP6_GE)
#TN_CMIP6_GE = TN_CMIP6_GE %>% mutate(station='GrandEst')

tasmin_adjust_stations = data_adjust_to_df(groups, models, CMIP6_Ajust_path_R2D2, 'tasmin', scenarios, stations, 'R2D2')
tasmin_adjust_stations.JJA = data_adjust_to_df(groups, models, CMIP6_Ajust_path_R2D2, 'tasmin', scenarios, stations, 'R2D2', 'JJA')
tasmin_adjust_CDFt_stations = data_adjust_to_df(groups_no_GFDL, models_no_GFDL, paste0(CMIP6_Ajust_path_CDFt,"tasmin/"), 'tasmin', scenarios, stations, 'CDFt')

#Compute yearly mean temperature
TN_adjust_stations = data_to_varn_min(tasmin_adjust_stations)
TN_adjust_CDFt_stations = data_to_varn_min(tasmin_adjust_CDFt_stations)

#### Historical records & ECS ####
TX_record_stations =data.frame(TX = rep(c(40, 40, 41.4), 4),
                        station = rep(c('Bure', 'Cirfontaines', 'St Dizier'),4), 
                        scenario = c(rep('ssp126', 3), rep('ssp245', 3), rep('ssp370', 3), rep('ssp585', 3)), 
                        CMIP_model=rep(models, each=12))

TN_record_stations = data.frame(TN = rep(rep(c(-19.6,-19.6,-22.5),4),10), 
                                station = rep(rep(c('Bure', 'Cirfontaines', 'St Dizier'),4), 10), 
                        scenario = rep(c(rep('ssp126', 3), rep('ssp245', 3), rep('ssp370', 3), rep('ssp585', 3)), 10), 
                        CMIP_model = rep(models, each=12))

ECS = data.frame(CMIP_model = c('MPI-ESM1-2-LR', 'BCC-CSM2-MR', 'MRI-ESM2-0', 'ACCESS-ESM1-5', 'GFDL-ESM4', 'EC-Earth3', 'IPSL-CM6A-LR', 'CanESM5'), 
                 ECS = c(2.98, 3.04, 3.15, 3.87, 3.9, 4.3, 4.56, 5.62))
```

```{r, tasmax previously calculated data}
ns_model_GMST.gev.params = readRDS(file=paste(data_path, "gev_ns_tasmax_adjust_params_GMST.Rda", sep=""))
ns_model_GMST.gev.rl = readRDS(file=paste(data_path, "gev_ns_tasmax_adjust_100y_rl_2100_GMST.Rda", sep=""))
ns_model_EMST.gev.params = readRDS(file=paste(data_path, "gev_ns_tasmax_adjust_params_EMST.Rda", sep=""))
ns_model_EMST.gev.rl = readRDS(file=paste(data_path, "gev_ns_tasmax_adjust_100y_rl_2100_EMST.Rda", sep=""))

#Final after selection procedure
ns_model_GMST_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_tasmax_adjust_params_GMST.Rda", sep=""))
ns_model_GMST_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_tasmax_adjust_100y_rl_2100_GMST.Rda", sep=""))
ns_model_EMST_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_tasmax_adjust_params_EMST.Rda", sep=""))
ns_model_EMST_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_tasmax_adjust_100y_rl_2100_EMST.Rda", sep=""))

#WITHOUT THE HISTORICAL DATA IN THE FIT
ns_model_GMST_no_hist.gev.params = readRDS(file=paste(data_path, "gev_ns_no_hist_tasmax_adjust_params_GMST.Rda", sep=""))
ns_model_GMST_no_hist.gev.rl = readRDS(file=paste(data_path, "gev_ns_no_hist_tasmax_adjust_100y_rl_2100_GMST.Rda", sep=""))
ns_model_EMST_no_hist.gev.params = readRDS(file=paste(data_path, "gev_ns_no_hist_tasmax_adjust_params_EMST.Rda", sep=""))
ns_model_EMST_no_hist.gev.rl = readRDS(file=paste(data_path, "gev_ns_no_hist_tasmax_adjust_100y_rl_2100_EMST.Rda", sep=""))

#WITHOUT THE HISTORICAL DATA IN THE FIT
ns_model_GMST_no_hist_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_no_hist_tasmax_adjust_params_GMST.Rda", sep=""))
ns_model_GMST_no_hist_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_no_hist_tasmax_adjust_100y_rl_2100_GMST.Rda", sep=""))
ns_model_EMST_no_hist_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_no_hist_tasmax_adjust_params_EMST.Rda", sep=""))
ns_model_EMST_no_hist_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_no_hist_tasmax_adjust_100y_rl_2100_EMST.Rda", sep=""))

#WITHOUT THE MAX
ns_model_GMST_no_max.gev.params = readRDS(file=paste(data_path, "gev_ns_no_max_tasmax_adjust_params_GMST.Rda", sep=""))
ns_model_GMST_no_max.gev.rl = readRDS(file=paste(data_path, "gev_ns_no_max_tasmax_adjust_100y_rl_2100_GMST.Rda", sep=""))
ns_model_EMST_no_max.gev.params = readRDS(file=paste(data_path, "gev_ns_no_max_tasmax_adjust_params_EMST.Rda", sep=""))
ns_model_EMST_no_max.gev.rl = readRDS(file=paste(data_path, "gev_ns_no_max_tasmax_adjust_100y_rl_2100_EMST.Rda", sep=""))

#Final after selection procedure
ns_model_GMST_no_max_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_no_max_tasmax_adjust_params_GMST.Rda", sep=""))
ns_model_GMST_no_max_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_no_max_tasmax_adjust_100y_rl_2100_GMST.Rda", sep=""))
ns_model_EMST_no_max_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_no_max_tasmax_adjust_params_EMST.Rda", sep=""))
ns_model_EMST_no_max_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_no_max_tasmax_adjust_100y_rl_2100_EMST.Rda", sep=""))
```

```{r, tasmin previously calculated data}
ns_model_tasmin_GMST.gev.params = readRDS(file=paste(data_path, "gev_ns_tasmin_adjust_params_GMST.Rda", sep=""))
ns_model_tasmin_GMST.gev.rl = readRDS(file=paste(data_path, "gev_ns_tasmin_adjust_100y_rl_2100_GMST.Rda", sep=""))
ns_model_tasmin_EMST.gev.params = readRDS(file=paste(data_path, "gev_ns_tasmin_adjust_params_EMST.Rda", sep=""))
ns_model_tasmin_EMST.gev.rl = readRDS(file=paste(data_path, "gev_ns_tasmin_adjust_100y_rl_2100_EMST.Rda", sep=""))

#Final after selection procedure
ns_model_tasmin_GMST_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_tasmin_adjust_params_GMST.Rda", sep=""))
ns_model_tasmin_GMST_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_tasmin_adjust_100y_rl_2100_GMST.Rda", sep=""))
ns_model_tasmin_EMST_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_tasmin_adjust_params_EMST.Rda", sep=""))
ns_model_tasmin_EMST_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_tasmin_adjust_100y_rl_2100_EMST.Rda", sep=""))

#WITHOUT THE HISTORICAL DATA IN THE FIT
ns_model_tasmin_GMST_no_hist.gev.params = readRDS(file=paste(data_path, "gev_ns_no_hist_tasmin_adjust_params_GMST.Rda", sep=""))
ns_model_tasmin_GMST_no_hist.gev.rl = readRDS(file=paste(data_path, "gev_ns_no_hist_tasmin_adjust_100y_rl_2100_GMST.Rda", sep=""))
ns_model_tasmin_EMST_no_hist.gev.params = readRDS(file=paste(data_path, "gev_ns_no_hist_tasmin_adjust_params_EMST.Rda", sep=""))
ns_model_tasmin_EMST_no_hist.gev.rl = readRDS(file=paste(data_path, "gev_ns_no_hist_tasmin_adjust_100y_rl_2100_EMST.Rda", sep=""))
# 
#WITHOUT THE HISTORICAL DATA IN THE FIT
# ns_model_tasmin_GMST_no_hist_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_no_hist_tasmin_adjust_params_GMST.Rda", sep=""))
# ns_model_tasmin_GMST_no_hist_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_no_hist_tasmin_adjust_100y_rl_2100_GMST.Rda", sep=""))
# ns_model_tasmin_EMST_no_hist_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_no_hist_tasmin_adjust_params_EMST.Rda", sep=""))
# ns_model_tasmin_EMST_no_hist_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_no_hist_tasmin_adjust_100y_rl_2100_EMST.Rda", sep=""))

#WITHOUT THE MAX
ns_model_tasmin_GMST_no_max.gev.params = readRDS(file=paste(data_path, "gev_ns_no_max_tasmin_adjust_params_GMST.Rda", sep=""))
ns_model_tasmin_GMST_no_max.gev.rl = readRDS(file=paste(data_path, "gev_ns_no_max_tasmin_adjust_100y_rl_2100_GMST.Rda", sep=""))
ns_model_tasmin_EMST_no_max.gev.params = readRDS(file=paste(data_path, "gev_ns_no_max_tasmin_adjust_params_EMST.Rda", sep=""))
ns_model_tasmin_EMST_no_max.gev.rl = readRDS(file=paste(data_path, "gev_ns_no_max_tasmin_adjust_100y_rl_2100_EMST.Rda", sep=""))
# 
# #Final after selection procedure
# ns_model_tasmin_GMST_no_max_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_no_max_tasmin_adjust_params_GMST.Rda", sep=""))
# ns_model_tasmin_GMST_no_max_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_no_max_tasmin_adjust_100y_rl_2100_GMST.Rda", sep=""))
# ns_model_tasmin_EMST_no_max_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_no_max_tasmin_adjust_params_EMST.Rda", sep=""))
# ns_model_tasmin_EMST_no_max_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_no_max_tasmin_adjust_100y_rl_2100_EMST.Rda", sep=""))

#WITHOUT THE MAX
ns_model_tasmin_GMST_no_hist_no_max.gev.params = readRDS(file=paste(data_path, "gev_ns_no_hist_no_max_tasmin_adjust_params_GMST.Rda", sep=""))
ns_model_tasmin_GMST_no_hist_no_max.gev.rl = readRDS(file=paste(data_path, "gev_ns_no_hist_no_max_tasmin_adjust_100y_rl_2100_GMST.Rda", sep=""))
ns_model_tasmin_EMST_no_hist_no_max.gev.params = readRDS(file=paste(data_path, "gev_ns_no_hist_no_max_tasmin_adjust_params_EMST.Rda", sep=""))
ns_model_tasmin_EMST_no_hist_no_max.gev.rl = readRDS(file=paste(data_path, "gev_ns_no_hist_no_max_tasmin_adjust_100y_rl_2100_EMST.Rda", sep=""))
```

```{r, tasmax CDFt previously calculated data}
ns_model_CDFt_GMST.gev.params = readRDS(file=paste(data_path, "gev_ns_tasmax_adjust_CDFt_params_GMST.Rda", sep=""))
ns_model_CDFt_GMST.gev.rl = readRDS(file=paste(data_path, "gev_ns_tasmax_adjust_CDFt_100y_rl_2100_GMST.Rda", sep=""))
ns_model_CDFt_EMST.gev.params = readRDS(file=paste(data_path, "gev_ns_tasmax_adjust_CDFt_params_EMST.Rda", sep=""))
ns_model_CDFt_EMST.gev.rl = readRDS(file=paste(data_path, "gev_ns_tasmax_adjust_CDFt_100y_rl_2100_EMST.Rda", sep=""))

#Final after selection procedure
ns_model_CDFt_GMST_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_tasmax_adjust_CDFt_params_GMST.Rda", sep=""))
ns_model_CDFt_GMST_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_tasmax_adjust_CDFt_100y_rl_2100_GMST.Rda", sep=""))
ns_model_CDFt_EMST_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_tasmax_adjust_CDFt_params_EMST.Rda", sep=""))
ns_model_CDFt_EMST_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_tasmax_adjust_CDFt_100y_rl_2100_EMST.Rda", sep=""))

#WITHOUT THE HISTORICAL DATA IN THE FIT
# ns_model_CDFt_GMST_no_hist.gev.params = readRDS(file=paste(data_path, "gev_ns_no_hist_tasmax_adjust_CDFt_params_GMST.Rda", sep=""))
# ns_model_CDFt_GMST_no_hist.gev.rl = readRDS(file=paste(data_path, "gev_ns_no_hist_tasmax_adjust_CDFt_100y_rl_2100_GMST.Rda", sep=""))
# ns_model_CDFt_EMST_no_hist.gev.params = readRDS(file=paste(data_path, "gev_ns_no_hist_tasmax_adjust_CDFt_params_EMST.Rda", sep=""))
# ns_model_CDFt_EMST_no_hist.gev.rl = readRDS(file=paste(data_path, "gev_ns_no_hist_tasmax_adjust_CDFt_100y_rl_2100_EMST.Rda", sep=""))

#WITHOUT THE HISTORICAL DATA IN THE FIT
# ns_model_CDFt_GMST_no_hist_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_no_hist_tasmax_adjust_CDFt_params_GMST.Rda", sep=""))
# ns_model_CDFt_GMST_no_hist_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_no_hist_tasmax_adjust_CDFt_100y_rl_2100_GMST.Rda", sep=""))
# ns_model_CDFt_EMST_no_hist_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_no_hist_tasmax_adjust_CDFt_params_EMST.Rda", sep=""))
# ns_model_CDFt_EMST_no_hist_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_no_hist_tasmax_adjust_CDFt_100y_rl_2100_EMST.Rda", sep=""))

#WITHOUT THE MAX
ns_model_CDFt_GMST_no_max.gev.params = readRDS(file=paste(data_path, "gev_ns_no_max_tasmax_adjust_CDFt_params_GMST.Rda", sep=""))
ns_model_CDFt_GMST_no_max.gev.rl = readRDS(file=paste(data_path, "gev_ns_no_max_tasmax_adjust_CDFt_100y_rl_2100_GMST.Rda", sep=""))
ns_model_CDFt_EMST_no_max.gev.params = readRDS(file=paste(data_path, "gev_ns_no_max_tasmax_adjust_CDFt_params_EMST.Rda", sep=""))
ns_model_CDFt_EMST_no_max.gev.rl = readRDS(file=paste(data_path, "gev_ns_no_max_tasmax_adjust_CDFt_100y_rl_2100_EMST.Rda", sep=""))

#Final after selection procedure
ns_model_CDFt_GMST_no_max_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_no_max_tasmax_adjust_CDFt_params_GMST.Rda", sep=""))
ns_model_CDFt_GMST_no_max_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_no_max_tasmax_adjust_CDFt_100y_rl_2100_GMST.Rda", sep=""))
ns_model_CDFt_EMST_no_max_final.gev.params = readRDS(file=paste(data_path, "gev_final_ns_no_max_tasmax_adjust_CDFt_params_EMST.Rda", sep=""))
ns_model_CDFt_EMST_no_max_final.gev.rl = readRDS(file=paste(data_path, "gev_final_ns_no_max_tasmax_adjust_CDFt_100y_rl_2100_EMST.Rda", sep=""))
```

```{r, tasmax CMIP previously calculatd data}
ns_model_CMIP_GMST.gev.params = readRDS(file=paste(data_path, "gev_ns_tasmax_CMIP_params_GMST.Rda", sep=""))
ns_model_CMIP_GMST.gev.rl = readRDS(file=paste(data_path, "gev_ns_tasmax_CMIP_100y_rl_2100_GMST.Rda", sep=""))
ns_model_CMIP_EMST.gev.params = readRDS(file=paste(data_path, "gev_ns_tasmax_CMIP_params_EMST.Rda", sep=""))
ns_model_CMIP_EMST.gev.rl = readRDS(file=paste(data_path, "gev_ns_tasmax_CMIP_100y_rl_2100_EMST.Rda", sep=""))
```

```{r}
#Selection process of CMIP data
ns_model_CMIP_GMST_final.gev = selection_models(tasmax_CMIP6_GE, TX_CMIP_GE_GMST, ns_model_CMIP_GMST.gev.params, ns_rl = ns_model_CMIP_GMST.gev.rl, variable)
ns_model_CMIP_GMST_final.gev.params = ns_model_CMIP_GMST_final.gev$params
ns_model_CMIP_GMST_final.gev.rl = ns_model_CMIP_GMST_final.gev$return_levels

ns_model_CMIP_EMST_final.gev = selection_models(tasmax_CMIP6_GE, TX_CMIP_GE_EMST, ns_model_CMIP_EMST.gev.params, ns_rl = ns_model_CMIP_EMST.gev.rl, variable)
ns_model_CMIP_EMST_final.gev.params = ns_model_CMIP_EMST_final.gev$params
ns_model_CMIP_EMST_final.gev.rl = ns_model_CMIP_EMST_final.gev$return_levels
```

```{r}
variable='tasmin'

#Regular
ns_model_tasmin_GMST_final.gev = selection_models(tasmin_adjust_stations, TN_adjust_stations_GMST, ns_model_tasmin_GMST.gev.params, ns_rl = ns_model_tasmin_GMST.gev.rl, variable)
ns_model_tasmin_GMST_final.gev.params = ns_model_tasmin_GMST_final.gev$params
ns_model_tasmin_GMST_final.gev.rl = ns_model_tasmin_GMST_final.gev$return_levels

ns_model_tasmin_EMST_final.gev = selection_models(tasmin_adjust_stations, TN_adjust_stations_EMST, ns_model_tasmin_EMST.gev.params, ns_rl = ns_model_tasmin_EMST.gev.rl, variable)
ns_model_tasmin_EMST_final.gev.params = ns_model_tasmin_EMST_final.gev$params
ns_model_tasmin_EMST_final.gev.rl = ns_model_tasmin_EMST_final.gev$return_levels

saveRDS(ns_model_tasmin_GMST_final.gev.params, file=paste(data_path, "gev_final_ns_",variable,"_adjust_params_GMST.Rda", sep=""))
saveRDS(ns_model_tasmin_GMST_final.gev.rl, file=paste(data_path, "gev_final_ns_",variable,"_adjust_",return_period,"y_rl_",return_horizon[1],"_GMST.Rda", sep=""))

saveRDS(ns_model_tasmin_EMST_final.gev.params, file=paste(data_path, "gev_final_ns_",variable,"_adjust_params_EMST.Rda", sep=""))
saveRDS(ns_model_tasmin_EMST_final.gev.rl, file=paste(data_path, "gev_final_ns_",variable,"_adjust_",return_period,"y_rl_",return_horizon[1],"_EMST.Rda", sep=""))

#No max
ns_model_tasmin_GMST_no_max_final.gev = selection_models(tasmin_adjust_stations, TN_adjust_stations_GMST, ns_model_tasmin_GMST_no_max.gev.params, ns_rl = ns_model_tasmin_GMST_no_max.gev.rl, variable)
ns_model_tasmin_GMST_no_max_final.gev.params = ns_model_tasmin_GMST_no_max_final.gev$params
ns_model_tasmin_GMST_no_max_final.gev.rl = ns_model_tasmin_GMST_no_max_final.gev$return_levels

ns_model_tasmin_EMST_no_max_final.gev = selection_models(tasmin_adjust_stations, TN_adjust_stations_EMST, ns_model_tasmin_EMST_no_max.gev.params, ns_rl = ns_model_tasmin_EMST_no_max.gev.rl, variable)
ns_model_tasmin_EMST_no_max_final.gev.params = ns_model_tasmin_EMST_no_max_final.gev$params
ns_model_tasmin_EMST_no_max_final.gev.rl = ns_model_tasmin_EMST_no_max_final.gev$return_levels

saveRDS(ns_model_tasmin_GMST_no_max_final.gev.params, file=paste(data_path, "gev_final_ns_no_max_",variable,"_adjust_params_GMST.Rda", sep=""))
saveRDS(ns_model_tasmin_GMST_no_max_final.gev.rl, file=paste(data_path, "gev_final_ns_no_max_",variable,"_adjust_",return_period,"y_rl_",return_horizon[1],"_GMST.Rda", sep=""))

saveRDS(ns_model_tasmin_EMST_no_max_final.gev.params, file=paste(data_path, "gev_final_ns_no_max_",variable,"_adjust_params_EMST.Rda", sep=""))
saveRDS(ns_model_tasmin_EMST_no_max_final.gev.rl, file=paste(data_path, "gev_final_ns_no_max_",variable,"_adjust_",return_period,"y_rl_",return_horizon[1],"_EMST.Rda", sep=""))
```

#Initial plots

```{r, Plot of TN}
for(CMIP_mod in models){
  for(sc in scenarios){
  p =ggplot() +
    geom_point(aes(x=var, y=covariate), 
               data = TX_adjust_stations_GMST %>%filter(CMIP_model==CMIP_mod, station=='St Dizier', scenario==sc)) +
  labs(x='Covariate [°C]', 
       y='Temperature [°C]', 
       title = paste('Tasmax fct of GMST',CMIP_mod,'St Dizier', sc))
  plot(p)
  }
}
```

```{r, Plot of GEV distribution + data}
st = 'St Dizier'
CMIP_mod = 'IPSL-CM6A-LR'
sc = 'ssp370'
fevd_plot = fevd(var, data = TX_adjust_stations %>% filter(station==st, CMIP_model==CMIP_mod, scenario%in%c('historical', sc)))
tx_plot = TX_adjust_stations %>% filter(station==st, CMIP_model==CMIP_mod, scenario%in%c('historical', sc)) %>% select(var)
```

```{r}
png(paste(fig_path,"gev_distrib_IPSL-CM6A-LR_StDizier_ssp370.png"))#, width=8, height=5)
plot(fevd_plot, type='density', main="", xlab="", ylab="", frame = FALSE)
hist(as.numeric(unlist(tx_plot)), col=rgb(0,0,1,0.4), freq=FALSE, border=FALSE, add=TRUE, frame = FALSE)
title(main = "Distribution with GEV fit- St Dizier - IPSL-CM6A-LR - ssp370",
      xlab = "TX [°C]", ylab = "Density")
dev.off()
```

#GEV and GDP with extRemes
##Computation of Return level

###Non stationary
Assume params lineary dependant of time
M000 = Stationary
M100 = Linear in mu
M110 = Linear in mu and sigma 
M-100 = Stationary fitted to M(t)-Xt (with Xt the covariate)
M-110 = Linear in sigma, fitted to M(t)-Xt (with Xt the covariate)

```{r, Parameters for GEV computation}
ns_models = c('M110','M000','M-100', 'M-110', 'M100')
#ns_models = c('M000', 'M100', 'M110')
alpha_llh = 0.1
return_horizon = c(2100)
return_period= 100
```

For non-stationary fit with gpd, need to have a varying threshold u

For Peak over threshold in non-stationary environment. The threshold as well as the scale parameter should vary as a function of time. Regarding the threshold this one is computed as the yearly 95th quantile later smoothed with spline. 

#### Global mean temperature to covariate 

```{r, Compute spline of the Global year mean}
spar = 0.9
tas_global_spline = data.frame(matrix(ncol = ncol(tas_global)+1, nrow = 0))
colnames(tas_global_spline) = append(colnames(tas_global),c('covariate'))
for(mod in models){
  for(sc in c('ssp126', 'ssp245', 'ssp370', 'ssp585')){
    data_loop = tas_global%>%filter(scenario%in%c('historical', sc), CMIP_model==mod)
    data_loop = data_loop %>% mutate(var = scale(var))
    model_spline_TX_GMST_loop = smooth.spline(x=data_loop$year, y = data_loop$var, spar=spar)
    data_loop$covariate  = predict(model_spline_TX_GMST_loop, data_loop$year)$y
    data_loop$scenario = sc
    tas_global_spline = rbind(tas_global_spline, data_loop)
  }
  sc = 'historical'
  data_loop = tas_global%>%filter(scenario== sc, CMIP_model==mod)
  data_loop_scenarios = tas_global_spline%>%filter(scenario%in%c('ssp126', 'ssp245', 'ssp370', 'ssp585'), CMIP_model==mod, year<2015)
  data_loop = merge(data_loop, aggregate(covariate~year, data_loop_scenarios, mean))
  data_loop$scenario=sc
  tas_global_spline = rbind(tas_global_spline, data_loop)
}
```

```{r, Compute spline of the Europe year mean}
spar = 0.9
tas_europe_spline = data.frame(matrix(ncol = ncol(tas_Europe)+1, nrow = 0))
colnames(tas_europe_spline) = append(colnames(tas_Europe),c('covariate'))
for(mod in models){
  for(sc in c('ssp126', 'ssp245', 'ssp370', 'ssp585')){
    data_loop = tas_Europe%>%filter(scenario%in%c('historical', sc), CMIP_model==mod)
    data_loop = data_loop %>% mutate(var = scale(var))
    model_spline_TX_EMST_loop = smooth.spline(x=data_loop$year, y = data_loop$var, spar=spar)
    data_loop$covariate  = predict(model_spline_TX_EMST_loop, data_loop$year)$y
    data_loop$scenario = sc
    tas_europe_spline = rbind(tas_europe_spline, data_loop)
  }
  sc = 'historical'
  data_loop = tas_Europe%>%filter(scenario== sc, CMIP_model==mod)
  data_loop_scenarios = tas_europe_spline%>%filter(scenario%in%c('ssp126', 'ssp245', 'ssp370', 'ssp585'), CMIP_model==mod, year<2015)
  data_loop = merge(data_loop, aggregate(covariate~year, data_loop_scenarios, mean))
  data_loop$scenario=sc
  tas_europe_spline = rbind(tas_europe_spline, data_loop)
}
```

```{r, Add mean temperature as a covariate}
tas_global_spline_mutate = tas_global_spline %>% select(-var)
tas_europe_spline_mutate = tas_europe_spline %>% select(-var)
TX_adjust_stations_GMST = merge(TX_adjust_stations, tas_global_spline_mutate, by=c("year", "scenario", "CMIP_model"))
TX_adjust_stations_EMST = merge(TX_adjust_stations, tas_europe_spline_mutate, by=c("year", "scenario", "CMIP_model"))
TX_CMIP_GE_GMST = merge(TX_CMIP6_GE, tas_global_spline_mutate, by=c("year", "scenario", "CMIP_model"))
TX_CMIP_GE_EMST = merge(TX_CMIP6_GE, tas_europe_spline_mutate, by=c("year", "scenario", "CMIP_model"))
TX_adjust_CDFt_stations_GMST = merge(TX_adjust_CDFt_stations, tas_global_spline_mutate, by=c("year", "scenario", "CMIP_model"))
TX_adjust_CDFt_stations_EMST = merge(TX_adjust_CDFt_stations, tas_europe_spline_mutate, by=c("year", "scenario", "CMIP_model"))


TN_adjust_stations_GMST = merge(TN_adjust_stations, tas_global_spline_mutate, by=c("year", "scenario", "CMIP_model"))
TN_adjust_stations_EMST = merge(TN_adjust_stations, tas_europe_spline_mutate, by=c("year", "scenario", "CMIP_model"))
#tasmax_adjust_stations_global_tas_mean_to_covariate.JJA = merge(spline_threshold(tasmax_adjust_stations.JJA, percentile_threshold = 0.95), tas_global, by=c("year", "scenario", "CMIP_model"))
#tasmax_adjust_stations_global_tas_mean_to_covariate_CMIP.JJA = merge(spline_threshold(tasmax_CMIP6_GE.JJA, percentile_threshold = 0.95), tas_global, by=c("year", "scenario", "CMIP_model"))
```

```{r, Plot GMST and spline fct of time}
CMIP_mod = 'IPSL-CM6A-LR'
ggplot() +
  #geom_point(aes(x=covariate, y=var, color=scenario)) +
  geom_point(aes(x=year, y=var, color=scenario), data = TX_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario %in% c('historical', 'ssp370'), station=='St Dizier')) +
  geom_line(aes(x=year, y=covariate, color=scenario), data = TX_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario %in% c('historical', 'ssp370'), station=='St Dizier')) + 
  #geom_line(aes(x=year, y=covariate, color=scenario)) +
  theme_minimal() +
  labs(x='Year', y='Temperature [°C]', color='Scenario', 
       title = paste(CMIP_mod, '-St Dizier - Tasmax et GMST temperature as a function of time'))
#ggsave(paste(fig_path,"IPSL-CM6A-LR_St_Dizier_tasmax_GMST_fct_time.png", sep=""), width=8, height=5)
```

```{r, Plot tasmax fct of GMST}
CMIP_mod = 'IPSL-CM6A-LR'
sc='ssp370'
ggplot() +
  #geom_point(aes(x=covariate, y=var, color=scenario)) +
  geom_point(aes(x=covariate, y=var, color=scenario), data = TX_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario %in% c('historical', sc), station=='St Dizier')) +
  #geom_line(aes(x=year, y=covariate, color=scenario), data = TX_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario %in% c('historical', 'ssp370'), station=='St Dizier')) + 
  #geom_line(aes(x=year, y=covariate, color=scenario)) +
  theme_minimal() +
  labs(x='GMST Temperature [°C]', y='Tasmax Temperature [°C]', color='Scenario', 
       title = paste(CMIP_mod, '-St Dizier - Tasmax as a function of GMST'))
#ggsave(paste(fig_path,CMIP_mod,"_St_Dizier_tasmax_fct_GMST_",sc, ".png", sep=""), width=8, height=5)
```

```{r, Plot tasmin fct of time}
CMIP_mod = 'TaiESM1'
st = 'Bure'
sc = 'ssp245'
ggplot() +
  #geom_point(aes(x=covariate, y=var, color=scenario)) +
  geom_point(aes(x=year, y=var, color=scenario), data = TN_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario %in% c('historical', sc), station==st)) +
  geom_line(aes(x=year, y=covariate, color=scenario), data = TN_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario %in% c('historical', sc), station==st)) + 
  #geom_line(aes(x=year, y=covariate, color=scenario)) +
  theme_minimal() +
  labs(x='Year', y='Temperature [°C]', color='Scenario', 
       title = paste(CMIP_mod,'-', st,'-Tasmin et GMST temperature as a function of time'))
#ggsave(paste(fig_path,CMIP_mod,"_St_Dizier_tasmin_fct_time_",sc, ".png", sep=""), width=8, height=5)
```

```{r, Plot tasmin fct of GMST}
CMIP_mod = c('IPSL-CM6A-LR')
sc='ssp245'
df_loop = TN_adjust_stations_GMST %>% filter(CMIP_model%in%CMIP_mod, scenario %in% c('historical', sc), station=='St Dizier')
df_loop_no_hist = TN_adjust_stations_GMST %>% filter(CMIP_model%in%CMIP_mod, scenario %in% c(sc), station=='St Dizier')

lm_model = lm(var ~ covariate, data=df_loop)
lm_model_no_hist = lm(var ~ covariate, data=df_loop_no_hist)

ggplot() +
  #geom_point(aes(x=covariate, y=var, color=scenario)) +
  geom_point(aes(x=covariate, y=var, color=scenario), data = TN_adjust_stations_GMST %>% filter(CMIP_model%in%CMIP_mod, scenario %in% c('historical', sc), station=='St Dizier')) +
  geom_line(aes(x=df_loop$covariate, y=predict(lm_model), color='historical'), size=1) +
  geom_line(aes(x=df_loop_no_hist$covariate, y=predict(lm_model_no_hist), color=sc), size=1) +
  #geom_line(aes(x=year, y=covariate, color=scenario), data = TN_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario %in% c('historical', 'ssp370'), station=='St Dizier')) + 
  #geom_line(aes(x=year, y=covariate, color=scenario)) +
  theme_minimal() +
  labs(x='GMST Temperature [°C]', y='Tasmin Temperature [°C]', color='Scenario', 
       title = paste(CMIP_mod, '-', sc, '-St Dizier - Tasmin as a function of GMST')) +
  scale_color_manual(values = c('historical'='#ff5c33', 'ssp245'='#5cd6d6'), 
                     labels=list(paste("historical, R²=", round(as.numeric(summary(lm_model, silent=TRUE)[8]),2)),
                                 paste("ssp2-4.5, R²=", round(as.numeric(summary(lm_model_no_hist, silent=TRUE)[8]), 2))))
ggsave(paste(fig_path,CMIP_mod,"_St_Dizier_tasmin_fct_GMST_",sc, ".png", sep=""), width=9, height=3)
```

```{r, Remove models non working for GEV computation}
TX_adjust_stations_GMST = subset(TX_adjust_stations_GMST, CMIP_model!='MPI-ESM1-2-LR' | scenario!='ssp126'| station != 'Bure')
TX_adjust_stations_EMST = subset(TX_adjust_stations_EMST, CMIP_model!='MPI-ESM1-2-LR' | scenario!='ssp126'| station != 'Bure')
```

```{r, Compute GEV/GPD}
#GEV
 ns_model_GMST_test.gev = gev_ns_rl_param_fct(df_max_with_cov=TN_adjust_stations_GMST_mutate%>%filter(station=='Bure'), CMIP_models=c('EC-Earth3'), ns_model=ns_models, confidence_interval='boot', sigma_exp=TRUE, rl=TRUE, return_period=return_period, return_horizon=return_horizon, variable='tasmin')
# ns_model_GMST_test.gev.params = ns_model_GMST_test.gev$params
# ns_model_GMST_test.gev.rl = ns_model_GMST_test.gev$return_levels 
# 
# ns_model_GMST_test_no_hist.gev = gev_ns_rl_param_fct(df_max_with_cov=TN_adjust_stations_GMST%>%filter(station=='Bure'), CMIP_models=c('BCC-CSM2-MR'), ns_model=ns_models, confidence_interval='boot', sigma_exp=TRUE, rl=TRUE, return_period=return_period, return_horizon=return_horizon, variable='tasmin', with_historical=FALSE)
# ns_model_GMST_test_no_hist.gev.params = ns_model_GMST_test_no_hist.gev$params
# ns_model_GMST_test_no_hist.gev.rl = ns_model_GMST_test_no_hist.gev$return_levels 
#saveRDS(ns_model_GMST.gev.params, file=paste(data_path, "gev_ns_","tasmax","_adjust_params_GMST.Rda", sep=""))
#saveRDS(ns_model_GMST.gev.rl, file=paste(data_path, "gev_ns_","tasmax","_adjust_",return_period,"y_rl_",return_horizon[1],"_GMST.Rda", sep=""))

#write.csv(ns_model_GMST_2050.gev.rl, paste(data_path, "gev_ns_adjust_rl_2050_GMST.csv"))
#ns_model_GMST_test.gev = gev_ns_rl_param_fct(TX_adjust_stations_GMST %>% filter(station=='St Dizier'), models, ns_models, confidence_interval='boot', sigma_exp=TRUE, rl=TRUE, return_period, return_horizon)

#ns_model_EMST.gev = gev_ns_rl_param_fct(df_max_with_cov=TX_adjust_stations_EMST, CMIP_models=models, ns_model=ns_models, confidence_interval='boot', sigma_exp=TRUE, rl=TRUE, return_period=return_period, return_horizon=return_horizon, variable='tasmax')
#ns_model_EMST.gev.params = ns_model_EMST.gev$params
#ns_model_EMST.gev.rl = ns_model_EMST.gev$return_levels 
#saveRDS(ns_model_EMST.gev.params, file=paste(data_path, "gev_ns_","tasmax","_adjust_params_EMST.Rda", sep=""))
#saveRDS(ns_model_EMST.gev.rl, file=paste(data_path, "gev_ns_","tasmax","_adjust_",return_period,"y_rl_",return_horizon[1],"_EMST.Rda", sep=""))

#GPD Summer
#ns_model_global_tas_mean_cov.gpd.JJA = gpd_ns_rl_param_fct(tasmax_adjust_stations_global_tas_mean_to_covariate.JJA, rl=TRUE, return_period, models_lim, 0.95, ny=92)
#ns_models_global_tas_mean_cov.gpd.JJA.params = ns_model_global_tas_mean_cov.gpd.JJA$params
#ns_models_global_tas_mean_cov.gpd.JJA.rl = ns_model_global_tas_mean_cov.gpd.JJA$return_levels

#GEV, CMIP6
#TX_CMIP_adjust_stations_GMST = subset(TX_CMIP_adjust_stations_GMST, CMIP_model!='CNRM-ESM2-1' | scenario!='ssp126') 
#ns_model_CMIP_GMST.gev =  gev_ns_rl_param_fct(df_max_with_cov=TX_CMIP_adjust_stations_GMST, CMIP_models=models, ns_model=ns_models, confidence_interval='boot', sigma_exp=TRUE, rl=TRUE, return_period=return_period, return_horizon=return_horizon, variable='tasmax')
#saveRDS(ns_model_CMIP_GMST.gev$params, file=paste(data_path, "gev_ns_tasmax_CMIP_params_GMST.Rda", sep=""))
#saveRDS(ns_model_CMIP_GMST.gev$return_levels, file=paste(data_path, "gev_ns_tasmax_CMIP_100y_rl_2100_GMST.Rda", sep=""))

#ns_model_CMIP_EMST.gev =  gev_ns_rl_param_fct(df_max_with_cov=TX_CMIP_adjust_stations_EMST, CMIP_models=models, ns_model=ns_models, confidence_interval='boot', sigma_exp=TRUE, rl=TRUE, return_period=return_period, return_horizon=return_horizon, variable='tasmax')
#saveRDS(ns_model_CMIP_EMST.gev$params, file=paste(data_path, "gev_ns_tasmax_CMIP_params_EMST.Rda", sep=""))
#saveRDS(ns_model_CMIP_EMST.gev$return_levels, file=paste(data_path, "gev_ns_tasmax_CMIP_100y_rl_2100_EMST.Rda", sep=""))

#GPD Summer, CMIP6
#ns_model_global_tas_mean_cov_CMIP.gpd.JJA = gpd_ns_rl_param_fct(tasmax_adjust_stations_global_tas_mean_to_covariate_CMIP.JJA, rl=TRUE, return_period, models_lim, 0.95, ny=92)
#ns_models_global_tas_mean_cov_CMIP.gpd.JJA.params = ns_model_global_tas_mean_cov_CMIP.gpd.JJA$params
#ns_models_global_tas_mean_cov_CMIP.gpd.JJA.rl = ns_model_global_tas_mean_cov_CMIP.gpd.JJA$return_levels
```

```{r, Same for tasmin}
#ns_model_tasmin_GMST.gev = gev_ns_rl_param_fct(TN_adjust_stations_GMST, 'TaiESM1', ns_models, confidence_interval='boot', sigma_exp=TRUE, rl=TRUE, return_period, return_horizon)
#ns_model_tasmin_GMST.gev.params = ns_model_tasmin_GMST.gev$params
#ns_model_tasmin_GMST.gev.rl = ns_model_tasmin_GMST.gev$return_levels 
#saveRDS(ns_model_GMST_2050.gev.rl, file=paste(data_path, "gev_ns_adjust_rl_2050_GMST.Rda", sep=""))
#write.csv(ns_model_GMST_2050.gev.rl, paste(data_path, "gev_ns_adjust_rl_2050_GMST.csv"))

#ns_model_EMST_2050.gev = gev_ns_rl_param_fct(TX_adjust_stations_EMST, models, ns_models, confidence_interval='boot', sigma_exp=TRUE, rl=TRUE, return_period, return_horizon)
#ns_model_EMST.gev.params = ns_model_EMST.gev$params
#ns_model_EMST_2050.gev.rl = ns_model_EMST_2050.gev$return_levels 
#saveRDS(ns_model_EMST_2050.gev.rl, file=paste(data_path, "gev_ns_adjust_rl_2050_EMST.Rda", sep=""))
#write.csv(ns_model_EMST_2050.gev.rl, paste(data_path, "gev_ns_adjust_rl_2050_EMST.csv"))
#saveRDS(ns_model_EMST.gev,file=paste(data_path, "gev_ns_adjust_params_EMST.Rda", sep=""))
```

```{r,Selection procedure}
variable = 'tasmax'
#For all the data 
ns_model_GMST_final.gev = selection_models(tasmax_adjust_stations, TX_adjust_stations_GMST, ns_model_GMST.gev.params, ns_rl = ns_model_GMST.gev.rl, variable)
ns_model_GMST_final.gev.params = ns_model_GMST_final.gev$params
ns_model_GMST_final.gev.rl = ns_model_GMST_final.gev$return_levels

ns_model_EMST_final.gev = selection_models(tasmax_adjust_stations, TX_adjust_stations_EMST, ns_model_EMST.gev.params, ns_rl = ns_model_EMST.gev.rl, variable)
ns_model_EMST_final.gev.params = ns_model_EMST_final.gev$params
ns_model_EMST_final.gev.rl = ns_model_EMST_final.gev$return_levels

#Save final params and return levels
saveRDS(ns_model_GMST_final.gev.params, file=paste(data_path, "gev_final_ns_",variable,"_adjust_params_GMST.Rda", sep=""))
saveRDS(ns_model_GMST_final.gev.rl, file=paste(data_path, "gev_final_ns_",variable,"_adjust_",return_period,"y_rl_",return_horizon[1],"_GMST.Rda", sep=""))

saveRDS(ns_model_EMST_final.gev.params, file=paste(data_path, "gev_final_ns_",variable,"_adjust_params_EMST.Rda", sep=""))
saveRDS(ns_model_EMST_final.gev.rl, file=paste(data_path, "gev_final_ns_",variable,"_adjust_",return_period,"y_rl_",return_horizon[1],"_EMST.Rda", sep=""))

#Without the historical data 
ns_model_GMST_no_hist_final.gev = selection_models(tasmax_adjust_stations, TX_adjust_stations_GMST, ns_model_GMST_no_hist.gev.params, ns_rl = ns_model_GMST_no_hist.gev.rl, variable)
ns_model_GMST_no_hist_final.gev.params = ns_model_GMST_no_hist_final.gev$params
ns_model_GMST_no_hist_final.gev.rl = ns_model_GMST_no_hist_final.gev$return_levels

ns_model_EMST_no_hist_final.gev = selection_models(tasmax_adjust_stations, TX_adjust_stations_EMST, ns_model_EMST_no_hist.gev.params, ns_rl = ns_model_EMST_no_hist.gev.rl, variable)
ns_model_EMST_no_hist_final.gev.params = ns_model_EMST_no_hist_final.gev$params
ns_model_EMST_no_hist_final.gev.rl = ns_model_EMST_no_hist_final.gev$return_levels

#Save final params and return levels
saveRDS(ns_model_GMST_no_hist_final.gev.params, file=paste(data_path, "gev_final_ns_no_hist_",variable,"_adjust_params_GMST.Rda", sep=""))
saveRDS(ns_model_GMST_no_hist_final.gev.rl, file=paste(data_path, "gev_final_ns_no_hist_",variable,"_adjust_",return_period,"y_rl_",return_horizon[1],"_GMST.Rda", sep=""))

saveRDS(ns_model_EMST_no_hist_final.gev.params, file=paste(data_path, "gev_final_ns_no_hist_",variable,"_adjust_params_EMST.Rda", sep=""))
saveRDS(ns_model_EMST_no_hist_final.gev.rl, file=paste(data_path, "gev_final_ns_no_hist_",variable,"_adjust_",return_period,"y_rl_",return_horizon[1],"_EMST.Rda", sep=""))
```

```{r,Selection procedure, GEV no max}
#variable = 'tasmax'
ns_model_GMST_no_max_final.gev = selection_models(tasmax_adjust_stations, TX_adjust_stations_GMST, ns_model_GMST_no_max.gev.params, ns_rl = ns_model_GMST_no_max.gev.rl, variable)
ns_model_GMST_no_max_final.gev.params = ns_model_GMST_no_max_final.gev$params
ns_model_GMST_no_max_final.gev.rl = ns_model_GMST_no_max_final.gev$return_levels

ns_model_EMST_no_max_final.gev = selection_models(tasmax_adjust_stations, TX_adjust_stations_EMST, ns_model_EMST_no_max.gev.params, ns_rl = ns_model_EMST_no_max.gev.rl, variable)
ns_model_EMST_no_max_final.gev.params = ns_model_EMST_no_max_final.gev$params
ns_model_EMST_no_max_final.gev.rl = ns_model_EMST_no_max_final.gev$return_levels

#Save final params and return levels
saveRDS(ns_model_GMST_no_max_final.gev.params, file=paste(data_path, "gev_final_ns_no_max_",variable,"_adjust_params_GMST.Rda", sep=""))
saveRDS(ns_model_GMST_no_max_final.gev.rl, file=paste(data_path, "gev_final_ns_no_max_",variable,"_adjust_",return_period,"y_rl_",return_horizon[1],"_GMST.Rda", sep=""))

saveRDS(ns_model_EMST_no_max_final.gev.params, file=paste(data_path, "gev_final_ns_no_max_",variable,"_adjust_params_EMST.Rda", sep=""))
saveRDS(ns_model_EMST_no_max_final.gev.rl, file=paste(data_path, "gev_final_ns_no_max_",variable,"_adjust_",return_period,"y_rl_",return_horizon[1],"_EMST.Rda", sep=""))
```

###Likelihood ratio test

```{r, Compute likelihood ratio test for adjusted data}
ns_model_ratios.gev = data.frame(matrix(ncol = 6, nrow = 0))
colnames(ns_model_ratios.gev) = c('CMIP_model', 'station', 'scenario', 'ratio', 'alternative', 'p_value')

#ns_model_ratios_CMIP.gev = data.frame(matrix(ncol = 6, nrow = 0))
#colnames(ns_model_ratios_CMIP.gev) = c('CMIP_model', 'station', 'scenario', 'ratio', 'alternative', 'p_value')

for(CMIP_mod in models){
  for(st in stations){
    scenarios_loop = unique(ns_model_GMST_final.gev.params %>% filter(CMIP_model==CMIP_mod, station==st) %>% select(scenario))
    for(sc in scenarios_loop[[1]]){
      M000_GMST = ns_model_GMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M000')%>% select(nllh)
      M100_GMST = ns_model_GMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M100')%>% select(nllh)
      M110_GMST = ns_model_GMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M110')%>% select(nllh)
      M_100_GMST = ns_model_GMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M-100')%>% select(nllh)
      M_110_GMST = ns_model_GMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M-110')%>% select(nllh)
      
      M000_EMST = ns_model_EMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M000')%>% select(nllh)
      M100_EMST = ns_model_EMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M100')%>% select(nllh)
      M110_EMST = ns_model_EMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M110')%>% select(nllh)
      M_100_EMST = ns_model_EMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M-100')%>% select(nllh)
      M_110_EMST = ns_model_EMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M-110')%>% select(nllh)
      

      if(nrow(M100_GMST)==0){
        df_M100_M000_GMST = data.frame(CMIP_model = CMIP_mod, 
                  station=st, 
                  scenario=sc, 
                  ratio='M100-GMST / M000', 
                  alternative = FALSE , 
                  p_value = 1)
        df_M110_M100_GMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M110-GMST / M100-GMST', 
                          alternative = FALSE , 
                          p_value = 1 )
      }
      else if(nrow(M000_GMST)==0){
        df_M100_M000_GMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M100-GMST / M000', 
                          alternative = FALSE , 
                          p_value = 1)
        if(nrow(M110_GMST)==0){
          df_M110_M100_GMST = data.frame(CMIP_model = CMIP_mod, 
                            station=st, 
                            scenario=sc, 
                            ratio='M110-GMST / M100-GMST', 
                            alternative = FALSE , 
                            p_value = 1 )
        }
        else{
          df_M110_M100_GMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M110-GMST / M100-GMST', 
                          alternative = ifelse(lr.test(M100_GMST$nllh, M110_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                             TRUE, FALSE) , 
                          p_value = lr.test(M100_GMST$nllh, M110_GMST$nllh, alpha = alpha_llh, df=1)$p.value )
        }
      }
      else if(nrow(M110_GMST)==0){
        df_M110_M100_GMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M110-GMST / M100-GMST', 
                          alternative = FALSE , 
                          p_value = 1 )
        if(nrow(M000_GMST==0)){
          df_M100_M000_GMST = data.frame(CMIP_model = CMIP_mod, 
                  station=st, 
                  scenario=sc, 
                  ratio='M100-GMST / M000', 
                  alternative = FALSE , 
                  p_value = 1)
        }
        else{
          df_M100_M000_GMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M100-GMST / M000', 
                          alternative = ifelse(lr.test(M000_GMST$nllh, M100_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                             TRUE, FALSE) , 
                          p_value = lr.test(M000_GMST$nllh, M100_GMST$nllh, alpha = alpha_llh,df=1)$p.value )
        }
      }
      else{
        df_M100_M000_GMST = data.frame(CMIP_model = CMIP_mod, 
                station=st, 
                scenario=sc, 
                ratio='M100-GMST / M000', 
                alternative = ifelse(lr.test(M000_GMST$nllh, M100_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                   TRUE, FALSE) , 
                p_value = lr.test(M000_GMST$nllh, M100_GMST$nllh, alpha = alpha_llh,df=1)$p.value )
        df_M110_M100_GMST = data.frame(CMIP_model = CMIP_mod, 
                station=st, 
                scenario=sc, 
                ratio='M110-GMST / M100-GMST', 
                alternative = ifelse(lr.test(M100_GMST$nllh, M110_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                   TRUE, FALSE) , 
                p_value = lr.test(M100_GMST$nllh, M110_GMST$nllh, alpha = alpha_llh, df=1)$p.value )
      }
      
      if(nrow(M100_EMST)==0){
        df_M100_M000_EMST = data.frame(CMIP_model = CMIP_mod, 
                  station=st, 
                  scenario=sc, 
                  ratio='M100-EMST / M000', 
                  alternative = FALSE , 
                  p_value = 1)
        df_M110_M100_EMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M110-EMST / M100-EMST', 
                          alternative = FALSE , 
                          p_value = 1 )
      }
      else if(nrow(M000_EMST)==0){
        df_M100_M000_EMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M100-EMST / M000', 
                          alternative = FALSE , 
                          p_value = 1)
        if(nrow(M110_EMST)==0){
          df_M110_M100_EMST = data.frame(CMIP_model = CMIP_mod, 
                            station=st, 
                            scenario=sc, 
                            ratio='M110-EMST / M100-EMST', 
                            alternative = FALSE , 
                            p_value = 1 )
        }
        else{
          df_M110_M100_EMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M110-EMST / M100-EMST', 
                          alternative = ifelse(lr.test(M100_EMST$nllh, M110_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                             TRUE, FALSE) , 
                          p_value = lr.test(M100_EMST$nllh, M110_EMST$nllh, alpha = alpha_llh, df=1)$p.value )
        }
      }
      else if(nrow(M110_EMST)==0){
        df_M110_M100_EMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M110-EMST / M100-EMST', 
                          alternative = FALSE , 
                          p_value = 1 )
        if(nrow(M000_EMST==0)){
          df_M100_M000_EMST = data.frame(CMIP_model = CMIP_mod, 
                  station=st, 
                  scenario=sc, 
                  ratio='M100-EMST / M000', 
                  alternative = FALSE , 
                  p_value = 1)
        }
        else{
          df_M100_M000_EMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M100-GMST / M000', 
                          alternative = ifelse(lr.test(M000_EMST$nllh, M100_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                             TRUE, FALSE) , 
                          p_value = lr.test(M000_EMST$nllh, M100_EMST$nllh, alpha = alpha_llh,df=1)$p.value )
        }
      }
      else{
        df_M100_M000_EMST = data.frame(CMIP_model = CMIP_mod, 
                station=st, 
                scenario=sc, 
                ratio='M100-EMST / M000', 
                alternative = ifelse(lr.test(M000_EMST$nllh, M100_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                   TRUE, FALSE) , 
                p_value = lr.test(M000_EMST$nllh, M100_EMST$nllh, alpha = alpha_llh,df=1)$p.value )
        df_M110_M100_EMST = data.frame(CMIP_model = CMIP_mod, 
                station=st, 
                scenario=sc, 
                ratio='M110-EMST / M100-EMST', 
                alternative = ifelse(lr.test(M100_EMST$nllh, M110_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                   TRUE, FALSE) , 
                p_value = lr.test(M100_EMST$nllh, M110_EMST$nllh, alpha = alpha_llh, df=1)$p.value )
      }
      
      if(nrow(M_100_GMST)==0 | nrow(M_110_GMST)==0){
        df_M_110_M_100_GMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M-110-GMST / M-100-GMST', 
                          alternative = FALSE ,  
                          p_value = 1)
      }
      else{
        df_M_110_M_100_GMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M-110-GMST / M-100-GMST', 
                          alternative = ifelse(lr.test(M_100_GMST$nllh, M_110_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                             TRUE, FALSE) ,  
                          p_value = lr.test(M_100_GMST$nllh, M_110_GMST$nllh, alpha = alpha_llh, df=1)$p.value)
      }
      
      if(nrow(M_100_EMST)==0 | nrow(M_110_EMST)==0){
        df_M_110_M_100_EMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M-110-EMST / M-100-EMST', 
                          alternative = FALSE ,  
                          p_value = 1)
      }
      else{
        df_M_110_M_100_EMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M-110-EMST / M-100-EMST', 
                          alternative = ifelse(lr.test(M_100_EMST$nllh, M_110_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                             TRUE, FALSE) ,  
                          p_value = lr.test(M_100_EMST$nllh, M_110_EMST$nllh, alpha = alpha_llh, df=1)$p.value)
      }
      
      ns_model_ratios.gev = rbind(ns_model_ratios.gev, df_M100_M000_GMST)
      ns_model_ratios.gev = rbind(ns_model_ratios.gev, df_M110_M100_GMST)
      ns_model_ratios.gev = rbind(ns_model_ratios.gev, df_M_110_M_100_GMST)
      
      ns_model_ratios.gev = rbind(ns_model_ratios.gev, df_M100_M000_EMST)
      ns_model_ratios.gev = rbind(ns_model_ratios.gev, df_M110_M100_EMST)
      ns_model_ratios.gev = rbind(ns_model_ratios.gev, df_M_110_M_100_EMST)
    }
    # #CMIP
    # M000_GMST = ns_model_CMIP_GMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M000')%>% select(nllh)
    # M100_GMST = ns_model_CMIP_GMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M100')%>% select(nllh)
    # M110_GMST = ns_model_CMIP_GMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M110')%>% select(nllh)
    # M_100_GMST = ns_model_CMIP_GMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M-100')%>% select(nllh)
    # M_110_GMST = ns_model_CMIP_GMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M-110')%>% select(nllh)
    # 
    # M000_EMST = ns_model_CMIP_EMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M000')%>% select(nllh)
    # M100_EMST = ns_model_CMIP_EMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M100')%>% select(nllh)
    # M110_EMST = ns_model_CMIP_EMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M110')%>% select(nllh)
    # M_100_EMST = ns_model_CMIP_EMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M-100')%>% select(nllh)
    # M_110_EMST = ns_model_CMIP_EMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M-110')%>% select(nllh)
    # 
    # df_M100_M000_GMST = data.frame(CMIP_model = CMIP_mod, 
    #                           station='GrandEst', 
    #                           scenario=sc, 
    #                           ratio='M100-GMST / M000', 
    #                           alternative = ifelse(lr.test(M000_GMST$nllh, M100_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
    #                                                TRUE, FALSE) , 
    #                           p_value = lr.test(M000_GMST$nllh, M100_GMST$nllh, alpha = alpha_llh,df=1)$p.value )
    # df_M110_M100_GMST = data.frame(CMIP_model = CMIP_mod, 
    #                           station='GrandEst', 
    #                           scenario=sc, 
    #                           ratio='M110-GMST /M100-GMST', 
    #                           alternative = ifelse(lr.test(M100_GMST$nllh, M110_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
    #                                                TRUE, FALSE) , 
    #                           p_value = lr.test(M100_GMST$nllh, M110_GMST$nllh, alpha = alpha_llh,df=1)$p.value )
    # df_M_110_M_100_GMST = data.frame(CMIP_model = CMIP_mod, 
    #                           station='GrandEst', 
    #                           scenario=sc, 
    #                           ratio='M-110-GMST /M-100-GMST', 
    #                           alternative = ifelse(lr.test(M_100_GMST$nllh, M_110_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
    #                                                TRUE, FALSE) , 
    #                           p_value = lr.test(M_100_GMST$nllh, M_110_GMST$nllh, alpha = alpha_llh,df=1)$p.value )
    # 
    # df_M100_M000_EMST = data.frame(CMIP_model = CMIP_mod, 
    #                           station='GrandEst', 
    #                           scenario=sc, 
    #                           ratio='M100-EMST / M000', 
    #                           alternative = ifelse(lr.test(M000_EMST$nllh, M100_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
    #                                                TRUE, FALSE) , 
    #                           p_value = lr.test(M000_EMST$nllh, M100_EMST$nllh, alpha = alpha_llh,df=1)$p.value )
    # df_M110_M100_EMST = data.frame(CMIP_model = CMIP_mod, 
    #                           station='GrandEst', 
    #                           scenario=sc, 
    #                           ratio='M110-EMST / M100-EMST', 
    #                           alternative = ifelse(lr.test(M100_EMST$nllh, M110_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
    #                                                TRUE, FALSE) , 
    #                           p_value = lr.test(M100_EMST$nllh, M110_EMST$nllh,alpha = alpha_llh, df=1)$p.value)
    # df_M_110_M_100_EMST = data.frame(CMIP_model = CMIP_mod, 
    #                           station='GrandEst', 
    #                           scenario=sc, 
    #                           ratio='M-110-EMST / M-100-EMST', 
    #                           alternative = ifelse(lr.test(M_100_EMST$nllh, M_110_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
    #                                                TRUE, FALSE) , 
    #                           p_value = lr.test(M_100_EMST$nllh, M_110_EMST$nllh,alpha = alpha_llh, df=1)$p.value)
    # 
    # ns_model_ratios_CMIP.gev = rbind(ns_model_ratios_CMIP.gev, df_M100_M000_GMST)
    # ns_model_ratios_CMIP.gev = rbind(ns_model_ratios_CMIP.gev, df_M110_M100_GMST)
    # ns_model_ratios_CMIP.gev = rbind(ns_model_ratios_CMIP.gev, df_M_110_M_100_GMST)
    # ns_model_ratios_CMIP.gev = rbind(ns_model_ratios_CMIP.gev, df_M100_M000_EMST)
    # ns_model_ratios_CMIP.gev = rbind(ns_model_ratios_CMIP.gev, df_M110_M100_EMST)
    # ns_model_ratios_CMIP.gev = rbind(ns_model_ratios_CMIP.gev, df_M_110_M_100_EMST)
  }
}
```

```{r, TASMIN, Compute likelihood ratio test for adjusted data}
ns_model_ratios.tasmin.gev = data.frame(matrix(ncol = 6, nrow = 0))
colnames(ns_model_ratios.tasmin.gev) = c('CMIP_model', 'station', 'scenario', 'ratio', 'alternative', 'p_value')

#ns_model_ratios_CMIP.gev = data.frame(matrix(ncol = 6, nrow = 0))
#colnames(ns_model_ratios_CMIP.gev) = c('CMIP_model', 'station', 'scenario', 'ratio', 'alternative', 'p_value')

for(CMIP_mod in models){
  for(st in stations){
    scenarios_loop = unique(ns_model_tasmin_GMST.gev.params %>% filter(CMIP_model==CMIP_mod, station==st) %>% select(scenario))
    for(sc in scenarios_loop[[1]]){
      M000_GMST = ns_model_tasmin_GMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M000')%>% select(nllh)
      M100_GMST = ns_model_tasmin_GMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M100')%>% select(nllh)
      M110_GMST = ns_model_tasmin_GMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M110')%>% select(nllh)
      M_100_GMST = ns_model_tasmin_GMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M-100')%>% select(nllh)
      M_110_GMST = ns_model_tasmin_GMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M-110')%>% select(nllh)
      
      M000_EMST = ns_model_tasmin_EMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M000')%>% select(nllh)
      M100_EMST = ns_model_tasmin_EMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M100')%>% select(nllh)
      M110_EMST = ns_model_tasmin_EMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M110')%>% select(nllh)
      M_100_EMST = ns_model_tasmin_EMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M-100')%>% select(nllh)
      M_110_EMST = ns_model_tasmin_EMST.gev.params%>%filter(CMIP_model==CMIP_mod, station==st, scenario==sc, ns_model=='M-110')%>% select(nllh)
      

      if(nrow(M100_GMST)==0){
        df_M100_M000_GMST = data.frame(CMIP_model = CMIP_mod, 
                  station=st, 
                  scenario=sc, 
                  ratio='M100-GMST / M000', 
                  alternative = FALSE , 
                  p_value = 1)
        df_M110_M100_GMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M110-GMST / M100-GMST', 
                          alternative = FALSE , 
                          p_value = 1 )
      }
      else if(nrow(M000_GMST)==0){
        df_M100_M000_GMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M100-GMST / M000', 
                          alternative = FALSE , 
                          p_value = 1)
        if(nrow(M110_GMST)==0){
          df_M110_M100_GMST = data.frame(CMIP_model = CMIP_mod, 
                            station=st, 
                            scenario=sc, 
                            ratio='M110-GMST / M100-GMST', 
                            alternative = FALSE , 
                            p_value = 1 )
        }
        else{
          df_M110_M100_GMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M110-GMST / M100-GMST', 
                          alternative = ifelse(lr.test(M100_GMST$nllh, M110_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                             TRUE, FALSE) , 
                          p_value = lr.test(M100_GMST$nllh, M110_GMST$nllh, alpha = alpha_llh, df=1)$p.value )
        }
      }
      else if(nrow(M110_GMST)==0){
        df_M110_M100_GMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M110-GMST / M100-GMST', 
                          alternative = FALSE , 
                          p_value = 1 )
        if(nrow(M000_GMST==0)){
          df_M100_M000_GMST = data.frame(CMIP_model = CMIP_mod, 
                  station=st, 
                  scenario=sc, 
                  ratio='M100-GMST / M000', 
                  alternative = FALSE , 
                  p_value = 1)
        }
        else{
          df_M100_M000_GMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M100-GMST / M000', 
                          alternative = ifelse(lr.test(M000_GMST$nllh, M100_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                             TRUE, FALSE) , 
                          p_value = lr.test(M000_GMST$nllh, M100_GMST$nllh, alpha = alpha_llh,df=1)$p.value )
        }
      }
      else{
        df_M100_M000_GMST = data.frame(CMIP_model = CMIP_mod, 
                station=st, 
                scenario=sc, 
                ratio='M100-GMST / M000', 
                alternative = ifelse(lr.test(M000_GMST$nllh, M100_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                   TRUE, FALSE) , 
                p_value = lr.test(M000_GMST$nllh, M100_GMST$nllh, alpha = alpha_llh,df=1)$p.value )
        df_M110_M100_GMST = data.frame(CMIP_model = CMIP_mod, 
                station=st, 
                scenario=sc, 
                ratio='M110-GMST / M100-GMST', 
                alternative = ifelse(lr.test(M100_GMST$nllh, M110_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                   TRUE, FALSE) , 
                p_value = lr.test(M100_GMST$nllh, M110_GMST$nllh, alpha = alpha_llh, df=1)$p.value )
      }
      
      if(nrow(M100_EMST)==0){
        df_M100_M000_EMST = data.frame(CMIP_model = CMIP_mod, 
                  station=st, 
                  scenario=sc, 
                  ratio='M100-EMST / M000', 
                  alternative = FALSE , 
                  p_value = 1)
        df_M110_M100_EMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M110-EMST / M100-EMST', 
                          alternative = FALSE , 
                          p_value = 1 )
      }
      else if(nrow(M000_EMST)==0){
        df_M100_M000_EMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M100-EMST / M000', 
                          alternative = FALSE , 
                          p_value = 1)
        if(nrow(M110_EMST)==0){
          df_M110_M100_EMST = data.frame(CMIP_model = CMIP_mod, 
                            station=st, 
                            scenario=sc, 
                            ratio='M110-EMST / M100-EMST', 
                            alternative = FALSE , 
                            p_value = 1 )
        }
        else{
          df_M110_M100_EMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M110-EMST / M100-EMST', 
                          alternative = ifelse(lr.test(M100_EMST$nllh, M110_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                             TRUE, FALSE) , 
                          p_value = lr.test(M100_EMST$nllh, M110_EMST$nllh, alpha = alpha_llh, df=1)$p.value )
        }
      }
      else if(nrow(M110_EMST)==0){
        df_M110_M100_EMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M110-EMST / M100-EMST', 
                          alternative = FALSE , 
                          p_value = 1 )
        if(nrow(M000_EMST==0)){
          df_M100_M000_EMST = data.frame(CMIP_model = CMIP_mod, 
                  station=st, 
                  scenario=sc, 
                  ratio='M100-EMST / M000', 
                  alternative = FALSE , 
                  p_value = 1)
        }
        else{
          df_M100_M000_EMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M100-GMST / M000', 
                          alternative = ifelse(lr.test(M000_EMST$nllh, M100_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                             TRUE, FALSE) , 
                          p_value = lr.test(M000_EMST$nllh, M100_EMST$nllh, alpha = alpha_llh,df=1)$p.value )
        }
      }
      else{
        df_M100_M000_EMST = data.frame(CMIP_model = CMIP_mod, 
                station=st, 
                scenario=sc, 
                ratio='M100-EMST / M000', 
                alternative = ifelse(lr.test(M000_EMST$nllh, M100_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                   TRUE, FALSE) , 
                p_value = lr.test(M000_EMST$nllh, M100_EMST$nllh, alpha = alpha_llh,df=1)$p.value )
        df_M110_M100_EMST = data.frame(CMIP_model = CMIP_mod, 
                station=st, 
                scenario=sc, 
                ratio='M110-EMST / M100-EMST', 
                alternative = ifelse(lr.test(M100_EMST$nllh, M110_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                   TRUE, FALSE) , 
                p_value = lr.test(M100_EMST$nllh, M110_EMST$nllh, alpha = alpha_llh, df=1)$p.value )
      }
      
      if(nrow(M_100_GMST)==0 | nrow(M_110_GMST)==0){
        df_M_110_M_100_GMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M-110-GMST / M-100-GMST', 
                          alternative = FALSE ,  
                          p_value = 1)
      }
      else{
        df_M_110_M_100_GMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M-110-GMST / M-100-GMST', 
                          alternative = ifelse(lr.test(M_100_GMST$nllh, M_110_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                             TRUE, FALSE) ,  
                          p_value = lr.test(M_100_GMST$nllh, M_110_GMST$nllh, alpha = alpha_llh, df=1)$p.value)
      }
      
      if(nrow(M_100_EMST)==0 | nrow(M_110_EMST)==0){
        df_M_110_M_100_EMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M-110-EMST / M-100-EMST', 
                          alternative = FALSE ,  
                          p_value = 1)
      }
      else{
        df_M_110_M_100_EMST = data.frame(CMIP_model = CMIP_mod, 
                          station=st, 
                          scenario=sc, 
                          ratio='M-110-EMST / M-100-EMST', 
                          alternative = ifelse(lr.test(M_100_EMST$nllh, M_110_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
                                             TRUE, FALSE) ,  
                          p_value = lr.test(M_100_EMST$nllh, M_110_EMST$nllh, alpha = alpha_llh, df=1)$p.value)
      }
      
      ns_model_ratios.tasmin.gev = rbind(ns_model_ratios.tasmin.gev, df_M100_M000_GMST)
      ns_model_ratios.tasmin.gev = rbind(ns_model_ratios.tasmin.gev, df_M110_M100_GMST)
      ns_model_ratios.tasmin.gev = rbind(ns_model_ratios.tasmin.gev, df_M_110_M_100_GMST)
      
      ns_model_ratios.tasmin.gev = rbind(ns_model_ratios.tasmin.gev, df_M100_M000_EMST)
      ns_model_ratios.tasmin.gev = rbind(ns_model_ratios.tasmin.gev, df_M110_M100_EMST)
      ns_model_ratios.tasmin.gev = rbind(ns_model_ratios.tasmin.gev, df_M_110_M_100_EMST)
    }
    # #CMIP
    # M000_GMST = ns_model_CMIP_GMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M000')%>% select(nllh)
    # M100_GMST = ns_model_CMIP_GMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M100')%>% select(nllh)
    # M110_GMST = ns_model_CMIP_GMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M110')%>% select(nllh)
    # M_100_GMST = ns_model_CMIP_GMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M-100')%>% select(nllh)
    # M_110_GMST = ns_model_CMIP_GMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M-110')%>% select(nllh)
    # 
    # M000_EMST = ns_model_CMIP_EMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M000')%>% select(nllh)
    # M100_EMST = ns_model_CMIP_EMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M100')%>% select(nllh)
    # M110_EMST = ns_model_CMIP_EMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M110')%>% select(nllh)
    # M_100_EMST = ns_model_CMIP_EMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M-100')%>% select(nllh)
    # M_110_EMST = ns_model_CMIP_EMST.gev%>%filter(CMIP_model==CMIP_mod, station=='GrandEst', scenario==sc, ns_model=='M-110')%>% select(nllh)
    # 
    # df_M100_M000_GMST = data.frame(CMIP_model = CMIP_mod, 
    #                           station='GrandEst', 
    #                           scenario=sc, 
    #                           ratio='M100-GMST / M000', 
    #                           alternative = ifelse(lr.test(M000_GMST$nllh, M100_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
    #                                                TRUE, FALSE) , 
    #                           p_value = lr.test(M000_GMST$nllh, M100_GMST$nllh, alpha = alpha_llh,df=1)$p.value )
    # df_M110_M100_GMST = data.frame(CMIP_model = CMIP_mod, 
    #                           station='GrandEst', 
    #                           scenario=sc, 
    #                           ratio='M110-GMST /M100-GMST', 
    #                           alternative = ifelse(lr.test(M100_GMST$nllh, M110_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
    #                                                TRUE, FALSE) , 
    #                           p_value = lr.test(M100_GMST$nllh, M110_GMST$nllh, alpha = alpha_llh,df=1)$p.value )
    # df_M_110_M_100_GMST = data.frame(CMIP_model = CMIP_mod, 
    #                           station='GrandEst', 
    #                           scenario=sc, 
    #                           ratio='M-110-GMST /M-100-GMST', 
    #                           alternative = ifelse(lr.test(M_100_GMST$nllh, M_110_GMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
    #                                                TRUE, FALSE) , 
    #                           p_value = lr.test(M_100_GMST$nllh, M_110_GMST$nllh, alpha = alpha_llh,df=1)$p.value )
    # 
    # df_M100_M000_EMST = data.frame(CMIP_model = CMIP_mod, 
    #                           station='GrandEst', 
    #                           scenario=sc, 
    #                           ratio='M100-EMST / M000', 
    #                           alternative = ifelse(lr.test(M000_EMST$nllh, M100_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
    #                                                TRUE, FALSE) , 
    #                           p_value = lr.test(M000_EMST$nllh, M100_EMST$nllh, alpha = alpha_llh,df=1)$p.value )
    # df_M110_M100_EMST = data.frame(CMIP_model = CMIP_mod, 
    #                           station='GrandEst', 
    #                           scenario=sc, 
    #                           ratio='M110-EMST / M100-EMST', 
    #                           alternative = ifelse(lr.test(M100_EMST$nllh, M110_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
    #                                                TRUE, FALSE) , 
    #                           p_value = lr.test(M100_EMST$nllh, M110_EMST$nllh,alpha = alpha_llh, df=1)$p.value)
    # df_M_110_M_100_EMST = data.frame(CMIP_model = CMIP_mod, 
    #                           station='GrandEst', 
    #                           scenario=sc, 
    #                           ratio='M-110-EMST / M-100-EMST', 
    #                           alternative = ifelse(lr.test(M_100_EMST$nllh, M_110_EMST$nllh, alpha = alpha_llh,df=1)$p.value<alpha_llh, 
    #                                                TRUE, FALSE) , 
    #                           p_value = lr.test(M_100_EMST$nllh, M_110_EMST$nllh,alpha = alpha_llh, df=1)$p.value)
    # 
    # ns_model_ratios_CMIP.gev = rbind(ns_model_ratios_CMIP.gev, df_M100_M000_GMST)
    # ns_model_ratios_CMIP.gev = rbind(ns_model_ratios_CMIP.gev, df_M110_M100_GMST)
    # ns_model_ratios_CMIP.gev = rbind(ns_model_ratios_CMIP.gev, df_M_110_M_100_GMST)
    # ns_model_ratios_CMIP.gev = rbind(ns_model_ratios_CMIP.gev, df_M100_M000_EMST)
    # ns_model_ratios_CMIP.gev = rbind(ns_model_ratios_CMIP.gev, df_M110_M100_EMST)
    # ns_model_ratios_CMIP.gev = rbind(ns_model_ratios_CMIP.gev, df_M_110_M_100_EMST)
  }
}
```

```{r, Compute nb of scenario that passed the test}
ns_model_ratios_sum.gev = data.frame(matrix(ncol = ncol(ns_model_ratios.gev)+1, nrow=0))
colnames(ns_model_ratios_sum.gev) = append(colnames(ns_model_ratios.gev), c('sum_passed'))
ratios = unique(ns_model_ratios.gev$ratio)

for(CMIP_mod in models){
  for(st in stations){
    for(rat in ratios){
      row_loop = ns_model_ratios.gev %>% filter(station==st, CMIP_model==CMIP_mod, ratio==rat)
      if(nrow(row_loop) !=0){
        sum_loop = nrow(row_loop[row_loop$alternative == 'TRUE',])
        sum_sc = nrow(row_loop) - nrow(row_loop %>% filter(alternative=='FALSE' & p_value==1))
        if(sum_sc==0){row_loop$sum_passed = NaN}
        else{row_loop$sum_passed = sum_loop/sum_sc}
      }
      ns_model_ratios_sum.gev = rbind(ns_model_ratios_sum.gev, row_loop)
    }
  }
}

# ns_model_ratios_sum_CMIP.gev = data.frame(matrix(ncol = ncol(ns_model_ratios_CMIP.gev)+1, nrow=0))
# colnames(ns_model_ratios_sum_CMIP.gev) = append(colnames(ns_model_ratios_CMIP.gev), c('sum_passed'))
# ratios = unique(ns_model_ratios_CMIP.gev$ratio)
# 
# for(CMIP_mod in models){
#   for(rat in ratios){
#     row_loop = ns_model_ratios_CMIP.gev %>% filter(station=='GrandEst', CMIP_model==CMIP_mod, ratio==rat)
#     sum_loop = nrow(row_loop[row_loop$alternative == 'TRUE',])
#     sum_sc = nrow(row_loop[row_loop$alternative == 'TRUE',]) - nrow(row_loop[row_loop$p_value == 1,])
#     row_loop$sum_passed = sum_loop/sum_sc
#     ns_model_ratios_sum_CMIP.gev = rbind(ns_model_ratios_sum_CMIP.gev, row_loop)
#   }
# }
```

```{r,TASMIN, Compute nb of scenario that passed the test}
ns_model_ratios_sum.tasmin.gev = data.frame(matrix(ncol = ncol(ns_model_ratios.tasmin.gev)+1, nrow=0))
colnames(ns_model_ratios_sum.tasmin.gev) = append(colnames(ns_model_ratios.tasmin.gev), c('sum_passed'))
ratios = unique(ns_model_ratios.tasmin.gev$ratio)

for(CMIP_mod in models){
  for(st in stations){
    for(rat in ratios){
      row_loop = ns_model_ratios.tasmin.gev %>% filter(station==st, CMIP_model==CMIP_mod, ratio==rat)
      if(nrow(row_loop) !=0){
        sum_loop = nrow(row_loop[row_loop$alternative == 'TRUE',])
        sum_sc = nrow(row_loop) - nrow(row_loop %>% filter(alternative=='FALSE' & p_value==1))
        if(sum_sc==0){row_loop$sum_passed = NaN}
        else{row_loop$sum_passed = sum_loop/sum_sc}
      }
      ns_model_ratios_sum.tasmin.gev = rbind(ns_model_ratios_sum.tasmin.gev, row_loop)
    }
  }
}

# ns_model_ratios_sum_CMIP.gev = data.frame(matrix(ncol = ncol(ns_model_ratios_CMIP.gev)+1, nrow=0))
# colnames(ns_model_ratios_sum_CMIP.gev) = append(colnames(ns_model_ratios_CMIP.gev), c('sum_passed'))
# ratios = unique(ns_model_ratios_CMIP.gev$ratio)
# 
# for(CMIP_mod in models){
#   for(rat in ratios){
#     row_loop = ns_model_ratios_CMIP.gev %>% filter(station=='GrandEst', CMIP_model==CMIP_mod, ratio==rat)
#     sum_loop = nrow(row_loop[row_loop$alternative == 'TRUE',])
#     sum_sc = nrow(row_loop[row_loop$alternative == 'TRUE',]) - nrow(row_loop[row_loop$p_value == 1,])
#     row_loop$sum_passed = sum_loop/sum_sc
#     ns_model_ratios_sum_CMIP.gev = rbind(ns_model_ratios_sum_CMIP.gev, row_loop)
#   }
# }
```

```{r, Plot Likelihood ratio test per station}
colour_breaks = c(0,0.1,1)
colours = c('#1b7837', 'blue', 'red')

for(sc in 'ssp370'){
#for(st in stations){
  p = ggplot() +
    geom_point(aes(x=CMIP_model, y=ratio, color=p_value), size=6, data = ns_model_ratios.gev %>% filter(scenario==sc)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
    #scale_color_manual(values = c("0"= "#d73027", "1" ="#fc8d59","2"= "#fee08b","3"= "#d9ef8b","4"= "#91cf60","5"= "#1a9850")) +
    scale_colour_gradientn(limits = range(ns_model_ratios.gev$p_value),  
                      colours = colours[c(1, seq_along(colours), length(colours))] ,
                      values = c(0, scales::rescale(colour_breaks, from = range(ns_model_ratios.gev$p_value)), 1)) +
    facet_grid(rows=vars(station)) +
    labs(y = 'Likelihood ratio', 
         color = 'p-value', 
         title=paste("Likelihood ratio test-", sc, "Adjust- Alpha=",alpha_llh))
  #ggsave(paste(fig_path,"llh_ratio_test_pvalue_", sc, "adjust_alpha_", alpha_llh, "_exp_sigma.png", sep=""), width=8, height=5)
  plot(p)
}
```

```{r, Plot Likelihood ratio test per station, Adjusted data}
#for(st in stations){
st = 'Cirfontaines'
  p = ggplot() +
    geom_point(aes(x=CMIP_model, y=ratio, color=sum_passed), size=6, data = ns_model_ratios_sum.tasmin.gev %>% filter(station==st)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
    scale_color_gradientn(colours = c("#d73027","#fc8d59", "#fee08b", "#d9ef8b","#91cf60","#1a9850"), values=c(0,0.2,0.4,0.6,0.8,1)) +
    labs(y = 'Likelihood ratio', 
         color = 'Percentage of scenarios passing the test', 
         title=paste("Likelihood ratio test-Adjust- Alpha=",alpha_llh, "-", st))
    #facet_wrap(~station)
  #ggsave(paste(fig_path,"llh_ratio_test_",st,"_adjust_alpha_", alpha_llh, "_exp_sigma.png", sep=""), width=9, height=5)
  plot(p)
#}
```

```{r, TASMIN, Plot Likelihood ratio test per station, Adjusted data}
#for(st in stations){
st = 'Bure'
  p = ggplot() +
    geom_point(aes(x=CMIP_model, y=ratio, color=sum_passed), size=6, data = ns_model_ratios_sum.tasmin.gev %>% filter(station==st)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
    scale_color_gradientn(colours = c("#d73027","#fc8d59", "#fee08b", "#d9ef8b","#91cf60","#1a9850"), values=c(0,0.2,0.4,0.6,0.8,1)) +
    labs(y = 'Likelihood ratio', 
         color = 'Percentage of scenarios passing the test', 
         title=paste("Likelihood ratio test-Adjust- Alpha=",alpha_llh, "-", st))
    #facet_wrap(~station)
  ggsave(paste(fig_path,"tasmin_llh_ratio_test_",st,"_adjust_alpha_", alpha_llh, "_exp_sigma.png", sep=""), width=9, height=5)
  plot(p)
#}
```

```{r, Plot Likelihood ratio test per station, CMIP original data}
p = ggplot() +
  geom_point(aes(x=CMIP_model, y=ratio, color=as.factor(sum_passed)), size=6, data = ns_model_ratios_sum_CMIP.gev) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
    scale_color_manual(values = c("0"= "#d73027", "1" ="#fc8d59","2"= "#fee08b","3"= "#d9ef8b","4"= "#91cf60","5"= "#1a9850")) +
  labs(y = 'Likelihood ratio', 
       color = 'Nb scenarios passing the test', 
       title=paste("Likelihood ratio test-GrandEst-CMIP- Alpha=",alpha_llh))
ggsave(paste(fig_path,"llh_ratio_test_GrandEst_CMIP_alpha_", alpha_llh, "_exp_sigma.png", sep=""), width=8, height=5)
plot(p)
```

```{r, Compute nb of model that passed the test}
ns_model_ratios_sum_mod.gev = data.frame(matrix(ncol = ncol(ns_model_ratios.gev)+1, nrow=0))
colnames(ns_model_ratios_sum_mod.gev) = append(colnames(ns_model_ratios.gev), c('sum_passed'))
ratios = unique(ns_model_ratios.gev$ratio)

for(sc in scenarios){
  for(st in stations){
    for(rat in ratios){
      row_loop = ns_model_ratios.gev %>% filter(station==st, scenario==sc, ratio==rat)
      sum_loop = length(row_loop[row_loop$alternative == 'greater',])
      row_loop$sum_TRUE = sum_loop
      ns_model_ratios_sum_mod.gev = rbind(ns_model_ratios_sum.gev, row_loop)
    }
  }
}

ns_model_ratios_sum_mod_CMIP.gev = data.frame(matrix(ncol = ncol(ns_model_ratios_CMIP.gev)+1, nrow=0))
colnames(ns_model_ratios_sum_mod_CMIP.gev) = append(colnames(ns_model_ratios_CMIP.gev), c('sum_passed'))
ratios = unique(ns_model_ratios_CMIP.gev$ratio)

for(sc in scenarios){
  for(rat in ratios){
    row_loop = ns_model_ratios_CMIP.gev %>% filter(station=='GrandEst', scenario==sc, ratio==rat)
    sum_loop = length(row_loop[row_loop$alternative == 'greater',])
    row_loop$sum_TRUE = sum_loop
    ns_model_ratios_sum_mod_CMIP.gev = rbind(ns_model_ratios_sum_mod_CMIP.gev, row_loop)
  }
}
```

```{r, Plot Likelihood ratio test per station}
for(st in stations){
  p = ggplot() +
    geom_point(aes(x=scenario, y=ratio, color=as.factor(sum_TRUE)), size=6, data = ns_model_ratios_sum_mod.gev %>% filter(station==st)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
    scale_color_manual(values = c("0"="#d73027","1"= "#f46d43","2"= "#fdae61","3"= "#fee08b","4"= "#d9ef8b","5"= "#a6d96a","6"= "#66bd63","7"= "#1a9850"))
    labs(y = 'Likelihood ratio', 
         color = 'Nb CMIP models passing the test', 
         title=paste("Likelihood ratio test-", st, "Adjust- Alpha=",alpha_llh))
  #ggsave(paste(fig_path,"llh_ratio_test_mod_sum_", st, "adjust_alpha_", alpha_llh, ".png", sep=""), width=8, height=5)
  plot(p)
}
```

```{r, Plot Likelihood ratio test per station}
p = ggplot() +
  geom_point(aes(x=scenario, y=ratio, color=as.factor(sum_TRUE)), size=6, data = ns_model_ratios_sum_mod_CMIP.gev) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
  scale_color_manual(values = c("0"="#d73027","1"= "#f46d43","2"= "#fdae61","3"= "#fee08b","4"= "#d9ef8b","5"= "#a6d96a","6"= "#66bd63","7"= "#1a9850")) +
  labs(y = 'Likelihood ratio', 
       color = 'Nb scenarios passing the test', 
       title=paste("Likelihood ratio test-GrandEst-CMIP- Alpha=",alpha_llh))
#ggsave(paste(fig_path,"llh_ratio_test_mod_sum_GrandEst_CMIP_alpha_", alpha_llh, ".png", sep=""), width=8, height=5)
plot(p)
```

###Plot of data + fit 

```{r, Tasmax, GEV regression}
#Original GEV computation
ns_model_GMST.evol = gev_regression(ns_model_GMST.gev.params, TX_adjust_stations_GMST)
ns_model_EMST.evol = gev_regression(ns_model_EMST.gev.params, TX_adjust_stations_EMST)

ns_model_CMIP_GMST.evol = gev_regression(ns_model_CMIP_GMST.gev.params, TX_CMIP_GE_GMST)
ns_model_CMIP_EMST.evol = gev_regression(ns_model_CMIP_EMST.gev.params, TX_CMIP_GE_EMST)

ns_model_CDFt_GMST.evol = gev_regression(ns_model_CDFt_GMST.gev.params, TX_adjust_CDFt_stations_GMST)
ns_model_CDFt_EMST.evol = gev_regression(ns_model_CDFt_EMST.gev.params, TX_adjust_CDFt_stations_EMST)

#Computation without max
ns_model_GMST_no_max.evol = gev_regression(ns_model_GMST_no_max.gev.params, TX_adjust_stations_GMST)
ns_model_EMST_no_max.evol = gev_regression(ns_model_EMST_no_max.gev.params, TX_adjust_stations_EMST)

ns_model_CDFt_GMST_no_max.evol = gev_regression(ns_model_CDFt_GMST_no_max.gev.params, TX_adjust_CDFt_stations_GMST)
ns_model_CDFt_EMST_no_max.evol = gev_regression(ns_model_CDFt_EMST_no_max.gev.params, TX_adjust_CDFt_stations_EMST)
```

```{r, TASMIN, Compute the GEV regression}
ns_model_GMST.tasmin.evol = data.frame(matrix(nrow=0, ncol=17))
colnames(ns_model_GMST.tasmin.evol) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')

ns_model_EMST.tasmin.evol = data.frame(matrix(nrow=0, ncol=17))
colnames(ns_model_EMST.tasmin.evol) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')

for(CMIP_mod in models){
  for(st in stations){
    scenarios_loop = unique(ns_model_tasmin_GMST.gev.params %>% filter(CMIP_model==CMIP_mod, station==st) %>% select(scenario))
    scenarios_loop = scenarios_loop[scenarios_loop!= 'historical']
    for(sc in scenarios_loop){
      ns_models_loop = unique(ns_model_tasmin_GMST.gev.params %>% filter(CMIP_model==CMIP_mod, station==st, scenario==sc) %>% select(ns_model))
      for(ns_mod in ns_models_loop[[1]]){
      #GMST
      years_loop = unique(TN_adjust_stations_GMST %>%
                            filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>%
                            select(year))
      cov_loop = TN_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>% select(covariate)
      ns_model_loop = ns_model_tasmin_GMST.gev.params %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model==ns_mod)
      
      if(length(ns_model_loop$shape)==0){
        #ns_model_GMST_final.gev = subset(ns_model_GMST_final.gev, CMIP_model!=CMIP_mod | scenario!=sc| station != st | ns_model !=ns_mod)
      }
      else if(is.na(ns_model_loop$shape) | ns_model_loop$shape >0 ){
        #ns_model_GMST_final.gev = subset(ns_model_GMST_final.gev, CMIP_model!=CMIP_mod | scenario!=sc| station != st | ns_model !=ns_mod)
      }
      else{
        if(ns_mod %in% c('M000', 'M100', 'M-100')){      
          df_loop_GMST = data.frame(year = years_loop,
                                station=st,
                                scenario=sc,
                                CMIP_model = CMIP_mod,
                                ns_model=ns_mod,
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop +
                                  ns_model_loop$a*cov_loop + ns_model_loop$b,
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop +
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std),
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop +
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std),
                                scale = ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop,
                                scale_low = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop,
                                scale_high = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop,
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low,
                                shape_high = ns_model_loop$shape_high,
                                upper_bound = 0,
                                upper_bound_low = 0,
                                upper_bound_high = 0)}
        else{df_loop_GMST = data.frame(year = years_loop,
                                station=st,
                                scenario=sc,
                                CMIP_model = CMIP_mod,
                                ns_model=ns_mod,
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop +
                                  ns_model_loop$a*cov_loop + ns_model_loop$b,
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop +
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std),
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop +
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std),
                                scale = exp(ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop),
                                scale_low = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop),
                                scale_high = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop),
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low,
                                shape_high = ns_model_loop$shape_high,
                                upper_bound = 0,
                                upper_bound_low = 0,
                                upper_bound_high = 0)
        }
      colnames(df_loop_GMST) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')
      
      upper_bound_loop = df_loop_GMST$loc - df_loop_GMST$scale/df_loop_GMST$shape
      upper_bound_low_loop = df_loop_GMST$loc_low - df_loop_GMST$scale_high/df_loop_GMST$shape_low
      
      if(df_loop_GMST$shape_high<0){
        upper_bound_high_loop = df_loop_GMST$loc_high - df_loop_GMST$scale_low/df_loop_GMST$shape_high
      }
      else{
        upper_bound_high_loop = max(upper_bound_loop) + 100
      }
      
      df_loop_GMST = df_loop_GMST%>% mutate(upper_bound = upper_bound_loop,
                                            upper_bound_low = upper_bound_low_loop,
                                            upper_bound_high = upper_bound_high_loop)

      ns_model_GMST.tasmin.evol = rbind(ns_model_GMST.tasmin.evol, df_loop_GMST)
      }
      }
    }
  }
}

for(CMIP_mod in models){
  for(st in stations){
    scenarios_loop = unique(ns_model_tasmin_EMST.gev.params %>% filter(CMIP_model==CMIP_mod, station==st) %>% select(scenario))
    scenarios_loop = scenarios_loop[scenarios_loop!= 'historical']
    for(sc in scenarios_loop){
      ns_models_loop = unique(ns_model_tasmin_EMST.gev.params %>% filter(CMIP_model==CMIP_mod, station==st, scenario==sc) %>% select(ns_model))
      for(ns_mod in ns_models_loop[[1]]){
      #GMST
      years_loop = unique(TN_adjust_stations_EMST %>%
                            filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>%
                            select(year))
      cov_loop = TN_adjust_stations_EMST %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>% select(covariate)
      ns_model_loop = ns_model_tasmin_EMST.gev.params %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model==ns_mod)
      
      if(length(ns_model_loop$shape)==0){
        #ns_model_GMST_final.gev = subset(ns_model_GMST_final.gev, CMIP_model!=CMIP_mod | scenario!=sc| station != st | ns_model !=ns_mod)
      }
      else if(is.na(ns_model_loop$shape) | ns_model_loop$shape >0 ){
        #ns_model_GMST_final.gev = subset(ns_model_GMST_final.gev, CMIP_model!=CMIP_mod | scenario!=sc| station != st | ns_model !=ns_mod)
      }
      else{
        if(ns_mod %in% c('M000', 'M100', 'M-100')){      
          df_loop_EMST = data.frame(year = years_loop,
                                station=st,
                                scenario=sc,
                                CMIP_model = CMIP_mod,
                                ns_model=ns_mod,
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop +
                                  ns_model_loop$a*cov_loop + ns_model_loop$b,
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop +
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std),
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop +
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std),
                                scale = ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop,
                                scale_low = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop,
                                scale_high = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop,
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low,
                                shape_high = ns_model_loop$shape_high,
                                upper_bound = 0,
                                upper_bound_low = 0,
                                upper_bound_high = 0)}
        else{df_loop_EMST = data.frame(year = years_loop,
                                station=st,
                                scenario=sc,
                                CMIP_model = CMIP_mod,
                                ns_model=ns_mod,
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop +
                                  ns_model_loop$a*cov_loop + ns_model_loop$b,
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop +
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std),
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop +
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std),
                                scale = exp(ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop),
                                scale_low = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop),
                                scale_high = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop),
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low,
                                shape_high = ns_model_loop$shape_high,
                                upper_bound = 0,
                                upper_bound_low = 0,
                                upper_bound_high = 0)
        }
      colnames(df_loop_EMST) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')
      
      upper_bound_loop = df_loop_EMST$loc - df_loop_EMST$scale/df_loop_EMST$shape
      upper_bound_low_loop = df_loop_EMST$loc_low - df_loop_EMST$scale_high/df_loop_EMST$shape_low
      
      if(df_loop_EMST$shape_high<0){
        upper_bound_high_loop = df_loop_EMST$loc_high - df_loop_EMST$scale_low/df_loop_EMST$shape_high
      }
      else{
        upper_bound_high_loop = max(upper_bound_loop) + 100
      }
      
      df_loop_EMST = df_loop_EMST%>% mutate(upper_bound = upper_bound_loop,
                                            upper_bound_low = upper_bound_low_loop,
                                            upper_bound_high = upper_bound_high_loop)

      ns_model_EMST.tasmin.evol = rbind(ns_model_EMST.tasmin.evol, df_loop_EMST)
      }
      }
    }
  }
}
```

```{r, TASMIN, Compute the GEV regression with no max}
ns_model_GMST_no_max.tasmin.evol = data.frame(matrix(nrow=0, ncol=17))
colnames(ns_model_GMST_no_max.tasmin.evol) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')

ns_model_EMST_no_max.tasmin.evol = data.frame(matrix(nrow=0, ncol=17))
colnames(ns_model_EMST_no_max.tasmin.evol) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')

#ns_model_GMST_no_max_final.gev = data.frame(ns_model_GMST_no_max.gev.params)
#ns_model_EMST_no_max_final.gev = data.frame(ns_model_EMST_no_max.gev.params)

for(CMIP_mod in models){
  for(st in stations){
    scenarios_loop = unique(ns_model_tasmin_GMST_no_max.gev.params %>% filter(CMIP_model==CMIP_mod, station==st) %>% select(scenario))
    scenarios_loop = scenarios_loop[scenarios_loop!= 'historical']
    for(sc in scenarios_loop){
      ns_models_loop = unique(ns_model_tasmin_GMST_no_max.gev.params %>% filter(CMIP_model==CMIP_mod, station==st, scenario==sc) %>% select(ns_model))
      for(ns_mod in ns_models_loop[[1]]){
      #GMST
      years_loop = unique(TN_adjust_stations_GMST %>%
                            filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>%
                            select(year))
      cov_loop = TN_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>% select(covariate)
      ns_model_loop = ns_model_tasmin_GMST_no_max.gev.params %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model==ns_mod)
      
      if(length(ns_model_loop$shape)==0){
        #ns_model_GMST_no_max_final.gev = subset(ns_model_GMST_no_max_final.gev, CMIP_model!=CMIP_mod | scenario!=sc| station != st | ns_model !=ns_mod)
      }
      else if(is.na(ns_model_loop$shape) | ns_model_loop$shape >0 ){
        #ns_model_GMST_no_max_final.gev = subset(ns_model_GMST_no_max_final.gev, CMIP_model!=CMIP_mod | scenario!=sc| station != st | ns_model !=ns_mod)
      }
      else{
        if(ns_mod %in% c('M000', 'M100', 'M-100')){      
          df_loop_GMST = data.frame(year = years_loop,
                                station=st,
                                scenario=sc,
                                CMIP_model = CMIP_mod,
                                ns_model=ns_mod,
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop +
                                  ns_model_loop$a*cov_loop + ns_model_loop$b,
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop +
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std),
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop +
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std),
                                scale = ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop,
                                scale_low = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop,
                                scale_high = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop,
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low,
                                shape_high = ns_model_loop$shape_high,
                                upper_bound = 0,
                                upper_bound_low = 0,
                                upper_bound_high = 0)}
        else{df_loop_GMST = data.frame(year = years_loop,
                                station=st,
                                scenario=sc,
                                CMIP_model = CMIP_mod,
                                ns_model=ns_mod,
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop +
                                  ns_model_loop$a*cov_loop + ns_model_loop$b,
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop +
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std),
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop +
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std),
                                scale = exp(ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop),
                                scale_low = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop),
                                scale_high = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop),
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low,
                                shape_high = ns_model_loop$shape_high,
                                upper_bound = 0,
                                upper_bound_low = 0,
                                upper_bound_high = 0)
        }
      colnames(df_loop_GMST) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')
      
      upper_bound_loop = df_loop_GMST$loc - df_loop_GMST$scale/df_loop_GMST$shape
      upper_bound_low_loop = df_loop_GMST$loc_low - df_loop_GMST$scale_high/df_loop_GMST$shape_low
      
      if(df_loop_GMST$shape_high<0){
        upper_bound_high_loop = df_loop_GMST$loc_high - df_loop_GMST$scale_low/df_loop_GMST$shape_high
      }
      else{
        upper_bound_high_loop = max(upper_bound_loop) + 100
      }
      
      df_loop_GMST = df_loop_GMST%>% mutate(upper_bound = upper_bound_loop,
                                            upper_bound_low = upper_bound_low_loop,
                                            upper_bound_high = upper_bound_high_loop)

      ns_model_GMST_no_max.tasmin.evol = rbind(ns_model_GMST_no_max.tasmin.evol, df_loop_GMST)
      }
      }
    }
  }
}

for(CMIP_mod in models){
  for(st in stations){
    scenarios_loop = unique(ns_model_tasmin_EMST_no_max.gev.params %>% filter(CMIP_model==CMIP_mod, station==st) %>% select(scenario))
    scenarios_loop = scenarios_loop[scenarios_loop!= 'historical']
    for(sc in scenarios_loop){
      ns_models_loop = unique(ns_model_tasmin_EMST_no_max.gev.params %>% filter(CMIP_model==CMIP_mod, station==st, scenario==sc) %>% select(ns_model))
      for(ns_mod in ns_models_loop[[1]]){      
      #EMST
      years_loop = unique(TN_adjust_stations_EMST %>% 
                            filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>% 
                            select(year))
      cov_loop = TN_adjust_stations_EMST %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>% select(covariate)
      ns_model_loop = ns_model_tasmin_EMST_no_max.gev.params %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model==ns_mod)
      
      if(length(ns_model_loop$shape)==0){
        #ns_model_EMST_no_max_final.gev = subset(ns_model_EMST_no_max_final.gev, CMIP_model!=CMIP_mod | scenario!=sc| station != st | ns_model !=ns_mod)
      }
      else if(is.na(ns_model_loop$shape) | ns_model_loop$shape >0 ){
        #ns_model_EMST_no_max_final.gev = subset(ns_model_EMST_no_max_final.gev, CMIP_model!=CMIP_mod | scenario!=sc| station != st | ns_model !=ns_mod)
      }
      else{
        if(ns_mod %in% c('M000', 'M100', 'M-100')){
          df_loop_EMST = data.frame(year = years_loop, 
                                station=st, 
                                scenario=sc, 
                                CMIP_model = CMIP_mod, 
                                ns_model=ns_mod, 
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop + 
                                  ns_model_loop$a*cov_loop + ns_model_loop$b, 
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop + 
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std), 
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop + 
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std), 
                                scale = ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop, 
                                scale_low = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop, 
                                scale_high = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop, 
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low, 
                                shape_high = ns_model_loop$shape_high, 
                                upper_bound = 0, 
                                upper_bound_low = 0, 
                                upper_bound_high = 0)
        }
        else{
          df_loop_EMST = data.frame(year = years_loop, 
                                station=st, 
                                scenario=sc, 
                                CMIP_model = CMIP_mod, 
                                ns_model=ns_mod, 
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop + 
                                  ns_model_loop$a*cov_loop + ns_model_loop$b, 
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop + 
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std), 
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop + 
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std), 
                                scale = exp(ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop), 
                                scale_low = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop), 
                                scale_high = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop), 
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low, 
                                shape_high = ns_model_loop$shape_high, 
                                upper_bound = 0, 
                                upper_bound_low = 0, 
                                upper_bound_high = 0)}
      colnames(df_loop_EMST) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')
      
      upper_bound_loop = df_loop_EMST$loc - df_loop_EMST$scale/df_loop_EMST$shape
      upper_bound_low_loop = df_loop_EMST$loc_low - df_loop_EMST$scale_high/df_loop_EMST$shape_low
      if(df_loop_EMST$shape_high<0){
        upper_bound_high_loop = df_loop_EMST$loc_high - df_loop_EMST$scale_low/df_loop_EMST$shape_high
      }
      else{
        upper_bound_high_loop = max(upper_bound_loop) + 100
      }
      df_loop_EMST = df_loop_EMST%>% mutate(upper_bound = upper_bound_loop, 
                                            upper_bound_low = upper_bound_low_loop,
                                            upper_bound_high = upper_bound_high_loop)
      
      ns_model_EMST_no_max.tasmin.evol = rbind(ns_model_EMST_no_max.tasmin.evol, df_loop_EMST)
      }
      }
    }
  }
}
```

```{r, Compute the GEV regression with no hist}
ns_model_GMST_no_hist.evol = data.frame(matrix(nrow=0, ncol=17))
colnames(ns_model_GMST_no_hist.evol) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')

ns_model_EMST_no_hist.evol = data.frame(matrix(nrow=0, ncol=17))
colnames(ns_model_EMST_no_hist.evol) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')

for(CMIP_mod in models){
  for(st in stations){
    scenarios_loop = unique(ns_model_GMST_no_hist_final.gev.params %>% filter(CMIP_model==CMIP_mod, station==st) %>% select(scenario))
    scenarios_loop = scenarios_loop[scenarios_loop!= 'historical']
    for(sc in scenarios_loop){
      ns_models_loop = unique(ns_model_GMST_no_hist_final.gev.params %>% filter(CMIP_model==CMIP_mod, station==st, scenario==sc) %>% select(ns_model))
      for(ns_mod in ns_models_loop[[1]]){
      #GMST
      years_loop = unique(TX_adjust_stations_GMST %>%
                            filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>%
                            select(year))
      cov_loop = TX_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>% select(covariate)
      ns_model_loop = ns_model_GMST_no_hist_final.gev.params %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model==ns_mod)
      

        if(ns_mod %in% c('M000', 'M100', 'M-100')){      
          df_loop_GMST = data.frame(year = years_loop,
                                station=st,
                                scenario=sc,
                                CMIP_model = CMIP_mod,
                                ns_model=ns_mod,
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop +
                                  ns_model_loop$a*cov_loop + ns_model_loop$b,
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop +
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std),
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop +
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std),
                                scale = ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop,
                                scale_low = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop,
                                scale_high = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop,
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low,
                                shape_high = ns_model_loop$shape_high,
                                upper_bound = 0,
                                upper_bound_low = 0,
                                upper_bound_high = 0)}
        else{df_loop_GMST = data.frame(year = years_loop,
                                station=st,
                                scenario=sc,
                                CMIP_model = CMIP_mod,
                                ns_model=ns_mod,
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop +
                                  ns_model_loop$a*cov_loop + ns_model_loop$b,
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop +
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std),
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop +
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std),
                                scale = exp(ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop),
                                scale_low = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop),
                                scale_high = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop),
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low,
                                shape_high = ns_model_loop$shape_high,
                                upper_bound = 0,
                                upper_bound_low = 0,
                                upper_bound_high = 0)
        }
      colnames(df_loop_GMST) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')
      
      upper_bound_loop = df_loop_GMST$loc - df_loop_GMST$scale/df_loop_GMST$shape
      upper_bound_low_loop = df_loop_GMST$loc_low - df_loop_GMST$scale_high/df_loop_GMST$shape_low
      
      if(df_loop_GMST$shape_high<0){
        upper_bound_high_loop = df_loop_GMST$loc_high - df_loop_GMST$scale_low/df_loop_GMST$shape_high
      }
      else{
        upper_bound_high_loop = max(upper_bound_loop) + 100
      }
      
      df_loop_GMST = df_loop_GMST%>% mutate(upper_bound = upper_bound_loop,
                                            upper_bound_low = upper_bound_low_loop,
                                            upper_bound_high = upper_bound_high_loop)

      ns_model_GMST_no_hist.evol = rbind(ns_model_GMST_no_hist.evol, df_loop_GMST)
      }
    }
  }
}

for(CMIP_mod in models){
  for(st in stations){
    scenarios_loop = unique(ns_model_EMST_no_hist_final.gev.params %>% filter(CMIP_model==CMIP_mod, station==st) %>% select(scenario))
    scenarios_loop = scenarios_loop[scenarios_loop!= 'historical']
    for(sc in scenarios_loop){
      ns_models_loop = unique(ns_model_EMST_no_hist_final.gev.params %>% filter(CMIP_model==CMIP_mod, station==st, scenario==sc) %>% select(ns_model))
      for(ns_mod in ns_models_loop[[1]]){      
      #EMST
      years_loop = unique(TX_adjust_stations_EMST %>% 
                            filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>% 
                            select(year))
      cov_loop = TX_adjust_stations_EMST %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>% select(covariate)
      ns_model_loop = ns_model_EMST_no_hist_final.gev.params %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model==ns_mod)
      

        if(ns_mod %in% c('M000', 'M100', 'M-100')){
          df_loop_EMST = data.frame(year = years_loop, 
                                station=st, 
                                scenario=sc, 
                                CMIP_model = CMIP_mod, 
                                ns_model=ns_mod, 
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop + 
                                  ns_model_loop$a*cov_loop + ns_model_loop$b, 
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop + 
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std), 
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop + 
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std), 
                                scale = ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop, 
                                scale_low = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop, 
                                scale_high = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop, 
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low, 
                                shape_high = ns_model_loop$shape_high, 
                                upper_bound = 0, 
                                upper_bound_low = 0, 
                                upper_bound_high = 0)
        }
        else{
          df_loop_EMST = data.frame(year = years_loop, 
                                station=st, 
                                scenario=sc, 
                                CMIP_model = CMIP_mod, 
                                ns_model=ns_mod, 
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop + 
                                  ns_model_loop$a*cov_loop + ns_model_loop$b, 
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop + 
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std), 
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop + 
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std), 
                                scale = exp(ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop), 
                                scale_low = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop), 
                                scale_high = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop), 
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low, 
                                shape_high = ns_model_loop$shape_high, 
                                upper_bound = 0, 
                                upper_bound_low = 0, 
                                upper_bound_high = 0)}
      colnames(df_loop_EMST) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')
      
      upper_bound_loop = df_loop_EMST$loc - df_loop_EMST$scale/df_loop_EMST$shape
      upper_bound_low_loop = df_loop_EMST$loc_low - df_loop_EMST$scale_high/df_loop_EMST$shape_low
      if(df_loop_EMST$shape_high<0){
        upper_bound_high_loop = df_loop_EMST$loc_high - df_loop_EMST$scale_low/df_loop_EMST$shape_high
      }
      else{
        upper_bound_high_loop = max(upper_bound_loop) + 100
      }
      df_loop_EMST = df_loop_EMST%>% mutate(upper_bound = upper_bound_loop, 
                                            upper_bound_low = upper_bound_low_loop,
                                            upper_bound_high = upper_bound_high_loop)
      
      ns_model_EMST_no_hist.evol = rbind(ns_model_EMST_no_hist.evol, df_loop_EMST)
      }
    }
  }
}
```

```{r, TASMIN, Compute the GEV regression with no hist}
ns_model_GMST_no_hist.tasmin.evol = data.frame(matrix(nrow=0, ncol=17))
colnames(ns_model_GMST_no_hist.tasmin.evol) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')

ns_model_EMST_no_hist.tasmin.evol = data.frame(matrix(nrow=0, ncol=17))
colnames(ns_model_EMST_no_hist.tasmin.evol) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')

#ns_model_GMST_no_max_final.gev = data.frame(ns_model_GMST_no_max.gev.params)
#ns_model_EMST_no_max_final.gev = data.frame(ns_model_EMST_no_max.gev.params)

for(CMIP_mod in models){
  for(st in stations){
    scenarios_loop = unique(ns_model_tasmin_GMST_no_hist.gev.params %>% filter(CMIP_model==CMIP_mod, station==st) %>% select(scenario))
    scenarios_loop = scenarios_loop[scenarios_loop!= 'historical']
    for(sc in scenarios_loop){
      ns_models_loop = unique(ns_model_tasmin_GMST_no_hist.gev.params %>% filter(CMIP_model==CMIP_mod, station==st, scenario==sc) %>% select(ns_model))
      for(ns_mod in ns_models_loop[[1]]){
      #GMST
      years_loop = unique(TN_adjust_stations_GMST %>%
                            filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>%
                            select(year))
      cov_loop = TN_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>% select(covariate)
      ns_model_loop = ns_model_tasmin_GMST_no_hist.gev.params %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model==ns_mod)
      
      if(length(ns_model_loop$shape)==0){
        #ns_model_GMST_no_max_final.gev = subset(ns_model_GMST_no_max_final.gev, CMIP_model!=CMIP_mod | scenario!=sc| station != st | ns_model !=ns_mod)
      }
      else if(is.na(ns_model_loop$shape) | ns_model_loop$shape >0 ){
        #ns_model_GMST_no_max_final.gev = subset(ns_model_GMST_no_max_final.gev, CMIP_model!=CMIP_mod | scenario!=sc| station != st | ns_model !=ns_mod)
      }
      else{
        if(ns_mod %in% c('M000', 'M100', 'M-100')){      
          df_loop_GMST = data.frame(year = years_loop,
                                station=st,
                                scenario=sc,
                                CMIP_model = CMIP_mod,
                                ns_model=ns_mod,
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop +
                                  ns_model_loop$a*cov_loop + ns_model_loop$b,
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop +
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std),
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop +
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std),
                                scale = ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop,
                                scale_low = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop,
                                scale_high = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop,
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low,
                                shape_high = ns_model_loop$shape_high,
                                upper_bound = 0,
                                upper_bound_low = 0,
                                upper_bound_high = 0)}
        else{df_loop_GMST = data.frame(year = years_loop,
                                station=st,
                                scenario=sc,
                                CMIP_model = CMIP_mod,
                                ns_model=ns_mod,
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop +
                                  ns_model_loop$a*cov_loop + ns_model_loop$b,
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop +
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std),
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop +
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std),
                                scale = exp(ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop),
                                scale_low = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop),
                                scale_high = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop),
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low,
                                shape_high = ns_model_loop$shape_high,
                                upper_bound = 0,
                                upper_bound_low = 0,
                                upper_bound_high = 0)
        }
      colnames(df_loop_GMST) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')
      
      upper_bound_loop = df_loop_GMST$loc - df_loop_GMST$scale/df_loop_GMST$shape
      upper_bound_low_loop = df_loop_GMST$loc_low - df_loop_GMST$scale_high/df_loop_GMST$shape_low
      
      if(df_loop_GMST$shape_high<0){
        upper_bound_high_loop = df_loop_GMST$loc_high - df_loop_GMST$scale_low/df_loop_GMST$shape_high
      }
      else{
        upper_bound_high_loop = max(upper_bound_loop) + 100
      }
      
      df_loop_GMST = df_loop_GMST%>% mutate(upper_bound = upper_bound_loop,
                                            upper_bound_low = upper_bound_low_loop,
                                            upper_bound_high = upper_bound_high_loop)

      ns_model_GMST_no_hist.tasmin.evol = rbind(ns_model_GMST_no_hist.tasmin.evol, df_loop_GMST)
      }
      }
    }
  }
}

for(CMIP_mod in models){
  for(st in stations){
    scenarios_loop = unique(ns_model_tasmin_EMST_no_hist.gev.params %>% filter(CMIP_model==CMIP_mod, station==st) %>% select(scenario))
    scenarios_loop = scenarios_loop[scenarios_loop!= 'historical']
    for(sc in scenarios_loop){
      ns_models_loop = unique(ns_model_tasmin_EMST_no_hist.gev.params %>% filter(CMIP_model==CMIP_mod, station==st, scenario==sc) %>% select(ns_model))
      for(ns_mod in ns_models_loop[[1]]){      
      #EMST
      years_loop = unique(TN_adjust_stations_EMST %>% 
                            filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>% 
                            select(year))
      cov_loop = TN_adjust_stations_EMST %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>% select(covariate)
      ns_model_loop = ns_model_tasmin_EMST_no_hist.gev.params %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model==ns_mod)
      
      if(length(ns_model_loop$shape)==0){
        #ns_model_EMST_no_max_final.gev = subset(ns_model_EMST_no_max_final.gev, CMIP_model!=CMIP_mod | scenario!=sc| station != st | ns_model !=ns_mod)
      }
      else if(is.na(ns_model_loop$shape) | ns_model_loop$shape >0 ){
        #ns_model_EMST_no_max_final.gev = subset(ns_model_EMST_no_max_final.gev, CMIP_model!=CMIP_mod | scenario!=sc| station != st | ns_model !=ns_mod)
      }
      else{
        if(ns_mod %in% c('M000', 'M100', 'M-100')){
          df_loop_EMST = data.frame(year = years_loop, 
                                station=st, 
                                scenario=sc, 
                                CMIP_model = CMIP_mod, 
                                ns_model=ns_mod, 
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop + 
                                  ns_model_loop$a*cov_loop + ns_model_loop$b, 
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop + 
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std), 
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop + 
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std), 
                                scale = ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop, 
                                scale_low = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop, 
                                scale_high = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop, 
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low, 
                                shape_high = ns_model_loop$shape_high, 
                                upper_bound = 0, 
                                upper_bound_low = 0, 
                                upper_bound_high = 0)
        }
        else{
          df_loop_EMST = data.frame(year = years_loop, 
                                station=st, 
                                scenario=sc, 
                                CMIP_model = CMIP_mod, 
                                ns_model=ns_mod, 
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop + 
                                  ns_model_loop$a*cov_loop + ns_model_loop$b, 
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop + 
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std), 
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop + 
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std), 
                                scale = exp(ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop), 
                                scale_low = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop), 
                                scale_high = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop), 
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low, 
                                shape_high = ns_model_loop$shape_high, 
                                upper_bound = 0, 
                                upper_bound_low = 0, 
                                upper_bound_high = 0)}
      colnames(df_loop_EMST) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')
      
      upper_bound_loop = df_loop_EMST$loc - df_loop_EMST$scale/df_loop_EMST$shape
      upper_bound_low_loop = df_loop_EMST$loc_low - df_loop_EMST$scale_high/df_loop_EMST$shape_low
      if(df_loop_EMST$shape_high<0){
        upper_bound_high_loop = df_loop_EMST$loc_high - df_loop_EMST$scale_low/df_loop_EMST$shape_high
      }
      else{
        upper_bound_high_loop = max(upper_bound_loop) + 100
      }
      df_loop_EMST = df_loop_EMST%>% mutate(upper_bound = upper_bound_loop, 
                                            upper_bound_low = upper_bound_low_loop,
                                            upper_bound_high = upper_bound_high_loop)
      
      ns_model_EMST_no_hist.tasmin.evol = rbind(ns_model_EMST_no_hist.tasmin.evol, df_loop_EMST)
      }
      }
    }
  }
}
```

```{r, TASMIN, Compute the GEV regression with no hist no max}
ns_model_GMST_no_hist_no_max.tasmin.evol = data.frame(matrix(nrow=0, ncol=17))
colnames(ns_model_GMST_no_hist_no_max.tasmin.evol) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')

ns_model_EMST_no_hist_no_max.tasmin.evol = data.frame(matrix(nrow=0, ncol=17))
colnames(ns_model_EMST_no_hist_no_max.tasmin.evol) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')

for(CMIP_mod in models){
  for(st in stations){
    scenarios_loop = unique(ns_model_tasmin_GMST_no_hist_no_max.gev.params %>% filter(CMIP_model==CMIP_mod, station==st) %>% select(scenario))
    scenarios_loop = scenarios_loop[scenarios_loop!= 'historical']
    for(sc in scenarios_loop){
      ns_models_loop = unique(ns_model_tasmin_GMST_no_hist_no_max.gev.params %>% filter(CMIP_model==CMIP_mod, station==st, scenario==sc) %>% select(ns_model))
      for(ns_mod in ns_models_loop[[1]]){
      #GMST
      years_loop = unique(TN_adjust_stations_GMST %>%
                            filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>%
                            select(year))
      cov_loop = TN_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>% select(covariate)
      ns_model_loop = ns_model_tasmin_GMST_no_hist_no_max.gev.params %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model==ns_mod)
      
      if(length(ns_model_loop$shape)==0){}
      else if(is.na(ns_model_loop$shape) | ns_model_loop$shape >0 ){}
      else{
        if(ns_mod %in% c('M000', 'M100', 'M-100')){      
          df_loop_GMST = data.frame(year = years_loop,
                                station=st,
                                scenario=sc,
                                CMIP_model = CMIP_mod,
                                ns_model=ns_mod,
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop +
                                  ns_model_loop$a*cov_loop + ns_model_loop$b,
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop +
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std),
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop +
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std),
                                scale = ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop,
                                scale_low = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop,
                                scale_high = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop,
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low,
                                shape_high = ns_model_loop$shape_high,
                                upper_bound = 0,
                                upper_bound_low = 0,
                                upper_bound_high = 0)}
        else{df_loop_GMST = data.frame(year = years_loop,
                                station=st,
                                scenario=sc,
                                CMIP_model = CMIP_mod,
                                ns_model=ns_mod,
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop +
                                  ns_model_loop$a*cov_loop + ns_model_loop$b,
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop +
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std),
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop +
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std),
                                scale = exp(ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop),
                                scale_low = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop),
                                scale_high = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop),
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low,
                                shape_high = ns_model_loop$shape_high,
                                upper_bound = 0,
                                upper_bound_low = 0,
                                upper_bound_high = 0)
        }
      colnames(df_loop_GMST) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')
      
      upper_bound_loop = df_loop_GMST$loc - df_loop_GMST$scale/df_loop_GMST$shape
      upper_bound_low_loop = df_loop_GMST$loc_low - df_loop_GMST$scale_high/df_loop_GMST$shape_low
      
      if(df_loop_GMST$shape_high<0){
        upper_bound_high_loop = df_loop_GMST$loc_high - df_loop_GMST$scale_low/df_loop_GMST$shape_high
      }
      else{
        upper_bound_high_loop = max(upper_bound_loop) + 100
      }
      
      df_loop_GMST = df_loop_GMST%>% mutate(upper_bound = upper_bound_loop,
                                            upper_bound_low = upper_bound_low_loop,
                                            upper_bound_high = upper_bound_high_loop)

      ns_model_GMST_no_hist_no_max.tasmin.evol = rbind(ns_model_GMST_no_hist_no_max.tasmin.evol, df_loop_GMST)
      }
      }
    }
  }
}

for(CMIP_mod in models){
  for(st in stations){
    scenarios_loop = unique(ns_model_tasmin_EMST_no_hist_no_max.gev.params %>% filter(CMIP_model==CMIP_mod, station==st) %>% select(scenario))
    scenarios_loop = scenarios_loop[scenarios_loop!= 'historical']
    for(sc in scenarios_loop){
      ns_models_loop = unique(ns_model_tasmin_EMST_no_hist_no_max.gev.params %>% filter(CMIP_model==CMIP_mod, station==st, scenario==sc) %>% select(ns_model))
      for(ns_mod in ns_models_loop[[1]]){      
      #EMST
      years_loop = unique(TN_adjust_stations_EMST %>% 
                            filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>% 
                            select(year))
      cov_loop = TN_adjust_stations_EMST %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st) %>% select(covariate)
      ns_model_loop = ns_model_tasmin_EMST_no_hist_no_max.gev.params %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model==ns_mod)
      
      if(length(ns_model_loop$shape)==0){
        #ns_model_EMST_no_max_final.gev = subset(ns_model_EMST_no_max_final.gev, CMIP_model!=CMIP_mod | scenario!=sc| station != st | ns_model !=ns_mod)
      }
      else if(is.na(ns_model_loop$shape) | ns_model_loop$shape >0 ){
        #ns_model_EMST_no_max_final.gev = subset(ns_model_EMST_no_max_final.gev, CMIP_model!=CMIP_mod | scenario!=sc| station != st | ns_model !=ns_mod)
      }
      else{
        if(ns_mod %in% c('M000', 'M100', 'M-100')){
          df_loop_EMST = data.frame(year = years_loop, 
                                station=st, 
                                scenario=sc, 
                                CMIP_model = CMIP_mod, 
                                ns_model=ns_mod, 
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop + 
                                  ns_model_loop$a*cov_loop + ns_model_loop$b, 
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop + 
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std), 
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop + 
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std), 
                                scale = ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop, 
                                scale_low = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop, 
                                scale_high = ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop, 
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low, 
                                shape_high = ns_model_loop$shape_high, 
                                upper_bound = 0, 
                                upper_bound_low = 0, 
                                upper_bound_high = 0)
        }
        else{
          df_loop_EMST = data.frame(year = years_loop, 
                                station=st, 
                                scenario=sc, 
                                CMIP_model = CMIP_mod, 
                                ns_model=ns_mod, 
                                loc=ns_model_loop$loc_0 + ns_model_loop$loc_1*cov_loop + 
                                  ns_model_loop$a*cov_loop + ns_model_loop$b, 
                                loc_low = ns_model_loop$loc_0_low + ns_model_loop$loc_1_low*cov_loop + 
                                  (ns_model_loop$a - ns_model_loop$a_std)*cov_loop + (ns_model_loop$b - ns_model_loop$b_std), 
                                loc_high = ns_model_loop$loc_0_high + ns_model_loop$loc_1_high*cov_loop + 
                                  (ns_model_loop$a + ns_model_loop$a_std)*cov_loop + (ns_model_loop$b + ns_model_loop$b_std), 
                                scale = exp(ns_model_loop$scale_0 + ns_model_loop$scale_1*cov_loop), 
                                scale_low = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop), 
                                scale_high = exp(ns_model_loop$scale_0_low + ns_model_loop$scale_1_high*cov_loop), 
                                shape = ns_model_loop$shape,
                                shape_low = ns_model_loop$shape_low, 
                                shape_high = ns_model_loop$shape_high, 
                                upper_bound = 0, 
                                upper_bound_low = 0, 
                                upper_bound_high = 0)}
      colnames(df_loop_EMST) = c('year', 'station', 'scenario', 'CMIP_model', 'ns_model', 'loc', 'loc_low', 'loc_high', 'scale', 'scale_low', 'scale_high','shape','shape_low', 'shape_high', 'upper_bound', 'upper_bound_low', 'upper_bound_high')
      
      upper_bound_loop = df_loop_EMST$loc - df_loop_EMST$scale/df_loop_EMST$shape
      upper_bound_low_loop = df_loop_EMST$loc_low - df_loop_EMST$scale_high/df_loop_EMST$shape_low
      if(df_loop_EMST$shape_high<0){
        upper_bound_high_loop = df_loop_EMST$loc_high - df_loop_EMST$scale_low/df_loop_EMST$shape_high
      }
      else{
        upper_bound_high_loop = max(upper_bound_loop) + 100
      }
      df_loop_EMST = df_loop_EMST%>% mutate(upper_bound = upper_bound_loop, 
                                            upper_bound_low = upper_bound_low_loop,
                                            upper_bound_high = upper_bound_high_loop)
      
      ns_model_EMST_no_hist_no_max.tasmin.evol = rbind(ns_model_EMST_no_hist_no_max.tasmin.evol, df_loop_EMST)
      }
      }
    }
  }
}
```

```{r, Plot data with fit from Adjusted GEV-GMST}
ns_mod_loop = c('M000', 'M100', 'M110')
st = c('Cirfontaines')
for(CMIP_mod in c('CanESM5')){
  scenarios_loop = Reduce(intersect, list(v1 = unique(ns_model_GMST.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario)), 
                                          v2 = unique(ns_model_GMST_no_max.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario)), 
                                          v3 = unique(ns_model_GMST_no_hist.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario))))
  for(sc in scenarios_loop[[1]]){
  ns_model_loop.evol = ns_model_GMST.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  ns_model_loop_no_max.evol = ns_model_GMST_no_max.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  ns_model_loop_no_hist.evol = ns_model_GMST_no_hist.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  #ns_model_loop_2.evol = ns_model_GMST.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model==ns_mod_2)
  #print(head(ns_model_loop.evol))
  p=ggplot() +
    geom_ribbon(aes(x=year, ymin=loc-scale, ymax=loc+scale, fill='GEV confidence interval'),alpha=0.2, data =ns_model_loop.evol) +
    #geom_ribbon(aes(x=year, ymin=loc_low-scale_high, ymax=loc_high+scale_high, fill='97.5% confidence interval'),alpha=0.2, data =ns_model_loop.evol) +
    geom_line(aes(x=year, y=loc, colour='Black'), linetype = 'longdash', data=ns_model_loop.evol) +
    #geom_line(aes(x=year, y=loc, colour='Loc 2'), linetype = 'longdash', data=ns_model_loop_no_hist.evol) +
    geom_line(aes(x=year, y=upper_bound, color='Upper bound'), data=ns_model_loop.evol) +
    geom_line(aes(x=year, y=upper_bound, color='Upper bound 2'), data=ns_model_loop_no_max.evol) +
    #geom_line(aes(x=year, y=upper_bound, color='Upper bound 3'), data=ns_model_loop_no_hist.evol) +
    #geom_ribbon(aes(x=year, ymin=upper_bound_low, ymax=upper_bound_high, fill='Upper bound 95% confidence interval'),alpha=0.4, data =ns_model_loop.evol) +
    geom_point(aes(x=year, y=var), alpha=0.4, size=0.5, data = TX_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario%in%c(sc), station %in% st))+
    geom_point(aes(x=year, y=var), color='#FF0000', alpha=0.6, size=1, data = TX_adjust_stations_max %>% filter(CMIP_model==CMIP_mod, scenario==sc, station %in% st)) +
    theme_minimal() + 
    theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
    #ylim(0,80) +
    #scale_y_continuous(trans='log10') +
    #scale_y_log10() +
    #facet_wrap(~ns_model+station, scale='free') +
    facet_grid(row=vars(station), cols=vars(ns_model), scale='free') +
    labs(title=paste('GEV fit with model-',CMIP_mod, '-', sc), 
         x='Year',
         y='Temperature[°C]', 
         fill='', 
         colour='') +
    scale_fill_manual(values=c('#FF0000', '#0000FF'), labels=list(bquote(~mu~"+/-"~sigma), bquote(" Upper bound")))+
    scale_color_manual(values = c('#FF0000', '#0000FF', '#33ccff', '#00ff00'), labels=list(bquote("Location "*mu), bquote("Upper bound "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no max- "~mu~ "-" ~sigma~"/"~xi), "Upper bound-no historical"))
  print(p)
  #ggsave(paste(fig_path,"data_and_gev_GMST_fit_", CMIP_mod, "_", sc, "_", st, ".png", sep=""), width=8, height=5)
}
}
```

```{r, Plot data with fit from Adjusted GEV-EMST}
st = 'St Dizier'
ns_mod = c('M000', 'M100', 'M110')
for(CMIP_mod in models){
    scenarios_loop = Reduce(intersect, list(v1 = unique(ns_model_EMST.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario)), 
                                          v2 = unique(ns_model_EMST_no_max.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario)))) 
                                          #v3 = unique(ns_model_EMST_no_hist.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario))))
  for(sc in scenarios_loop[[1]]){
  ns_model_loop.evol = ns_model_EMST.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model %in% ns_mod)
  ns_model_loop_no_max.evol = ns_model_EMST_no_max.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model %in% ns_mod)
  #ns_model_loop_no_hist.evol = ns_model_EMST_no_hist.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model %in% ns_mod)
  p=ggplot() +
    geom_ribbon(aes(x=year, ymin=loc-scale, ymax=loc+scale, fill='GEV confidence interval'),alpha=0.2, data =ns_model_loop.evol) +
    geom_line(aes(x=year, y=loc, colour='Black'), data=ns_model_loop.evol) +
    #geom_line(aes(x=year, y=loc, colour='Loc 2'), data=ns_model_loop_no_hist.evol) +
    geom_line(aes(x=year, y=upper_bound, color='Upper bound'), data=ns_model_loop.evol) +
    geom_line(aes(x=year, y=upper_bound, color='Upper bound 2'), data=ns_model_loop_no_max.evol) +
    #geom_line(aes(x=year, y=upper_bound, color='Upper bound 3'), data=ns_model_loop_no_hist.evol) +
    geom_point(aes(x=year, y=var), alpha=0.4, size=0.5, data = TX_adjust_stations_EMST %>% filter(CMIP_model==CMIP_mod, scenario==sc, station %in% st))+
    geom_point(aes(x=year, y=var), color='#FF0000', alpha=0.6, size=1, data = TX_adjust_stations_max %>% filter(CMIP_model==CMIP_mod, scenario==sc, station %in% st)) +
    theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
    facet_grid(cols=vars(ns_model), scale='free') +
    labs(title=paste('GEV fit with model-',CMIP_mod, '-', sc, '-EMST'), 
         x='Year',
         y='Temperature[°C]', 
         fill='', 
         colour='') +
    scale_fill_manual(values=c('#FF0000', '#0000FF'), labels=list(bquote(~mu~"+/-"~sigma), bquote(" Upper bound")))+
    scale_color_manual(values = c('#FF0000', '#0000FF', '#33ccff', '#00ff00'), labels=list(bquote("Location "*mu), bquote("Upper bound "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no max- "~mu~ "-" ~sigma~"/"~xi), "Upper bound-no historical"))+
    theme_minimal()
  print(p)
  #ggsave(paste(fig_path,"data_and_gev_EMST_fit_", CMIP_mod, "_", sc, ".png", sep=""), width=8, height=5)
}
}
```

```{r, Plot data with fit from R2D2, CDFt, CMIP GEV-GMST }
ns_mod_loop = c('M000', 'M100', 'M110', 'M-100', 'M-110')
st = c('Cirfontaines')
for(CMIP_mod in c('MPI-ESM1-2-LR')){
  scenarios_loop = Reduce(intersect, list(v1 = unique(ns_model_GMST.evol%>%filter(CMIP_model==CMIP_mod, station %in% st)%>%select(scenario)), 
                                          v2 = unique(ns_model_GMST_no_max.evol%>%filter(CMIP_model==CMIP_mod, station %in% st)%>%select(scenario)), 
                                          v3 = unique(ns_model_CDFt_GMST.evol%>%filter(CMIP_model==CMIP_mod, station %in% st)%>%select(scenario)), 
                                          v4 = unique(ns_model_CDFt_GMST_no_max.evol%>%filter(CMIP_model==CMIP_mod, station %in% st)%>%select(scenario)), 
                                          v5 = unique(ns_model_CMIP_GMST.evol%>%filter(CMIP_model==CMIP_mod)%>%select(scenario))))
  for(sc in scenarios_loop[[1]]){
  ns_model_loop_GMST.evol = ns_model_GMST.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  ns_model_loop_no_max_GMST.evol = ns_model_GMST_no_max.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  ns_model_CDFt_loop_GMST.evol = ns_model_CDFt_GMST.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  ns_model_CDFt_loop_no_max_GMST.evol = ns_model_CDFt_GMST_no_max.evol%>%filter(CMIP_model==CMIP_mod, scenario==sc, ns_model%in%ns_mod_loop, station%in%st)
  ns_model_CMIP_loop_GMST.evol = ns_model_CMIP_GMST.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop)

  p=ggplot() +
    # geom_ribbon(aes(x=year, ymin=loc-scale, ymax=loc+scale, fill='GEV confidence interval'),alpha=0.2, data =ns_model_loop_GMST.evol) +
    # geom_line(aes(x=year, y=loc, colour='Loc_GMST', linetype='GMST'), data=ns_model_loop_GMST.evol) +
    # geom_ribbon(aes(x=year, ymin=loc-scale, ymax=loc+scale, fill='GEV confidence interval'),alpha=0.2, data =ns_model_loop_EMST.evol) +
    # geom_line(aes(x=year, y=loc, colour='Loc_EMST', linetype='EMST'), data=ns_model_loop_EMST.evol) +
    geom_line(aes(x=year, y=upper_bound, color='R2D2', linetype='R2D2'), data=ns_model_loop_GMST.evol) +
    geom_line(aes(x=year, y=upper_bound, color='R2D2-no_max', linetype='R2D2'), data=ns_model_loop_no_max_GMST.evol) +
    geom_line(aes(x=year, y=upper_bound, color='CDFt', linetype='CDFt'), size=0.75, data=ns_model_CDFt_loop_GMST.evol) +
    geom_line(aes(x=year, y=upper_bound, color='CDFt-no_max', linetype='CDFt'), size=0.75, data=ns_model_CDFt_loop_no_max_GMST.evol) +
    geom_line(aes(x=year, y=upper_bound, color='CMIP', linetype='CMIP'), size=0.9, data=ns_model_CMIP_loop_GMST.evol) +
    
    geom_point(aes(x=year, y=var), color='#33ccff', alpha=0.4, size=0.5, data = TX_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario%in%c(sc), station %in% st))+
    geom_point(aes(x=year, y=var), color='#0000FF', alpha=0.6, size=1.2, data = TX_adjust_stations_max %>% filter(CMIP_model==CMIP_mod, scenario==sc, station %in% st)) +
    
    geom_point(aes(x=year, y=var), color='#cccc00', alpha=0.4, size=0.5, data = TX_adjust_CDFt_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario%in%c(sc), station %in% st))+
    geom_point(aes(x=year, y=var), color='#336600', alpha=0.6, size=1.2, data = TX_adjust_CDFt_stations_max %>% filter(CMIP_model==CMIP_mod, scenario==sc, station %in% st)) +
    ylim(28,70)+
    theme_minimal() + 
    theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
    facet_grid(cols=vars(ns_model), scale='free') +
    labs(title=paste('GEV fit with data-GMST-',st,'-',CMIP_mod, '-', sc), 
         x='Year',
         y='Temperature[°C]', 
         fill='', 
         colour='', 
         linetype='Data') +
    scale_linetype_manual(values=c('R2D2'='solid', 'CDFt'='longdash', 'CMIP'='twodash'))+
    #scale_fill_manual(values=c('#FF0000', '#0000FF'), labels=list(bquote(~mu~"+/-"~sigma), bquote(" Upper bound")))+
    scale_color_manual(values = c('CMIP'='#ff9933', 'R2D2'='#0000FF','R2D2-no_max'='#33ccff', 'CDFt'='#336600', 'CDFt-no_max'='#cccc00'))#, labels=list(bquote("Location-GMST-"*mu), bquote("Location-EMST-"*mu), bquote("Upper bound-GMST-"~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no max-GMST- "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-EMST- "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no max-EMST- "~mu~ "-" ~sigma~"/"~xi)))
    #scale_color_manual(values = c('Loc_GMST'='#FF0000', 'Loc_EMST'='#ff9933', 'Upper bound GMST'='#0000FF', 'Upper bound EMST'='#336600'), labels=list(bquote("Location-GMST-"*mu), bquote("Location-EMST-"*mu), bquote("Upper bound-GMST-"~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-EMST- "~mu~ "-" ~sigma~"/"~xi)))
  print(p)
  ggsave(paste(fig_path,"data_and_gev_GMST_fit_R2D2_CDFt_CMIP_", CMIP_mod, "_", sc, "_", st, ".png", sep=""), width=8, height=5)
}
}
```

```{r, Plot data with fit from Adjusted GEV-GMST and EMST}
ns_mod_loop = c('M000', 'M100', 'M110', 'M-100', 'M-110')
st = c('Cirfontaines')
for(CMIP_mod in c('MPI-ESM1-2-LR')){
  scenarios_loop = Reduce(intersect, list(v1 = unique(ns_model_GMST.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario)), 
                                          v2 = unique(ns_model_GMST_no_max.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario)), 
                                          v3 = unique(ns_model_EMST.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario)), 
                                          v4 = unique(ns_model_EMST_no_max.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario))))
  for(sc in scenarios_loop[[1]]){
  ns_model_loop_GMST.evol = ns_model_GMST.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  ns_model_loop_no_max_GMST.evol = ns_model_GMST_no_max.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  ns_model_loop_EMST.evol = ns_model_EMST.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  ns_model_loop_no_max_EMST.evol = ns_model_EMST_no_max.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  #ns_model_loop_no_hist.evol = ns_model_GMST_no_hist.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  #ns_model_loop_2.evol = ns_model_GMST.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model==ns_mod_2)
  #print(head(ns_model_loop.evol))
  p=ggplot() +
    geom_ribbon(aes(x=year, ymin=loc-scale, ymax=loc+scale, fill='GEV confidence interval'),alpha=0.2, data =ns_model_loop_GMST.evol) +
    geom_line(aes(x=year, y=loc, colour='Loc_GMST', linetype='GMST'), data=ns_model_loop_GMST.evol) +
    geom_ribbon(aes(x=year, ymin=loc-scale, ymax=loc+scale, fill='GEV confidence interval'),alpha=0.2, data =ns_model_loop_EMST.evol) +
    geom_line(aes(x=year, y=loc, colour='Loc_EMST', linetype='EMST'), data=ns_model_loop_EMST.evol) +
    geom_line(aes(x=year, y=upper_bound, color='Upper bound GMST', linetype='GMST'), data=ns_model_loop_GMST.evol) +
    geom_line(aes(x=year, y=upper_bound, color='Upper bound 2 GMST', linetype='GMST'), data=ns_model_loop_no_max_GMST.evol) +
    geom_line(aes(x=year, y=upper_bound, color='Upper bound EMST', linetype='EMST'), size=0.75, data=ns_model_loop_EMST.evol) +
    geom_line(aes(x=year, y=upper_bound, color='Upper bound 2 EMST', linetype='EMST'), size=0.75, data=ns_model_loop_no_max_EMST.evol) +
    #geom_ribbon(aes(x=year, ymin=upper_bound_low, ymax=upper_bound_high, fill='Upper bound 95% confidence interval'),alpha=0.4, data =ns_model_loop.evol) +
    geom_point(aes(x=year, y=var), alpha=0.4, size=0.5, data = TX_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario%in%c(sc), station %in% st))+
    geom_point(aes(x=year, y=var), color='#FF0000', alpha=0.6, size=1, data = TX_adjust_stations_max %>% filter(CMIP_model==CMIP_mod, scenario==sc, station %in% st)) +
    theme_minimal() + 
    theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
    #ylim(0,80) +
    #facet_wrap(~ns_model+station, scale='free') +
    facet_grid(cols=vars(ns_model), scale='free') +
    labs(title=paste('GEV fit with data-',st,'-',CMIP_mod, '-', sc), 
         x='Year',
         y='Temperature[°C]', 
         fill='', 
         colour='', 
         linetype='Covariate') +
    scale_linetype_manual(values=c('GMST'='solid', 'EMST'='twodash'))+
    scale_fill_manual(values=c('#FF0000', '#0000FF'), labels=list(bquote(~mu~"+/-"~sigma), bquote(" Upper bound")))+
    scale_color_manual(values = c('Loc_GMST'='#FF0000', 'Loc_EMST'='#ff9933', 'Upper bound GMST'='#0000FF','Upper bound 2 GMST'='#33ccff', 'Upper bound EMST'='#336600', 'Upper bound 2 EMST'='#cccc00'), labels=list(bquote("Location-GMST-"*mu), bquote("Location-EMST-"*mu), bquote("Upper bound-GMST-"~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no max-GMST- "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-EMST- "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no max-EMST- "~mu~ "-" ~sigma~"/"~xi)))
    #scale_color_manual(values = c('Loc_GMST'='#FF0000', 'Loc_EMST'='#ff9933', 'Upper bound GMST'='#0000FF', 'Upper bound EMST'='#336600'), labels=list(bquote("Location-GMST-"*mu), bquote("Location-EMST-"*mu), bquote("Upper bound-GMST-"~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-EMST- "~mu~ "-" ~sigma~"/"~xi)))
  print(p)
  #ggsave(paste(fig_path,"data_and_gev_GMST_and_EMST_fit_", CMIP_mod, "_", sc, "_", st, ".png", sep=""), width=8, height=5)
}
}
```

```{r, TASMIN, Plot data with fit from Adjusted GEV-GMST and EMST}
ns_mod_loop = ns_models
st = c('Cirfontaines')
for(CMIP_mod in c('TaiESM1')){
  scenarios_loop = Reduce(intersect, list(v1 = unique(ns_model_GMST.tasmin.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario)), 
                                          v2 = unique(ns_model_GMST_no_max.tasmin.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario)), 
                                          v3 = unique(ns_model_EMST.tasmin.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario)), 
                                          v4 = unique(ns_model_EMST_no_max.tasmin.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario))))
  for(sc in scenarios_loop[[1]]){
  ns_model_loop_GMST.evol = ns_model_GMST.tasmin.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  ns_model_loop_no_max_GMST.evol = ns_model_GMST_no_max.tasmin.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  ns_model_loop_EMST.evol = ns_model_EMST.tasmin.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  ns_model_loop_no_max_EMST.evol = ns_model_EMST_no_max.tasmin.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  #ns_model_loop_no_hist.evol = ns_model_GMST_no_hist.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  #ns_model_loop_2.evol = ns_model_GMST.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model==ns_mod_2)
  #print(head(ns_model_loop.evol))
  p=ggplot() +
    geom_ribbon(aes(x=year, ymin=-loc-scale, ymax=-loc+scale, fill='GEV confidence interval'),alpha=0.2, data =ns_model_loop_GMST.evol) +
    geom_line(aes(x=year, y=-loc, colour='Loc_GMST', linetype='GMST'), data=ns_model_loop_GMST.evol) +
    geom_ribbon(aes(x=year, ymin=-loc-scale, ymax=-loc+scale, fill='GEV confidence interval'),alpha=0.2, data =ns_model_loop_EMST.evol) +
    geom_line(aes(x=year, y=-loc, colour='Loc_EMST', linetype='EMST'), data=ns_model_loop_EMST.evol) +
    #geom_line(aes(x=year, y=loc, colour='Loc 2'), linetype = 'longdash', data=ns_model_loop_no_hist.evol) +
    geom_line(aes(x=year, y=-upper_bound, color='Upper bound GMST', linetype='GMST'), data=ns_model_loop_GMST.evol) +
    geom_line(aes(x=year, y=-upper_bound, color='Upper bound 2 GMST', linetype='GMST'), data=ns_model_loop_no_max_GMST.evol) +
    geom_line(aes(x=year, y=-upper_bound, color='Upper bound EMST', linetype='EMST'), size=0.75, data=ns_model_loop_EMST.evol) +
    geom_line(aes(x=year, y=-upper_bound, color='Upper bound 2 EMST', linetype='EMST'), size=0.75, data=ns_model_loop_no_max_EMST.evol) +
    #geom_line(aes(x=year, y=upper_bound, color='Upper bound 3'), data=ns_model_loop_no_hist.evol) +
    #geom_ribbon(aes(x=year, ymin=upper_bound_low, ymax=upper_bound_high, fill='Upper bound 95% confidence interval'),alpha=0.4, data =ns_model_loop.evol) +
    geom_point(aes(x=year, y=var), alpha=0.4, size=0.5, data = TN_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario%in%c(sc), station %in% st))+
    geom_point(aes(x=year, y=var), color='#FF0000', alpha=0.6, size=1, data = TN_adjust_stations_max %>% filter(CMIP_model==CMIP_mod, scenario==sc, station %in% st)) +
    theme_minimal() + 
    theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
    #ylim(0,80) +
    #facet_wrap(~ns_model+station, scale='free') +
    facet_grid(cols=vars(ns_model), scale='free') +
    labs(title=paste('GEV fit with model-',CMIP_mod, '-', sc), 
         x='Year',
         y='Temperature[°C]', 
         fill='', 
         colour='', 
         linetype='Covariate') +
    scale_linetype_manual(values=c('GMST'='solid', 'EMST'='twodash'))+
    scale_fill_manual(values=c('#FF0000', '#0000FF'), labels=list(bquote(~mu~"+/-"~sigma), bquote(" Upper bound")))+
    scale_color_manual(values = c('Loc_GMST'='#FF0000', 'Loc_EMST'='#ff9933', 'Upper bound GMST'='#0000FF','Upper bound 2 GMST'='#33ccff', 'Upper bound EMST'='#336600', 'Upper bound 2 EMST'='#cccc00'), labels=list(bquote("Location-GMST-"*mu), bquote("Location-EMST-"*mu), bquote("Upper bound-GMST-"~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no max-GMST- "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-EMST- "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no max-EMST- "~mu~ "-" ~sigma~"/"~xi)))
    #scale_color_manual(values = c('Loc_GMST'='#FF0000', 'Loc_EMST'='#ff9933', 'Upper bound GMST'='#0000FF','Upper bound 2 GMST'='#33ccff', 'Upper bound EMST'='#990099', 'Upper bound 2 EMST'='#ff66cc'), labels=list(bquote("Location-GMST-"*mu), bquote("Location-EMST-"*mu), bquote("Upper bound-GMST-"~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no max-GMST- "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-EMST- "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no max-EMST- "~mu~ "-" ~sigma~"/"~xi)))
  print(p)
  ggsave(paste(fig_path,"TN_data_and_gev_GMST_and_EMST_fit_", CMIP_mod, "_", sc, "_", st, ".png", sep=""), width=8, height=5)
}
}
```

```{r, TASMIN, Plot data with fit from Adjusted GEV-GMST}
ns_mod_loop = ns_models
st = c('St Dizier')
for(CMIP_mod in c('IPSL-CM6A-LR')){
  scenarios_loop = Reduce(intersect, list(v1 = unique(ns_model_GMST.tasmin.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario)),
                                          v2 = unique(ns_model_GMST_no_hist.tasmin.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario)), 
                                          v3 = unique(ns_model_GMST_no_max.tasmin.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario)),
                                          v4 = unique(ns_model_GMST_no_hist_no_max.tasmin.evol %>% filter(CMIP_model==CMIP_mod, station %in% st) %>%select(scenario))))
  for(sc in scenarios_loop[[1]]){
  ns_model_loop_GMST.evol = ns_model_GMST.tasmin.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  ns_model_loop_no_hist_GMST.evol = ns_model_GMST_no_hist.tasmin.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  ns_model_loop_no_max_GMST.evol = ns_model_GMST_no_max.tasmin.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  ns_model_loop_no_hist_no_max_GMST.evol = ns_model_GMST_no_hist_no_max.tasmin.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, ns_model %in% ns_mod_loop, station %in% st)
  p=ggplot() +
    geom_ribbon(aes(x=year, ymin=-loc-scale, ymax=-loc+scale, fill='GEV confidence interval'),alpha=0.2, data =ns_model_loop_GMST.evol) +
    geom_line(aes(x=year, y=-loc, colour='Loc_GMST', linetype='Hist+SSP'), data=ns_model_loop_GMST.evol) +
    geom_ribbon(aes(x=year, ymin=-loc-scale, ymax=-loc+scale, fill='GEV confidence interval'),alpha=0.2, data =ns_model_loop_no_hist_GMST.evol) +
    geom_line(aes(x=year, y=-loc, colour='Loc_EMST', linetype='No Hist'), data=ns_model_loop_no_hist_GMST.evol) +
    #geom_line(aes(x=year, y=loc, colour='Loc 2'), linetype = 'longdash', data=ns_model_loop_no_hist.evol) +
    geom_line(aes(x=year, y=-upper_bound, color='Upper bound GMST', linetype='Hist+SSP'), data=ns_model_loop_GMST.evol) +
    geom_line(aes(x=year, y=-upper_bound, color='Upper bound 2 GMST', linetype='Hist+SSP'), data=ns_model_loop_no_max_GMST.evol) +
    geom_line(aes(x=year, y=-upper_bound, color='Upper bound EMST', linetype='No Hist'), size=0.75, data=ns_model_loop_no_hist_GMST.evol) +
    geom_line(aes(x=year, y=-upper_bound, color='Upper bound 2 EMST', linetype='No Hist'), size=0.75, data=ns_model_loop_no_hist_no_max_GMST.evol) +
    #geom_line(aes(x=year, y=upper_bound, color='Upper bound 3'), data=ns_model_loop_no_hist.evol) +
    #geom_ribbon(aes(x=year, ymin=upper_bound_low, ymax=upper_bound_high, fill='Upper bound 95% confidence interval'),alpha=0.4, data =ns_model_loop.evol) +
    geom_point(aes(x=year, y=var), alpha=0.4, size=0.5, data = TN_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario%in%c(sc), station %in% st))+
    geom_point(aes(x=year, y=var), color='#FF0000', alpha=0.6, size=1, data = TN_adjust_stations_max %>% filter(CMIP_model==CMIP_mod, scenario==sc, station %in% st)) +
    theme_minimal() + 
    theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
    #ylim(0,80) +
    #facet_wrap(~ns_model+station, scale='free') +
    facet_grid(cols=vars(ns_model), scale='free') +
    labs(title=paste('GEV fit with model-',st, '-', CMIP_mod, '-', sc, 'GMST'), 
         x='Year',
         y='Temperature[°C]', 
         fill='', 
         colour='', 
         linetype='Covariate') +
    scale_linetype_manual(values=c('Hist+SSP'='solid', 'No Hist'='twodash'))+
    scale_fill_manual(values=c('#FF0000', '#0000FF'), labels=list(bquote(~mu~"+/-"~sigma), bquote(" Upper bound")))+
    scale_color_manual(values = c('Loc_GMST'='#FF0000', 'Loc_EMST'='#ff9933', 'Upper bound GMST'='#0000FF','Upper bound 2 GMST'='#33ccff', 'Upper bound EMST'='#336600', 'Upper bound 2 EMST'='#cccc00'), labels=list(bquote("Location-GMST-"*mu), bquote("Location-EMST-"*mu), bquote("Upper bound-Original-"~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no max- "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no hist- "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no hist-no max- "~mu~ "-" ~sigma~"/"~xi)))
    #scale_color_manual(values = c('Loc_GMST'='#FF0000', 'Loc_EMST'='#ff9933', 'Upper bound GMST'='#0000FF','Upper bound 2 GMST'='#33ccff', 'Upper bound EMST'='#990099', 'Upper bound 2 EMST'='#ff66cc'), labels=list(bquote("Location-GMST-"*mu), bquote("Location-EMST-"*mu), bquote("Upper bound-GMST-"~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no max-GMST- "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-EMST- "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no max-EMST- "~mu~ "-" ~sigma~"/"~xi)))
  print(p)
  ggsave(paste(fig_path,"tasmin_data_and_gev_GMST_fit_no_hist", CMIP_mod, "_", sc, "_", st, ".png", sep=""), width=8, height=5)
}
}
```

```{r, Special case of fit -GMST-}
CMIP_mod = 'EC-Earth3'
sc = 'ssp585'
st = 'Cirfontaines'
ns_mod = c('M000', 'M100', 'M110')

ns_model_loop.evol = ns_model_GMST.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model %in% ns_mod)
ns_model_loop_no_max.evol = ns_model_GMST_no_max.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model %in% ns_mod)

ggplot() +
  geom_ribbon(aes(x=year, ymin=loc-scale, ymax=loc+scale, fill='GEV confidence interval'),alpha=0.2, data =ns_model_loop.evol) +
  geom_line(aes(x=year, y=loc, colour='Black'), data=ns_model_loop.evol) +
  geom_line(aes(x=year, y=upper_bound, color='Upper bound'), data=ns_model_loop.evol) +
  geom_line(aes(x=year, y=upper_bound, color='Upper bound 2'), data=ns_model_loop_no_max.evol) +
  geom_point(aes(x=year, y=var), alpha=0.4, size=0.5, data = TX_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario%in%c(sc), station==st))+
  geom_point(aes(x=year, y=var), color='#FF0000', alpha=0.6, size=1, data = TX_adjust_stations_max %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st)) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
  facet_grid(cols=vars(ns_model), scale='free') +
  labs(title=paste('GEV fit with model-',st,'-',CMIP_mod, '-', sc, '-GMST'), 
       x='Year',
       y='Temperature[°C]', 
       fill='', 
       colour='') +
  scale_fill_manual(values=c('#FF0000', '#0000FF'), labels=list(bquote(~mu~"+/-"~sigma), bquote(" Upper bound")))+
  scale_color_manual(values = c('#FF0000', '#0000FF', '#33ccff'), labels=list(bquote("Location "*mu), bquote("Upper bound "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no max- "~mu~ "-" ~sigma~"/"~xi)))
  
#ggsave(paste(fig_path,"data_and_gev_GMST_fit_", CMIP_mod, "_", sc, "_",st, ".png", sep=""), width=9, height=4)
```

```{r, Special case of fit -EMST- MPI ssp370 Cirfontaines}
CMIP_mod = 'BCC-CSM2-MR'
sc = 'ssp126'
st = 'St Dizier'
ns_mod = 'M110'

ns_model_loop.evol = ns_model_EMST.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model==ns_mod)
ns_model_loop_no_max.evol = ns_model_EMST_no_max.evol %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st, ns_model==ns_mod)

ggplot() +
  geom_ribbon(aes(x=year, ymin=loc-scale, ymax=loc+scale, fill='GEV confidence interval'),alpha=0.2, data =ns_model_loop.evol) +
  geom_line(aes(x=year, y=loc, colour='Black'), data=ns_model_loop.evol) +
  geom_line(aes(x=year, y=upper_bound, color='Upper bound'), data=ns_model_loop.evol) +
  geom_line(aes(x=year, y=upper_bound, color='Upper bound 2'), data=ns_model_loop_no_max.evol) +
  geom_point(aes(x=year, y=var), alpha=0.4, size=0.5, data = TX_adjust_stations_GMST %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st))+
  geom_point(aes(x=year, y=var), color='#FF0000', alpha=0.6, size=1, data = TX_adjust_stations_max %>% filter(CMIP_model==CMIP_mod, scenario==sc, station==st)) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
  #facet_grid(cols=vars(ns_model), scale='free') +
  labs(title=paste('GEV fit with model-',st,'-',CMIP_mod, '-', sc,'-',ns_mod,'-EMST'), 
       x='Year',
       y='Temperature[°C]', 
       fill='', 
       colour='') +
  scale_fill_manual(values=c('#FF0000', '#0000FF'), labels=list(bquote(~mu~"+/-"~sigma), bquote(" Upper bound")))+
  scale_color_manual(values = c('#FF0000', '#0000FF', '#33ccff'), labels=list(bquote("Location "*mu), bquote("Upper bound "~mu~ "-" ~sigma~"/"~xi), bquote("Upper bound-no max- "~mu~ "-" ~sigma~"/"~xi)))
  
ggsave(paste(fig_path,"data_and_gev_EMST_fit_", ns_mod, '_',CMIP_mod, "_", sc, "_",st, ".png", sep=""), width=8, height=3)
```


##Return values plots

###Obs

```{r, Compute observational return values}
#Yearly data
TX_adjust_stations_true_rl = data.frame(matrix(ncol = ncol(TX_adjust_stations)+1, nrow = 0))
colnames(TX_adjust_stations_true_rl) <- append(colnames(TX_adjust_stations),c('return_period'))

#Daily data
tasmax_adjust_stations_true_rl = data.frame(matrix(ncol = ncol(tasmax_adjust_stations)+1, nrow = 0))
colnames(tasmax_adjust_stations_true_rl) <- append(colnames(tasmax_adjust_stations),c('return_period'))

for(CMIP_mod in models){
  for(sc in scenarios){
  for(st in stations){
    #Yearly data 
    TX_loop = TX_adjust_stations %>% filter(scenario == sc, station == st, CMIP_model==CMIP_mod)
    n = length(unique(TX_loop$year))+1
    TX_loop$return_period[sort(TX_loop$var, index.return=TRUE, decreasing=TRUE)$ix] = n/seq(1,n+1, 1)
    TX_adjust_stations_true_rl = rbind(TX_adjust_stations_true_rl, TX_loop)
    
    #Daily data
    #print(tasmax_adjust_stations %>% filter(scenario == sc, station == st) %>% select(TX))
    data = tasmax_adjust_stations %>% filter(scenario == sc, station == st, CMIP_model==CMIP_mod)
    u = quantile(data$var, probs=0.95)
    df_loop = tasmax_adjust_stations %>% filter(scenario == sc, station == st, CMIP_model==CMIP_mod, var>u)
    df_loop$return_period[sort(df_loop$var, index.return=TRUE, decreasing=TRUE)$ix] = n/seq(1,n+1, 1)
    tasmax_adjust_stations_true_rl = rbind(tasmax_adjust_stations_true_rl, df_loop)
  }
}
}
```

```{r, Observational return level}
st = 'Cirfontaines'
CMIP_mod = 'IPSL-CM6A-LR'

TX_adjust_stations_true_rl %>%
  filter(station==st, CMIP_model==CMIP_mod) %>%
  ggplot(aes(x=return_period, y=var, color=scenario)) +
  geom_point() +
  scale_x_log10() +
  theme_minimal() +
  labs(x='Return period [Year]', 
       y='Temperature [°C]', 
       color='Scenario',
       title = paste('Return levels from adjusted data-',st, '-',CMIP_mod))

ggsave(paste(fig_path,"return_level_obs_adjust_", CMIP_mod,"_",st, ".png", sep=""), width=6, height=3)

```

```{r, Plot return levels GEV/GPD with observations}
plot_rl_gev = TX_adjust_stations.gev.rl %>%
  ggplot(aes(x=return_period, y=return_level, color = scenario)) +
  geom_line()+
  geom_point(aes(x= return_period, y=var), data = TX_adjust_stations_true_rl)+
  geom_ribbon(aes(ymin = low, ymax = high), linetype=0, alpha = 0.1) +
  scale_x_log10() +
  theme_minimal() +
  xlab('Return period [Year]')+
  ylab('Return Level [°C]') +
  ggtitle('Return levels from GEV') +
  facet_wrap(~station)

plot_rl_gpd = TX_adjust_stations.gpd.rl %>%
  ggplot(aes(x=return_period, y=return_level, color = scenario)) +
  geom_line()+
  geom_point(aes(x= return_period, y=var), data = TX_adjust_stations_true_rl)+
  #geom_point(aes(x= return_period, y=var), alpha=0.5, data = tasmax_adjust_stations_true_rl)+
  geom_ribbon(aes(ymin = low, ymax = high),linetype=0, alpha = 0.05) +
  scale_x_log10() +
  theme_minimal() +
  xlab('Return period [Year]')+
  ylab('Return Level [°C]') +
  ggtitle('Return levels from GPD') +
  facet_wrap(~station)

plot_rl_gpd.JJA = TX_adjust_stations.gpd.JJA.rl %>%
  ggplot(aes(x=return_period, y=return_level, color = scenario)) +
  geom_line()+
  geom_point(aes(x= return_period, y=var), data = TX_adjust_stations_true_rl)+
  #geom_point(aes(x= return_period, y=var), data = tasmax_adjust_stations_true_rl.JJA)+
  geom_ribbon(aes(ymin = low, ymax = high),linetype=0, alpha = 0.05) +
  scale_x_log10() +
  theme_minimal() +
  xlab('Return period [Year]')+
  ylab('Return Level [°C]') +
  ggtitle('Return levels from summer GPD') +
  facet_wrap(~station)

plot_rl_gev + plot_rl_gpd.JJA# /plot_rl_gpd.JJA
#ggsave(paste(fig_path,"return_level_gev_summer_gpd.png", sep=""), height = 4, width = 10)
```

```{r, Plot return levels}
stations_loop = c('Cirfontaines', 'St Dizier')
ns_mod = 'M110'
ggplot() +
  geom_point(aes(x=CMIP_model, y=return_level, color=scenario), size=3,
             data = ns_model_GMST_final.gev.rl%>%filter(ns_model==ns_mod, station %in% stations_loop)) +  
  geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color=scenario), alpha=0.5,
                data = ns_model_GMST_final.gev.rl%>%filter(ns_model==ns_mod, station %in% stations_loop))+
  #geom_point(aes(x=CMIP_model, y=return_level, color=scenario, shape='EMST'), size=3,
  #           data = ns_model_EMST_final.gev.rl%>%filter(ns_model=='M110', station=='St Dizier')) +
  #geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color=scenario, shape='EMST'), alpha=0.5,
  #              data = ns_model_EMST_final.gev.rl%>%filter(ns_model=='M110', station=='St Dizier'))+
  geom_point(aes(x=CMIP_model, y=var, shape='Most extreme historical'), color='black', 
             data = TX_adjust_stations_max %>% filter(scenario=='historical', station %in%stations_loop)) +
  scale_x_discrete(guide = guide_axis(angle=60)) +
  facet_wrap(~station)+
  #facet_grid(rows=vars(station))+
  labs(x='CMIP model', 
       y='Temperature [°C]', 
       title='100 years return level horizon 2100-tasmax-M(110)-GMST', 
       color='Scenarios', 
       shape='')+
  theme_minimal()
#ggsave(paste(fig_path,"100y_return_level_2100_tasmax_hist_most_extreme_value_GMST_M110.png", sep=""), height = 4, width = 8)
```




###GEV fit

```{r, TASMAX return levels and historical record, ALL stations}
sc = 'ssp126'
ggplot() +
  geom_point(aes(x=CMIP_model, y=return_level, color=ns_model), size=2.5, 
             data = ns_model_GMST.gev.rl %>% filter(scenario==sc)) +
  geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color=ns_model), alpha=0.5, width = 0.4, 
                data=ns_model_GMST.gev.rl %>% filter(scenario==sc))+
  geom_point(aes(x=CMIP_model, y=TX, shape='Observational record'),data = TX_record_stations %>% filter(scenario==sc)) +
  geom_point(aes(x=CMIP_model, y=var, shape='Historical record'), size=2, data = TX_adjust_stations_max %>% filter(scenario=='historical')) +
  scale_x_discrete(guide = guide_axis(angle=60)) +
  facet_wrap(~station) +
  #ylim(37, 65) +
  labs(x='CMIP Model', 
       y='Temperature [°C]', 
       color='GEV Model', 
       shape='', 
       title=paste('100y return level horizon 2100 -', sc, '-GMST')) +
  theme_minimal()
ggsave(paste(fig_path,"tasmax_100y_return_level_GMST_no_final_all_",sc,".png", sep=""), height = 5, width = 8)
```

```{r, TASMAX return levels and historical record, ONE station}
st='Cirfontaines'
sc = 'ssp126'
ggplot() +
  geom_point(aes(x=CMIP_model, y=return_level, color=ns_model), size=2.5, 
             data = ns_model_GMST.gev.rl %>% filter(scenario==sc, station==st)) +
  geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color=ns_model), alpha=0.5, width = 0.4, 
                data=ns_model_GMST.gev.rl %>% filter(scenario==sc, station==st))+
  geom_point(aes(x=CMIP_model, y=TX, shape='Observational record'),
             data = TX_record_stations %>% filter(scenario==sc, station==st)) +
  geom_point(aes(x=CMIP_model, y=var, shape='Historical record'), size=2, 
             data = TX_adjust_stations_max %>% filter(scenario=='historical', station==st)) +
  scale_x_discrete(guide = guide_axis(angle=60)) +
  facet_wrap(~station) +
  #ylim(37, 65) +
  labs(x='CMIP Model', 
       y='Temperature [°C]', 
       color='GEV Model', 
       shape='', 
       title=paste('100y return level horizon 2100 -', sc, '-GMST')) +
  theme_minimal()
ggsave(paste(fig_path,"tasmax_100y_return_level_GMST_no_final_",st,"_",sc,".png", sep=""), height = 6, width = 8)
```

```{r, TASMIN return levels and historical record, ALL stations}
sc = 'ssp126'
ggplot() +
  geom_point(aes(x=CMIP_model, y=return_level, color=ns_model), size=2.5, 
             data = ns_model_tasmin_GMST_final.gev.rl %>% filter(scenario==sc)) +
  geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color=ns_model), alpha=0.5, width = 0.4, 
                data=ns_model_tasmin_GMST_final.gev.rl %>% filter(scenario==sc))+
  geom_point(aes(x=CMIP_model, y=TN, shape='Observational record'),data = TN_record_stations %>% filter(scenario==sc)) +
  geom_point(aes(x=CMIP_model, y=var, shape='Historical record'), size=2, data = TN_adjust_stations_max %>% filter(scenario=='historical')) +
  scale_x_discrete(guide = guide_axis(angle=60)) +
  facet_wrap(~station) +
  labs(x='CMIP Model', 
       y='Temperature [°C]', 
       color='GEV Model', 
       shape='', 
       title=paste('100y return level horizon 2100 -', sc, '-GMST')) +
  theme_minimal()
ggsave(paste(fig_path,"tasmin_100y_return_level_GMST_all_",sc,".png", sep=""), height = 5, width = 8)
```

```{r, TASMIN return levels and historical record, ONE station}
st = 'Cirfontaines'
sc = 'ssp126'
ggplot() +
  geom_point(aes(x=CMIP_model, y=return_level, color=ns_model), size=2.5, 
             data = ns_model_tasmin_GMST.gev.rl %>% filter(scenario==sc, station==st)) +
  geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color=ns_model), alpha=0.5, width = 0.3, 
                data=ns_model_tasmin_GMST.gev.rl %>% filter(scenario==sc, station==st))+
  geom_point(aes(x=CMIP_model, y=TN, shape='Observational record'), size=2, data = TN_record_stations %>% filter(scenario==sc, station==st)) +
  geom_point(aes(x=CMIP_model, y=var, shape='Historical record'), size=2, data = TN_adjust_stations_max %>% filter(scenario=='historical', station==st)) +
  scale_x_discrete(guide = guide_axis(angle=60)) +
  facet_wrap(~station) +
  labs(x='CMIP Model', 
       y='Temperature [°C]', 
       color='GEV Model', 
       shape='', 
       title=paste('100y return level horizon 2100 -', sc, '-GMST')) +
  theme_minimal()
ggsave(paste(fig_path,"tasmin_100y_return_level_GMST_no_final_",st,"_",sc,".png", sep=""), height = 6, width = 8)
```

####Difference between downscalling methods

```{r, TX return level CDFt and R2D2, ONE stations}
st = 'Cirfontaines'
sc = 'ssp585'
ns_mod = 'M110'

ggplot() +
  geom_point(aes(x=CMIP_model, y=return_level, shape='Return Level', color='R2D2'), size=2.5, 
             data = ns_model_GMST.gev.rl %>% filter(scenario==sc, station==st, ns_model==ns_mod)) +
  geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color='R2D2'), alpha=0.5, width = 0.4, 
                data=ns_model_GMST.gev.rl %>% filter(scenario==sc, station==st, ns_model==ns_mod))+
  
  geom_point(aes(x=CMIP_model, y=return_level, shape='Return Level', color='CDFt'), size=2.5, 
             data = ns_model_CDFt_GMST.gev.rl %>% filter(scenario==sc, station==st, ns_model==ns_mod)) +
  geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color='CDFt'), alpha=0.5, width = 0.4, 
                data=ns_model_CDFt_GMST.gev.rl %>% filter(scenario==sc, station==st, ns_model==ns_mod))+
  
  geom_point(aes(x=CMIP_model, y=return_level, shape='Return Level', color='CMIP'), size=2.5, 
             data = ns_model_CMIP_GMST.gev.rl %>% filter(scenario==sc, ns_model==ns_mod)) +
  geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color='CMIP'), alpha=0.5, width = 0.4, 
                data=ns_model_CMIP_GMST.gev.rl %>% filter(scenario==sc, ns_model==ns_mod))+
  
  geom_point(aes(x=CMIP_model, y=TX, shape='Observational record'),data = TX_record_stations %>% filter(scenario==sc, station==st)) +
  geom_point(aes(x=CMIP_model, y=var, shape='Historical record', color='R2D2'), size=2, data = TX_adjust_stations_max %>% filter(scenario=='historical', station==st)) +
  geom_point(aes(x=CMIP_model, y=var, shape='Historical record', color='CDFt'), size=2, data = TX_adjust_CDFt_stations_max %>% filter(scenario=='historical', station==st)) +
  geom_point(aes(x=CMIP_model, y=var, shape='Historical record', color='CMIP'), size=2, data = TX_CMIP6_GE_max %>% filter(scenario=='historical')) +
  scale_x_discrete(guide = guide_axis(angle=60)) +
  #facet_wrap(~station) +
  #ylim(37, 65) +
  labs(x='CMIP Model', 
       y='Temperature [°C]', 
       color='GEV Model', 
       shape='', 
       title=paste('100y return level horizon 2100 -',st, '-', sc, '-', ns_mod,'-GMST')) +
  theme_minimal()
#ggsave(paste(fig_path,"tasmax_100y_return_level_GMST_CDFT_R2D2_CMIP_no_final_",ns_mod,'_',st,"_",sc,".png", sep=""), height = 6, width = 8)
```

##Impact of the historical data in the GEV fit

```{r, Absolute difference computation}
#GMST
ns_model_GMST_diff_no_hist.gev.params =  merge(ns_model_GMST_final.gev.params, ns_model_GMST_no_hist_final.gev.params, by=c("CMIP_model", "station", "scenario", "ns_model"))
ns_model_GMST_diff_no_hist.gev.rl =  merge(ns_model_GMST_final.gev.rl, ns_model_GMST_no_hist_final.gev.rl, by=c("CMIP_model", "station", "scenario", "ns_model", "return_horizon", "return_period"))
ns_model_GMST_diff_no_hist.gev.params = merge(ns_model_GMST_diff_no_hist.gev.params, tas_global_spline %>% filter(year==2099))
ns_model_GMST_diff_no_hist.gev.all = merge(ns_model_GMST_diff_no_hist.gev.params, ns_model_GMST_diff_no_hist.gev.rl, by=c("CMIP_model", "station", "scenario", "ns_model"))
ns_model_GMST_diff_no_hist.gev.all = ns_model_GMST_diff_no_hist.gev.all %>% 
  mutate(return_level_diff = return_level.y - return_level.x, 
         r2_diff = r2.y - r2.x, 
         loc_diff = (loc_0.y + loc_1.y*var + b.y + a.y*var) - (loc_0.x + loc_1.x*var + b.x + a.x*var), 
         exp_in_scale = ifelse(ns_model%in%c('M000', 'M100', 'M-100'), 0,1) ,
         scale_diff = exp_in_scale*(exp(scale_0.y + scale_1.y*var) - exp(scale_0.x + scale_1.x*var)) +
           (1-exp_in_scale)*(scale_0.y - scale_0.x), 
         upper_bound_diff = loc_diff - 
           ((exp_in_scale*(exp(scale_0.y + scale_1.y*var)) + (1-exp_in_scale)*scale_0.y)/shape.y - 
              (exp_in_scale*(exp(scale_0.x + scale_1.x*var)) + (1-exp_in_scale)*scale_0.x)/shape.x)
         ) 

#EMST
ns_model_EMST_diff_no_hist.gev.params =  merge(ns_model_EMST_final.gev.params, ns_model_EMST_no_hist_final.gev.params, by=c("CMIP_model", "station", "scenario", "ns_model"))
ns_model_EMST_diff_no_hist.gev.rl =  merge(ns_model_EMST_final.gev.rl, ns_model_EMST_no_hist_final.gev.rl, by=c("CMIP_model", "station", "scenario", "ns_model", "return_horizon", "return_period"))
ns_model_EMST_diff_no_hist.gev.params = merge(ns_model_EMST_diff_no_hist.gev.params, tas_global_spline %>% filter(year==2099))
ns_model_EMST_diff_no_hist.gev.all = merge(ns_model_EMST_diff_no_hist.gev.params, ns_model_EMST_diff_no_hist.gev.rl, by=c("CMIP_model", "station", "scenario", "ns_model"))
ns_model_EMST_diff_no_hist.gev.all = ns_model_EMST_diff_no_hist.gev.all %>% 
  mutate(return_level_diff = return_level.y - return_level.x, 
         r2_diff = r2.y - r2.x, 
         loc_diff = (loc_0.y + loc_1.y*var + b.y + a.y*var) - (loc_0.x + loc_1.x*var + b.x + a.x*var), 
         exp_in_scale = ifelse(ns_model%in%c('M000', 'M100', 'M-100'), 0,1) ,
         scale_diff = exp_in_scale*(exp(scale_0.y + scale_1.y*var) - exp(scale_0.x + scale_1.x*var)) +
           (1-exp_in_scale)*(scale_0.y - scale_0.x), 
         upper_bound_diff = loc_diff - 
           ((exp_in_scale*(exp(scale_0.y + scale_1.y*var)) + (1-exp_in_scale)*scale_0.y)/shape.y - 
              (exp_in_scale*(exp(scale_0.x + scale_1.x*var)) + (1-exp_in_scale)*scale_0.x)/shape.x)
         ) 
```

```{r, return level fct r2}
ggplot() +
  geom_point(aes(x=r2_diff, y=return_level_diff, color=scenario, shape='GMST'), 
             data = ns_model_GMST_diff_no_hist.gev.all%>%filter(ns_model=='M110')) + 
  geom_point(aes(x=r2_diff, y=return_level_diff, color=scenario, shape='EMST'), 
             data = ns_model_EMST_diff_no_hist.gev.all%>%filter(ns_model=='M110')) + 
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +

  #geom_point(aes(x=ns_model_GMST_no_hist.gev.params$r2, y=ns_model_GMST_no_hist.gev.rl$return_level, color='No', ns_mod='M110')) + 
  labs(x='R2 score difference', 
       y='Return level difference [°C]', 
       color='Scenario',
       shape='Covariate',
       title='Difference models without and with historical data,M110')+
  #facet_wrap(~scenario) +
  theme_minimal()
ggsave(paste(fig_path,"100y_return_level_2100_diff_no_hist_original.png", sep=""), width=7, height=4)
```

```{r, upper bound fct r2}
ggplot() +
  geom_point(aes(x=r2_diff, y=upper_bound_diff, color=scenario, shape='GMST'), 
             data = ns_model_GMST_diff_no_hist.gev.all%>%filter(ns_model=='M110')) + 
  geom_point(aes(x=r2_diff, y=upper_bound_diff, color=scenario, shape='EMST'), 
             data = ns_model_EMST_diff_no_hist.gev.all%>%filter(ns_model=='M110')) + 
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +

  #geom_point(aes(x=ns_model_GMST_no_hist.gev.params$r2, y=ns_model_GMST_no_hist.gev.rl$return_level, color='No', ns_mod='M110')) + 
  labs(x='R2 score difference', 
       y='Upper bound difference horizon 2100 [°C]', 
       color='Scenario',
       shape='Covariate',
       title='Difference between the models without and with the historical data')+
  ylim(-70,50)+
  #facet_wrap(~scenario) +
  theme_minimal()
ggsave(paste(fig_path,"upper_bound_2100_diff_no_hist_original.png", sep=""), width=6, height=4)
```

```{r, Shape parameter values}
st='St Dizier'
ggplot()+
  geom_point(aes(x=CMIP_model, y=shape, color='Only SSP'), size=2,
             data = ns_model_GMST_no_hist_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  geom_errorbar(aes(x=CMIP_model, ymin=shape_low, ymax=shape_high, color='Only SSP'), alpha=0.5,
             data = ns_model_GMST_no_hist_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  geom_point(aes(x=CMIP_model, y=shape, color='Historical + SSP'), size=2,
             data = ns_model_GMST_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  geom_errorbar(aes(x=CMIP_model, ymin=shape_low, ymax=shape_high, color='Historical + SSP'), alpha=0.5,
             data = ns_model_GMST_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  ylim(-0.5, 0)+
  scale_x_discrete(guide = guide_axis(angle=45)) +
  facet_wrap(~scenario) +
  labs(x='Model CMIP', y='Shape', 
       color='Data used', 
       title = 'Shape parameter for the simulation with and without historical data') +
  theme_minimal()

ggsave(paste(fig_path,"tasmax_shape_no_hist_original_",st,".png", sep=""), width=8, height=5)
```

##Impact of the most extreme value

```{r, compute dataframes without yearly and daily maximum}
tasmax_adjust_stations_no_max = data.frame(tasmax_adjust_stations)
tasmax_adjust_stations_max = data.frame(matrix(ncol = ncol(tasmax_adjust_stations_no_max), nrow = 0))
colnames(tasmax_adjust_stations_max) = colnames(tasmax_adjust_stations_no_max)
tasmax_adjust_stations_diff_max = data.frame(matrix(ncol=4, nrow = 0))
colnames(tasmax_adjust_stations_diff_max) = c('CMIP_model', 'scenario', 'station', 'var')

#tasmax_adjust_stations_no_max.JJA = data.frame(tasmax_adjust_stations.JJA)
#tasmax_adjust_stations_max.JJA = data.frame(matrix(ncol = ncol(tasmax_adjust_stations_no_max.JJA), nrow = 0))
#colnames(tasmax_adjust_stations_max.JJA) = colnames(tasmax_adjust_stations_no_max.JJA)

TX_adjust_stations_no_max = data.frame(TX_adjust_stations)
TX_adjust_stations_max = data.frame(matrix(ncol = ncol(TX_adjust_stations_no_max), nrow = 0))
colnames(TX_adjust_stations_max) = colnames(TX_adjust_stations_no_max)
TX_adjust_stations_diff_max = data.frame(matrix(ncol = 4, nrow = 0))
colnames(TX_adjust_stations_diff_max) = c('CMIP_model', 'scenario', 'station', 'var')

for(CMIP_mod in models){
  for(sc in scenarios){
  for(st in stations){
    #Remove all the year corresponding to the daily maximum
    df_max_loop = which(tasmax_adjust_stations_no_max$var == max(tasmax_adjust_stations %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var))  & tasmax_adjust_stations_no_max$CMIP_model == CMIP_mod & tasmax_adjust_stations_no_max$station ==st & tasmax_adjust_stations_no_max$scenario==sc)
    tasmax_adjust_stations_max = rbind(tasmax_adjust_stations_max, tasmax_adjust_stations_no_max[c(df_max_loop), ])
    
    year_max_loop = tasmax_adjust_stations_no_max[df_max_loop,]$year
    df_year_max_loop = which(tasmax_adjust_stations_no_max$station == st & 
                               tasmax_adjust_stations_no_max$scenario == sc &
                               tasmax_adjust_stations_no_max$CMIP_model == CMIP_mod &
                               tasmax_adjust_stations_no_max$year == year_max_loop)
    #tasmax_adjust_stations_no_max = tasmax_adjust_stations_no_max[-c(df_year_max_loop),]
    tasmax_adjust_stations_no_max[c(df_year_max_loop),'var']=NaN
    
    #Remove yearly maximum
    TX_max_loop = which(TX_adjust_stations_no_max$var == max(TX_adjust_stations %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var)) & TX_adjust_stations_no_max$CMIP_model == CMIP_mod & TX_adjust_stations_no_max$station ==st & TX_adjust_stations_no_max$scenario==sc)
    TX_adjust_stations_max = rbind(TX_adjust_stations_max, TX_adjust_stations_no_max[c(TX_max_loop), ])
    #TX_adjust_stations_no_max = TX_adjust_stations_no_max[-c(TX_max_loop), ]
    TX_adjust_stations_no_max[c(TX_max_loop), 'var'] = NaN
    
    diff_loop = max(TX_adjust_stations %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var)) -
      max(TX_adjust_stations_no_max %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var), na.rm = TRUE)
    TX_adjust_stations_diff_max = rbind(TX_adjust_stations_diff_max, data.frame(CMIP_model=CMIP_mod, 
                                                                                scenario=sc, 
                                                                                station=st, 
                                                                                var = diff_loop))
  }
}
}
```

```{r, compute dataframes without yearly and daily maximum, CDFt}
tasmax_adjust_CDFt_stations_no_max = data.frame(tasmax_adjust_CDFt_stations)
tasmax_adjust_CDFt_stations_max = data.frame(matrix(ncol = ncol(tasmax_adjust_CDFt_stations_no_max), nrow = 0))
colnames(tasmax_adjust_CDFt_stations_max) = colnames(tasmax_adjust_CDFt_stations_no_max)
tasmax_adjust_CDFt_stations_diff_max = data.frame(matrix(ncol=4, nrow = 0))
colnames(tasmax_adjust_CDFt_stations_diff_max) = c('CMIP_model', 'scenario', 'station', 'var')

#tasmax_adjust_stations_no_max.JJA = data.frame(tasmax_adjust_stations.JJA)
#tasmax_adjust_stations_max.JJA = data.frame(matrix(ncol = ncol(tasmax_adjust_stations_no_max.JJA), nrow = 0))
#colnames(tasmax_adjust_stations_max.JJA) = colnames(tasmax_adjust_stations_no_max.JJA)

TX_adjust_CDFt_stations_no_max = data.frame(TX_adjust_CDFt_stations)
TX_adjust_CDFt_stations_max = data.frame(matrix(ncol = ncol(TX_adjust_CDFt_stations_no_max), nrow = 0))
colnames(TX_adjust_CDFt_stations_max) = colnames(TX_adjust_CDFt_stations_no_max)
TX_adjust_CDFt_stations_diff_max = data.frame(matrix(ncol = 4, nrow = 0))
colnames(TX_adjust_CDFt_stations_diff_max) = c('CMIP_model', 'scenario', 'station', 'var')

for(CMIP_mod in models_no_GFDL){
  for(sc in scenarios){
  for(st in stations){
    #Remove all the year corresponding to the daily maximum
    df_max_loop = which(tasmax_adjust_CDFt_stations_no_max$var == max(tasmax_adjust_CDFt_stations %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var))  & tasmax_adjust_CDFt_stations_no_max$CMIP_model == CMIP_mod & tasmax_adjust_CDFt_stations_no_max$station ==st & tasmax_adjust_CDFt_stations_no_max$scenario==sc)
    tasmax_adjust_CDFt_stations_max = rbind(tasmax_adjust_CDFt_stations_max, tasmax_adjust_CDFt_stations_no_max[c(df_max_loop), ])
    
    year_max_loop = tasmax_adjust_CDFt_stations_no_max[df_max_loop,]$year
    df_year_max_loop = which(tasmax_adjust_CDFt_stations_no_max$station == st & 
                               tasmax_adjust_CDFt_stations_no_max$scenario == sc &
                               tasmax_adjust_CDFt_stations_no_max$CMIP_model == CMIP_mod &
                               tasmax_adjust_CDFt_stations_no_max$year == year_max_loop)
    #tasmax_adjust_stations_no_max = tasmax_adjust_stations_no_max[-c(df_year_max_loop),]
    tasmax_adjust_CDFt_stations_no_max[c(df_year_max_loop),'var']=NaN
    
    #Remove yearly maximum
    TX_max_loop = which(TX_adjust_CDFt_stations_no_max$var == max(TX_adjust_CDFt_stations %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var)) & TX_adjust_CDFt_stations_no_max$CMIP_model == CMIP_mod & TX_adjust_CDFt_stations_no_max$station ==st & TX_adjust_CDFt_stations_no_max$scenario==sc)
    TX_adjust_CDFt_stations_max = rbind(TX_adjust_CDFt_stations_max, TX_adjust_CDFt_stations_no_max[c(TX_max_loop), ])
    #TX_adjust_stations_no_max = TX_adjust_stations_no_max[-c(TX_max_loop), ]
    TX_adjust_CDFt_stations_no_max[c(TX_max_loop), 'var'] = NaN
    
    diff_loop = max(TX_adjust_CDFt_stations %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var)) -
      max(TX_adjust_CDFt_stations_no_max %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var), na.rm = TRUE)
    TX_adjust_CDFt_stations_diff_max = rbind(TX_adjust_CDFt_stations_diff_max, data.frame(CMIP_model=CMIP_mod, 
                                                                                scenario=sc, 
                                                                                station=st, 
                                                                                var = diff_loop))
  }
}
}
```

```{r, compute dataframes without yearly and daily maximum, CMIP}
tasmax_CMIP6_GE_no_max = data.frame(tasmax_CMIP6_GE)
tasmax_CMIP6_GE_max = data.frame(matrix(ncol = ncol(tasmax_CMIP6_GE_no_max), nrow = 0))
colnames(tasmax_CMIP6_GE_max) = colnames(tasmax_CMIP6_GE_no_max)
tasmax_CMIP6_GE_diff_max = data.frame(matrix(ncol=4, nrow = 0))
colnames(tasmax_CMIP6_GE_diff_max) = c('CMIP_model', 'scenario', 'station', 'var')

TX_CMIP6_GE_no_max = data.frame(TX_CMIP6_GE)
TX_CMIP6_GE_max = data.frame(matrix(ncol = ncol(TX_CMIP6_GE_no_max), nrow = 0))
colnames(TX_CMIP6_GE_max) = colnames(TX_CMIP6_GE_no_max)
TX_CMIP6_GE_diff_max = data.frame(matrix(ncol = 4, nrow = 0))
colnames(TX_CMIP6_GE_diff_max) = c('CMIP_model', 'scenario', 'station', 'var')

for(CMIP_mod in models){
  for(sc in scenarios){
  for(st in c('GrandEst')){
    #Remove all the year corresponding to the daily maximum
    df_max_loop = which(tasmax_CMIP6_GE_no_max$var == max(tasmax_CMIP6_GE %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var))  & tasmax_CMIP6_GE_no_max$CMIP_model == CMIP_mod & tasmax_CMIP6_GE_no_max$station ==st & tasmax_CMIP6_GE_no_max$scenario==sc)
    tasmax_CMIP6_GE_max = rbind(tasmax_CMIP6_GE_max, tasmax_CMIP6_GE_no_max[c(df_max_loop), ])
    
    year_max_loop = tasmax_CMIP6_GE_no_max[df_max_loop,]$year
    df_year_max_loop = which(tasmax_CMIP6_GE_no_max$station == st & 
                               tasmax_CMIP6_GE_no_max$scenario == sc &
                               tasmax_CMIP6_GE_no_max$CMIP_model == CMIP_mod &
                               tasmax_CMIP6_GE_no_max$year == year_max_loop)
    #tasmax_adjust_stations_no_max = tasmax_adjust_stations_no_max[-c(df_year_max_loop),]
    tasmax_CMIP6_GE_no_max[c(df_year_max_loop),'var']=NaN
    
    #Remove yearly maximum
    TX_max_loop = which(TX_CMIP6_GE_no_max$var == max(TX_CMIP6_GE %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var)) & TX_CMIP6_GE_no_max$CMIP_model == CMIP_mod & TX_CMIP6_GE_no_max$station ==st & TX_CMIP6_GE_no_max$scenario==sc)
    TX_CMIP6_GE_max = rbind(TX_CMIP6_GE_max, TX_CMIP6_GE_no_max[c(TX_max_loop), ])
    #TX_adjust_stations_no_max = TX_adjust_stations_no_max[-c(TX_max_loop), ]
    TX_CMIP6_GE_no_max[c(TX_max_loop), 'var'] = NaN
    
    diff_loop = max(TX_CMIP6_GE %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var)) -
      max(TX_CMIP6_GE_no_max %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var), na.rm = TRUE)
    TX_CMIP6_GE_diff_max = rbind(TX_CMIP6_GE_diff_max, data.frame(CMIP_model=CMIP_mod, 
                                                                                scenario=sc, 
                                                                                station=st, 
                                                                                var = diff_loop))
  }
}
}
```

```{r, TASMIN, compute dataframes without yearly and daily maximum}
tasmin_adjust_stations_no_max = data.frame(tasmin_adjust_stations)
tasmin_adjust_stations_max = data.frame(matrix(ncol = ncol(tasmin_adjust_stations_no_max), nrow = 0))
colnames(tasmin_adjust_stations_max) = colnames(tasmin_adjust_stations_no_max)
tasmin_adjust_stations_diff_max = data.frame(matrix(ncol=4, nrow = 0))
colnames(tasmin_adjust_stations_diff_max) = c('CMIP_model', 'scenario', 'station', 'var')

TN_adjust_stations_no_max = data.frame(TN_adjust_stations)
TN_adjust_stations_max = data.frame(matrix(ncol = ncol(TN_adjust_stations_no_max), nrow = 0))
colnames(TN_adjust_stations_max) = colnames(TN_adjust_stations_no_max)
TN_adjust_stations_diff_max = data.frame(matrix(ncol = 4, nrow = 0))
colnames(TN_adjust_stations_diff_max) = c('CMIP_model', 'scenario', 'station', 'var')

for(CMIP_mod in models){
  for(sc in scenarios){
  for(st in stations){
    #Remove all the year corresponding to the daily maximum
    df_max_loop = which(tasmin_adjust_stations_no_max$var == min(tasmin_adjust_stations %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var))  & tasmin_adjust_stations_no_max$CMIP_model == CMIP_mod & tasmin_adjust_stations_no_max$station ==st & tasmin_adjust_stations_no_max$scenario==sc)
    tasmin_adjust_stations_max = rbind(tasmin_adjust_stations_max, tasmin_adjust_stations_no_max[c(df_max_loop), ])
    
    year_max_loop = tasmin_adjust_stations_no_max[df_max_loop,]$year
    df_year_max_loop = which(tasmin_adjust_stations_no_max$station == st & 
                               tasmin_adjust_stations_no_max$scenario == sc &
                               tasmin_adjust_stations_no_max$CMIP_model == CMIP_mod &
                               tasmin_adjust_stations_no_max$year == year_max_loop)
    #tasmax_adjust_stations_no_max = tasmax_adjust_stations_no_max[-c(df_year_max_loop),]
    tasmin_adjust_stations_no_max[c(df_year_max_loop),'var']=NaN
    
    #Remove yearly maximum
    TN_max_loop = which(TN_adjust_stations_no_max$var == min(TN_adjust_stations %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var)) & TN_adjust_stations_no_max$CMIP_model == CMIP_mod & TN_adjust_stations_no_max$station ==st & TN_adjust_stations_no_max$scenario==sc)
    TN_adjust_stations_max = rbind(TN_adjust_stations_max, TN_adjust_stations_no_max[c(TN_max_loop), ])
    #TX_adjust_stations_no_max = TX_adjust_stations_no_max[-c(TX_max_loop), ]
    TN_adjust_stations_no_max[c(TN_max_loop), 'var'] = NaN
    
    diff_loop = max(TN_adjust_stations %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var)) -
      max(TN_adjust_stations_no_max %>% filter(station==st, scenario==sc, CMIP_model==CMIP_mod) %>% select(var), na.rm = TRUE)
    TN_adjust_stations_diff_max = rbind(TN_adjust_stations_diff_max, data.frame(CMIP_model=CMIP_mod, 
                                                                                scenario=sc, 
                                                                                station=st, 
                                                                                var = diff_loop))
  }
}
}
```

### Stationary
```{r, compute parameter and return levels on data frame without the max}
gev_no_max = gev_rl_fct(TX_adjust_stations_no_max, rl=TRUE, return_period, theoretical=FALSE, scenarios, stations)
params_all_spp_no_max.gev = gev_no_max$params
TX_adjust_stations_no_max.gev.rl = gev_no_max$return_levels

gpd_no_max = gpd_rl_fct(tasmax_adjust_stations_no_max, rl=TRUE, return_period, theoretical=FALSE, scenarios, stations)
params_all_spp_no_max.gpd = gpd_no_max$params
TX_adjust_stations_no_max.gpd.rl = gpd_no_max$return_levels 

gpd_no_max.JJA = gpd_rl_fct(tasmax_adjust_stations_no_max.JJA, rl=TRUE, return_period, theoretical=FALSE, scenarios, stations)
params_all_spp_no_max.gpd.JJA = gpd_no_max.JJA$params
TX_adjust_stations_no_max.gpd.rl.JJA = gpd_no_max.JJA$return_levels 
```

```{r, plot of the diff of return level without the max}
plot_rl_gev_diff_no_max = tibble(diff = TX_adjust_stations.gev.rl$return_level-TX_adjust_stations_no_max.gev.rl$return_level, 
                                 return_period = TX_adjust_stations.gev.rl$return_period, 
                                 station = TX_adjust_stations.gev.rl$station, 
                                 scenario = TX_adjust_stations.gev.rl$scenario) %>%
  ggplot(aes(x=return_period, y=diff, color = scenario)) +
  geom_line()+
  scale_x_log10() +
  theme_minimal() +
  ylim(0,4.2)+
  ylab("Difference [°C]") +
  ggtitle('Return level difference with GEV runned without the most extreme') +
  facet_wrap(~station)

plot_rl_gpd_diff_no_max = tibble(diff = TX_adjust_stations.gpd.rl$return_level-TX_adjust_stations_no_max.gpd.rl$return_level, 
                                 return_period = TX_adjust_stations.gpd.rl$return_period, 
                                 station = TX_adjust_stations.gpd.rl$station, 
                                 scenario = TX_adjust_stations.gpd.rl$scenario) %>%
  ggplot(aes(x=return_period, y=diff, color = scenario)) +
  geom_line()+
  scale_x_log10() +
  theme_minimal() +
  ylim(0,4.2)+
  ylab("Difference [°C]") +
  ggtitle('Return level difference with GPD runned without the most extreme') +
  facet_wrap(~station)

plot_rl_gev_diff_no_max / plot_rl_gpd_diff_no_max
#ggsave(paste(fig_path,"return_level_diff_no_max_gev_gpd.png", sep=""))
```

```{r, Computation of fixed return level from GEV/GPD fit without most extreme value}
return_level_target = 200

tasmax_adjust_stations_max_pred = data.frame(matrix(ncol = ncol(tasmax_adjust_stations_max)+2, nrow = 0))
colnames(tasmax_adjust_stations_max_pred) = append(colnames(tasmax_adjust_stations_max), c('low', 'high'))

tasmax_adjust_stations_max_pred.JJA = data.frame(matrix(ncol = ncol(tasmax_adjust_stations_max.JJA)+2, nrow = 0))
colnames(tasmax_adjust_stations_max_pred.JJA) = append(colnames(tasmax_adjust_stations_max.JJA), c('low', 'high'))

TX_adjust_stations_max_pred = data.frame(matrix(ncol = ncol(TX_adjust_stations_max)+2, nrow = 0))
colnames(TX_adjust_stations_max_pred) = append(colnames(TX_adjust_stations_max), c('low', 'high'))

for(sc in scenarios){
  for(st in stations){
    #return_period_max_loop = nrow(TX_adjust_stations %>% filter(station==st, scenario==sc)) 
    
    #gev
    loc_loop.gev = as.numeric(params_all_spp_no_max.gev %>% filter(station==st, scenario==sc) %>% select(loc))
    scale_loop.gev = as.numeric(params_all_spp_no_max.gev %>% filter(station==st, scenario==sc) %>% select(scale))
    shape_loop.gev = as.numeric(params_all_spp_no_max.gev %>% filter(station==st, scenario==sc) %>% select(shape))
    sim_loop = revd(500, loc=loc_loop.gev, scale = scale_loop.gev, shape = shape_loop.gev)
    sim_loop.gev = fevd(sim_loop)
    
    return_level_loop.gev = return.level(sim_loop.gev, return.period=return_level_target, do.ci=TRUE)
    TX_adjust_stations_max_pred = rbind(TX_adjust_stations_max_pred, data.frame(station=st, 
                                                                var = return_level_loop.gev[2], 
                                                                scenario = sc, 
                                                                year = NaN, 
                                                                rl= return_level_target, 
                                                                low = return_level_loop.gev[1], 
                                                                high = return_level_loop.gev[3]))
    
    #gpd
    scale_loop.gpd = as.numeric(params_all_spp_no_max.gpd %>% filter(station==st, scenario==sc) %>% select(scale))
    shape_loop.gpd = as.numeric(params_all_spp_no_max.gpd %>% filter(station==st, scenario==sc) %>% select(shape))
    u = quantile(tasmax_adjust_stations_no_max$var, probs = 0.95)
    sim_loop = revd(500, scale = scale_loop.gpd, shape = shape_loop.gpd, threshold=u, type='GP')
    sim_loop.gpd = fevd(sim_loop,type="GP",threshold=u,time.units = "365.25/year")
    
    return_level_loop.gpd = return.level(sim_loop.gpd, return.period=return_level_target, do.ci=TRUE)
    tasmax_adjust_stations_max_pred = rbind(tasmax_adjust_stations_max_pred, data.frame(station=st, 
                                                                var = return_level_loop.gpd[2], 
                                                                scenario = sc, 
                                                                year = NaN, 
                                                                rl= return_level_target, 
                                                                low = return_level_loop.gpd[1], 
                                                                high = return_level_loop.gpd[3]))
    
    #gpd summer 
    scale_loop.gpd.JJA = as.numeric(params_all_spp_no_max.gpd.JJA %>% filter(station==st, scenario==sc) %>% select(scale))
    shape_loop.gpd.JJA = as.numeric(params_all_spp_no_max.gpd.JJA %>% filter(station==st, scenario==sc) %>% select(shape))
    u.JJA = quantile(tasmax_adjust_stations_no_max.JJA$var, probs = 0.95)
    sim_loop = revd(500, scale = scale_loop.gpd.JJA, shape = shape_loop.gpd.JJA, threshold=u.JJA, type='GP')
    sim_loop.gpd.JJA = fevd(sim_loop,type="GP",threshold=u.JJA,time.units = "92/year")
    
    return_level_loop.gpd.JJA = return.level(sim_loop.gpd.JJA, return.period=return_level_target, do.ci=TRUE)
    tasmax_adjust_stations_max_pred.JJA = rbind(tasmax_adjust_stations_max_pred.JJA, data.frame(station=st, 
                                                                var = return_level_loop.gpd.JJA[2], 
                                                                scenario = sc, 
                                                                year = NaN, 
                                                                rl= return_level_target, 
                                                                low = return_level_loop.gpd.JJA[1], 
                                                                high = return_level_loop.gpd.JJA[3]))
    
  }
}
```

```{r, Plot return level n years for GEV/GPD without the most extreme values}
plot_rl_n_years_gev_no_max =
  ggplot() +
  geom_crossbar(aes(x = scenario, y=var, ymin=low, ymax=high, colour=scenario), data=TX_adjust_stations_max_pred)+
  geom_point(aes(x=scenario, y=var), data = TX_adjust_stations_max) +
  theme_minimal()+
  ylab('Maximum Yearly Temperature [°C]') +
  facet_wrap(~station) +
  scale_x_discrete(guide = guide_axis(angle=45)) +
  ggtitle(paste(return_level_target, 'y return value estimate-GEV without the most extreme'))

plot_rl_n_years_gpd_no_max.JJA = 
  ggplot() +
  geom_crossbar(aes(x = scenario, y=var, ymin=low, ymax=high, colour = scenario), data=tasmax_adjust_stations_max_pred.JJA)+
  geom_point(aes(x=scenario, y=var), data = tasmax_adjust_stations_max) +
  theme_minimal()+
  facet_wrap(~station) +
  scale_x_discrete(guide = guide_axis(angle=45)) +
  ylab('Maximum Daily Temperature [°C]') +
  ggtitle(paste(return_level_target, 'y return value estimate-summer GPD without the most extreme'))

plot_rl_n_years_gev_no_max + plot_rl_n_years_gpd_no_max.JJA
ggsave(paste(fig_path,"return_level_",return_level_target ,"_year_most_extreme_value_gev_summer_gpd_no_max.png", sep=""), height = 4, width = 12)
```

### Non stationary

```{r, Mutate data and add covariate}
TX_adjust_stations_no_max_GMST = merge(TX_adjust_stations_no_max, tas_global_spline_mutate, by=c("year", "scenario", "CMIP_model"))
TX_adjust_stations_no_max_EMST = merge(TX_adjust_stations_no_max, tas_europe_spline_mutate, by=c("year", "scenario", "CMIP_model"))
```

```{r, Computation of the absolute difference}
#### Parameters absolute difference ####
ns_model_GMST_diff_no_max.gev.params =  merge(ns_model_GMST_final.gev.params, ns_model_GMST_no_max_final.gev.params, by=c("CMIP_model", "station", "scenario", "ns_model"))
ns_model_GMST_diff_no_max.gev.params = merge(ns_model_GMST_diff_no_max.gev.params, tas_global_spline %>% filter(year==2099))
ns_model_GMST_diff_no_max.gev.params = na.omit(ns_model_GMST_diff_no_max.gev.params)
#ns_model_GMST_diff_no_max.gev.params %>% filter(CMIP_model=='ACCESS-ESM1-5', station=='Bure', scenario=='ssp126')
#head(ns_model_GMST_diff_no_max.gev.params %>% mutate(test = (loc_0.y + loc_1.y*covariate + b.y + a.y*covariate) - (loc_0.x + loc_1.x*covariate + b.x + a.x*covariate)))


ns_model_GMST_diff_no_max.gev.params = ns_model_GMST_diff_no_max.gev.params %>%
  mutate(loc_diff = (loc_0.y + loc_1.y*covariate + b.y + a.y*covariate) - (loc_0.x + loc_1.x*covariate + b.x + a.x*covariate), 
         loc_diff_low = (loc_0_low.y + loc_1_low.y*covariate + (b.y-b_std.y) + (a.y-a_std.y)*covariate) - (loc_0_high.x + loc_1_high.x*var + (b.x+b_std.x) + (a.x+a_std.x)*var), 
         loc_diff_high = (loc_0_high.y + loc_1_high.y*covariate + (b.y+b_std.y) + (a.y+a_std.y)*var) - (loc_0_low.x + loc_1_low.x*var + (b.x-b_std.x) + (a.x-a_std.x)*var), 
         exp_in_scale = ifelse(ns_model%in%c('M000', 'M100', 'M-100'), 0,1) ,
         scale_diff = exp_in_scale*(exp(scale_0.y + scale_1.y*var) - exp(scale_0.x + scale_1.x*var)) +
           (1-exp_in_scale)*(scale_0.y - scale_0.x), 
         #scale_diff_low = exp(scale_0_low.y + scale_1_low.y*var) - exp(scale_0_high.x + scale_1_high.x*var), 
         #scale_diff_high = exp(scale_0_high.y + scale_1_high.y*var) - exp(scale_0_low.x + scale_1_low.x*var), 
         shape_diff = shape.y - shape.x, 
         shape_low = shape_low.y - shape_high.x, 
         shape_high = shape_high.y - shape_low.x, 
         upper_bound_diff = loc_diff - 
           ((exp_in_scale*(exp(scale_0.y + scale_1.y*var)) + (1-exp_in_scale)*scale_0.y)/shape.y - 
              (exp_in_scale*(exp(scale_0.x + scale_1.x*var)) + (1-exp_in_scale)*scale_0.x)/shape.x)
         ) %>%
  select(-c(loc_0.x, loc_0_low.x, loc_0_high.x, loc_1.x, loc_1_low.x, loc_1_high.x, loc_0.y, loc_0_low.y, loc_0_high.y, loc_1.y, loc_1_low.y, loc_1_high.y, scale_0.x, scale_0_low.x, scale_0_high.x, scale_1.x, scale_1_low.x, scale_1_high.x, scale_0.y, scale_0_low.y, scale_0_high.y, scale_1.y, scale_1_low.y, scale_1_high.y, shape.x, shape.y, shape_low.x, shape_low.y, shape_high.x, shape_high.y, var, a.x, a_std.x, b.x, b_std.x, a.y, a_std.y, b.y, b_std.y, nllh.x, nllh.y))

ns_model_GMST_diff_no_max.gev.params = merge(ns_model_GMST_diff_no_max.gev.params, TX_adjust_stations_diff_max, by=c("CMIP_model", "station", "scenario"))

#### Return levels absolute difference ####
ns_model_GMST_diff_no_max.gev.rl =  merge(ns_model_GMST_final.gev.rl, ns_model_GMST_no_max_final.gev.rl, by=c("CMIP_model", "station", "scenario", "ns_model", "return_horizon", "return_period"))
ns_model_GMST_diff_no_max.gev.rl = na.omit(ns_model_GMST_diff_no_max.gev.rl)
ns_model_GMST_diff_no_max.gev.rl = ns_model_GMST_diff_no_max.gev.rl %>% 
  mutate(return_level_diff = return_level.y - return_level.x, 
         return_level_diff_low = return_level_low.y - return_level_high.x, 
         return_level_diff_high = return_level_high.y - return_level_low.x) %>%
  select(-c(return_level.x, return_level.y, return_level_low.x, return_level_low.y, return_level_high.x, return_level_high.y))

ns_model_GMST_diff_no_max.gev.rl = merge(ns_model_GMST_diff_no_max.gev.rl, TX_adjust_stations_diff_max, by=c("CMIP_model", "station", "scenario"))

####EMST####
ns_model_EMST_diff_no_max.gev.params =  merge(ns_model_EMST_final.gev.params, ns_model_EMST_no_max_final.gev.params, by=c("CMIP_model", "station", "scenario", "ns_model"))
ns_model_EMST_diff_no_max.gev.params = merge(ns_model_EMST_diff_no_max.gev.params, tas_global_spline %>% filter(year==2099))
ns_model_EMST_diff_no_max.gev.params = na.omit(ns_model_EMST_diff_no_max.gev.params)

ns_model_EMST_diff_no_max.gev.params = ns_model_EMST_diff_no_max.gev.params %>%
  mutate(loc_diff = (loc_0.y + loc_1.y*var + b.y + a.y*var) - (loc_0.x + loc_1.x*var + b.x + a.x*var), 
         loc_diff_low = (loc_0_low.y + loc_1_low.y*var + (b.y-b_std.y) + (a.y-a_std.y)*var) - (loc_0_high.x + loc_1_high.x*var + (b.x+b_std.x) + (a.x+a_std.x)*var), 
         loc_diff_high = (loc_0_high.y + loc_1_high.y*var + (b.y+b_std.y) + (a.y+a_std.y)*var) - (loc_0_low.x + loc_1_low.x*var + (b.x-b_std.x) + (a.x-a_std.x)*var), 
         exp_in_scale = ifelse(ns_model%in%c('M000', 'M100', 'M-100'), 0,1) ,
         scale_diff = exp_in_scale*(exp(scale_0.y + scale_1.y*var) - exp(scale_0.x + scale_1.x*var)) +
           (1-exp_in_scale)*(scale_0.y - scale_0.x), 
         #scale_diff_low = exp(scale_0_low.y + scale_1_low.y*var) - exp(scale_0_high.x + scale_1_high.x*var), 
         #scale_diff_high = exp(scale_0_high.y + scale_1_high.y*var) - exp(scale_0_low.x + scale_1_low.x*var), 
         shape_diff = shape.y - shape.x, 
         shape_low = shape_low.y - shape_high.x, 
         shape_high = shape_high.y - shape_low.x, 
         upper_bound_diff = loc_diff - 
           ((exp_in_scale*(exp(scale_0.y + scale_1.y*var)) + (1-exp_in_scale)*scale_0.y)/shape.y - 
              (exp_in_scale*(exp(scale_0.x + scale_1.x*var)) + (1-exp_in_scale)*scale_0.x)/shape.x)
         ) %>%
  select(-c(loc_0.x, loc_0_low.x, loc_0_high.x, loc_1.x, loc_1_low.x, loc_1_high.x, loc_0.y, loc_0_low.y, loc_0_high.y, loc_1.y, loc_1_low.y, loc_1_high.y, scale_0.x, scale_0_low.x, scale_0_high.x, scale_1.x, scale_1_low.x, scale_1_high.x, scale_0.y, scale_0_low.y, scale_0_high.y, scale_1.y, scale_1_low.y, scale_1_high.y, shape.x, shape.y, shape_low.x, shape_low.y, shape_high.x, shape_high.y, var, a.x, a_std.x, b.x, b_std.x, a.y, a_std.y, b.y, b_std.y, nllh.x, nllh.y))

ns_model_EMST_diff_no_max.gev.params = merge(ns_model_EMST_diff_no_max.gev.params, TX_adjust_stations_diff_max, by=c("CMIP_model", "station", "scenario"))

#### Return levels absolute difference ####
ns_model_EMST_diff_no_max.gev.rl =  merge(ns_model_EMST_final.gev.rl, ns_model_EMST_no_max_final.gev.rl, by=c("CMIP_model", "station", "scenario", "ns_model", "return_horizon", "return_period"))
ns_model_EMST_diff_no_max.gev.rl = ns_model_EMST_diff_no_max.gev.rl %>% 
  mutate(return_level_diff = return_level.y - return_level.x, 
         return_level_diff_low = return_level_low.y - return_level_high.x, 
         return_level_diff_high = return_level_high.y - return_level_low.x) %>%
  select(-c(return_level.x, return_level.y, return_level_low.x, return_level_low.y, return_level_high.x, return_level_high.y))

ns_model_EMST_diff_no_max.gev.rl = merge(ns_model_EMST_diff_no_max.gev.rl, TX_adjust_stations_diff_max, by=c("CMIP_model", "station", "scenario"))

```

```{r, Evolution of location as a function of scenario}
st='GrandEst'
P1 =ggplot()+
  geom_errorbar(aes(x=CMIP_model, ymin=loc_1_low, ymax=loc_1_high, color=scenario), alpha=0.6, width=0.2,
             data = ns_model_CMIP_EMST.gev$params%>%filter(ns_model=='M110', station==st)) +
  geom_point(aes(x=CMIP_model, y=loc_1, color=scenario), size=2,
             data = ns_model_CMIP_EMST.gev$params%>%filter(ns_model=='M110', station==st)) +
  scale_x_discrete(guide = guide_axis(angle=45)) +
  labs(x="", y='Location [°C]', 
       color='Scenario', 
       title = bquote("Location parameter ("~mu~ "1), M(110) EMST, GrandEst")) +
  theme_minimal()

P2 =ggplot()+
  geom_errorbar(aes(x=CMIP_model, ymin=loc_0_low, ymax=loc_0_high, color=scenario), alpha=0.6, width=0.2,
             data = ns_model_CMIP_EMST.gev$params%>%filter(ns_model=='M110', station==st)) +
  geom_point(aes(x=CMIP_model, y=loc_0, color=scenario), size=2,
             data = ns_model_CMIP_EMST.gev$params%>%filter(ns_model=='M110', station==st)) +
  scale_x_discrete(guide = guide_axis(angle=45)) +
  labs(x="CMIP model", y='Location [°C]', 
       color='Scenario', 
       title = bquote("Location parameter ("~mu~ "0), M(110) EMST, GrandEst")) +
  theme_minimal()

plot_grid(P1, P2, nrow=2)
#ggsave(paste(fig_path,"tasmax_CMIP_location_1_and_0_EMST_M110_",st,".png", sep=""), width=8, height=6)
```

```{r, location1 parameter values in sim with and without the max}
st='St Dizier'
ggplot()+
  geom_point(aes(x=CMIP_model, y=loc_1, color='No max'), size=2,
             data = ns_model_GMST_no_max_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  geom_errorbar(aes(x=CMIP_model, ymin=loc_1_low, ymax=loc_1_high, color='No max'), alpha=0.5,
             data = ns_model_GMST_no_max_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  geom_point(aes(x=CMIP_model, y=loc_1, color='All data'), size=2,
             data = ns_model_GMST_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  geom_errorbar(aes(x=CMIP_model, ymin=loc_1_low, ymax=loc_1_high, color='All data'), alpha=0.5,
             data = ns_model_GMST_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  #ylim(-0.5, 0)+
  scale_x_discrete(guide = guide_axis(angle=45)) +
  facet_wrap(~scenario) +
  labs(x="CMIP model", y='Location', 
       color='Data used', 
       title = bquote("Location parameter ("~mu~ "1), M(110) GMST, St Dizier")) +
  theme_minimal()

ggsave(paste(fig_path,"tasmax_location_1_no_max_original_GMST_M110_",st,".png", sep=""), width=8, height=5)
```

```{r, Evolution of scale as a function of scenario}
st='GrandEst'
P1 =ggplot()+
  geom_errorbar(aes(x=CMIP_model, ymin=scale_1_low, ymax=scale_1_high, color=scenario), alpha=0.6, width=0.2,
             data = ns_model_CMIP_EMST.gev$params%>%filter(ns_model=='M110', station==st)) +
  geom_point(aes(x=CMIP_model, y=scale_1, color=scenario), size=2,
             data = ns_model_CMIP_EMST.gev$params%>%filter(ns_model=='M110', station==st)) +
  scale_x_discrete(guide = guide_axis(angle=45)) +
  labs(x="", y='Scale', 
       color='Scenario', 
       title = bquote("Scale parameter ("~sigma~ "1), M(110) EMST, GrandEst")) +
  theme_minimal()

P2 =ggplot()+
  geom_errorbar(aes(x=CMIP_model, ymin=scale_0_low, ymax=scale_0_high, color=scenario), alpha=0.6, width=0.2,
             data = ns_model_CMIP_EMST.gev$params%>%filter(ns_model=='M110', station==st)) +
  geom_point(aes(x=CMIP_model, y=scale_0, color=scenario), size=2,
             data = ns_model_CMIP_EMST.gev$params%>%filter(ns_model=='M110', station==st)) +
  scale_x_discrete(guide = guide_axis(angle=45)) +
  labs(x="CMIP model", y='Scale', 
       color='Scenario', 
       title = bquote("Scale parameter ("~sigma~ "0), M(110) EMST, GrandEst")) +
  theme_minimal()

plot_grid(P1, P2, nrow=2)
ggsave(paste(fig_path,"tasmax_CMIP_scale_1_and_0_EMST_M110_",st,".png", sep=""), width=8, height=6)
```

```{r, scale1 parameter values in sim with and without the max}
st='St Dizier'
ggplot()+
  geom_point(aes(x=CMIP_model, y=scale_1, color='No max'), size=2,
             data = ns_model_GMST_no_max_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  geom_errorbar(aes(x=CMIP_model, ymin=scale_1_low, ymax=scale_1_high, color='No max'), alpha=0.5,
             data = ns_model_GMST_no_max_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  geom_point(aes(x=CMIP_model, y=scale_1, color='All data'), size=2,
             data = ns_model_GMST_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  geom_errorbar(aes(x=CMIP_model, ymin=scale_1_low, ymax=scale_1_high, color='All data'), alpha=0.5,
             data = ns_model_GMST_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  #ylim(-0.5, 0)+
  scale_x_discrete(guide = guide_axis(angle=45)) +
  facet_wrap(~scenario) +
  labs(x="CMIP model", y='Scale', 
       color='Data used', 
       title = bquote("Scale parameter ("~sigma~ "1), M(110) GMST, St Dizier")) +
  theme_minimal()

ggsave(paste(fig_path,"tasmax_scale_1_no_max_original_GMST_M110_",st,".png", sep=""), width=8, height=5)
```

```{r, Shape parameter values in sim with and without the max}
st='St Dizier'
ggplot()+
  geom_point(aes(x=CMIP_model, y=shape, color='No max'), size=2,
             data = ns_model_GMST_no_max_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  geom_errorbar(aes(x=CMIP_model, ymin=shape_low, ymax=shape_high, color='No max'), alpha=0.5,
             data = ns_model_GMST_no_max_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  geom_point(aes(x=CMIP_model, y=shape, color='All data'), size=2,
             data = ns_model_GMST_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  geom_errorbar(aes(x=CMIP_model, ymin=shape_low, ymax=shape_high, color='All data'), alpha=0.5,
             data = ns_model_GMST_final.gev.params%>%filter(ns_model=='M110', station==st)) +
  ylim(-0.5, 0)+
  scale_x_discrete(guide = guide_axis(angle=45)) +
  facet_wrap(~scenario) +
  labs(x="CMIP model", y='Shape', 
       color='Data used', 
       title = bquote("Shape parameter ("~xi~ "), M(110) GMST, St Dizier")) +
  theme_minimal()

#ggsave(paste(fig_path,"tasmax_shape_no_max_original_GMST_M110_",st,".png", sep=""), width=8, height=5)
```

```{r, Plot shape difference}
ggplot() +
  geom_point(aes(x=var, y=shape_diff, color=ns_model), 
             data = ns_model_GMST_diff_no_max.gev.params) + 
  geom_point(aes(x=var, y=shape_diff, color=ns_model), 
             data = ns_model_EMST_diff_no_max.gev.params) + 
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  #geom_point(aes(x=ns_model_GMST_no_hist.gev.params$r2, y=ns_model_GMST_no_hist.gev.rl$return_level, color='No', ns_mod='M110')) + 
  ylim(-0.09,0.025)+
  labs(x="Temperature difference between maximums[°C]", 
       y='Shape parameter difference', 
       color='Scenario',
       shape='Covariate',
       title='Difference between the models without and with the most extreme')+
  #facet_wrap(~scenario) +
  xlim(0, 4)+
  theme_minimal()
ggsave(paste(fig_path,"shape_diff_no_max_original.png", sep=""), width=6, height=4)
```

```{r, Plot upper bound difference}
ggplot() +
  geom_point(aes(x=var, y=upper_bound_diff, color=ns_model), 
             data = ns_model_GMST_diff_no_max.gev.params) + 
  geom_point(aes(x=var, y=upper_bound_diff, color=ns_model), 
             data = ns_model_EMST_diff_no_max.gev.params) + 
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  #geom_point(aes(x=ns_model_GMST_no_hist.gev.params$r2, y=ns_model_GMST_no_hist.gev.rl$return_level, color='No', ns_mod='M110')) + 
  #ylim(-10,0)+
  xlim(0, 4)+
  labs(x="Temperature difference between maximums[°C]", 
       y='Upper bound difference horizon 2100 [°C]', 
       color='Scenario',
       shape='Covariate',
       title='Difference between the models without and with the max')+
  #facet_wrap(~scenario) +
  theme_minimal()
ggsave(paste(fig_path,"upper_bound_2100_diff_no_max_original.png", sep=""), width=6, height=4)
```

```{r, Plot return level difference}
ggplot() +
  geom_point(aes(x=var, y=return_level_diff, color=ns_model), 
             data = ns_model_GMST_diff_no_max.gev.rl) + 
  geom_point(aes(x=var, y=return_level_diff, color=ns_model), 
             data = ns_model_EMST_diff_no_max.gev.rl) + 
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  #geom_point(aes(x=ns_model_GMST_no_hist.gev.params$r2, y=ns_model_GMST_no_hist.gev.rl$return_level, color='No', ns_mod='M110')) + 
  #ylim(-10,0)+
  labs(x="Temperature difference between maximums[°C]", 
       y='Upper bound difference horizon 2100 [°C]', 
       color='Scenario',
       shape='Covariate',
       title='Difference between the models without and with the max')+
  #facet_wrap(~scenario) +
  theme_minimal()
#ggsave(paste(fig_path,"return_level_diff_no_max_original.png", sep=""), width=6, height=4)
```

```{r, Proba of upper bound below TX in the run with no max}
TX_adjust_stations_diff_max_mutate = TX_adjust_stations_diff_max %>% 
  mutate(diff_to_max = floor(var)+0.5)

#### GMST ####
TX_adjust_stations_max_mutate_GMST = merge(TX_adjust_stations_max, ns_model_GMST_no_max.evol%>%select(station, CMIP_model, year, scenario, station, upper_bound, ns_model), by = c('station', 'CMIP_model', 'year', 'scenario'))
TX_adjust_stations_max_mutate_GMST = merge(TX_adjust_stations_max_mutate_GMST, TX_adjust_stations_diff_max_mutate%>%select(CMIP_model, station, scenario, diff_to_max), by=c('station', 'CMIP_model', 'scenario'))

TX_adjust_stations_max_mutate_GMST = TX_adjust_stations_max_mutate_GMST %>% 
  mutate(below_UB = ifelse(var>upper_bound, 1, 0))

#Compute probability of beeing above the upper bound  
p_above_CMIP_models_GMST = TX_adjust_stations_max_mutate_GMST %>%
  group_by(CMIP_model) %>%
  summarise(p = sum(below_UB)/length(below_UB), 
            n = sum(below_UB), 
            total = length(below_UB)) %>%
  as.data.frame()

p_above_GEV_models_GMST = TX_adjust_stations_max_mutate_GMST %>%
  group_by(ns_model) %>%
  summarise(p = sum(below_UB)/length(below_UB), 
             n = sum(below_UB), 
            total = length(below_UB)) %>%
  as.data.frame()

p_above_scenario_GMST = TX_adjust_stations_max_mutate_GMST %>%
  group_by(scenario) %>%
  summarise(p = sum(below_UB)/length(below_UB), 
             n = sum(below_UB), 
            total = length(below_UB)) %>%
  as.data.frame()

p_above_diff_max_GMST = TX_adjust_stations_max_mutate_GMST %>%
  group_by(diff_to_max) %>%
  summarise(p = sum(below_UB)/length(below_UB), 
            n = sum(below_UB), 
            total = length(below_UB)) %>%
  as.data.frame()

#### EMST ####
TX_adjust_stations_max_mutate_EMST = merge(TX_adjust_stations_max, ns_model_EMST_no_max.evol%>%select(station, CMIP_model, year, scenario, station, upper_bound, ns_model), by = c('station', 'CMIP_model', 'year', 'scenario'))
TX_adjust_stations_max_mutate_EMST = merge(TX_adjust_stations_max_mutate_EMST, TX_adjust_stations_diff_max_mutate%>%select(CMIP_model, station, scenario, diff_to_max), by=c('station', 'CMIP_model', 'scenario'))

TX_adjust_stations_max_mutate_EMST = TX_adjust_stations_max_mutate_EMST %>% 
  mutate(below_UB = ifelse(var>upper_bound, 1, 0))

#Compute probability of beeing above the upper bound  
p_above_CMIP_models_EMST = TX_adjust_stations_max_mutate_EMST %>%
  group_by(CMIP_model) %>%
  summarise(p = sum(below_UB)/length(below_UB), 
            n = sum(below_UB), 
            total = length(below_UB)) %>%
  as.data.frame()

p_above_GEV_models_EMST = TX_adjust_stations_max_mutate_EMST %>%
  group_by(ns_model) %>%
  summarise(p = sum(below_UB)/length(below_UB), 
             n = sum(below_UB), 
            total = length(below_UB)) %>%
  as.data.frame()

p_above_scenario_EMST = TX_adjust_stations_max_mutate_EMST %>%
  group_by(scenario) %>%
  summarise(p = sum(below_UB)/length(below_UB), 
             n = sum(below_UB), 
            total = length(below_UB)) %>%
  as.data.frame()

p_above_diff_max_EMST = TX_adjust_stations_max_mutate_EMST %>%
  group_by(diff_to_max) %>%
  summarise(p = sum(below_UB)/length(below_UB), 
            n = sum(below_UB), 
            total = length(below_UB)) %>%
  as.data.frame()
```

```{r, Plot difference in return level}
#Linear model
lm_model = lm(return_level_diff ~ var, data=ns_model_GMST_diff_no_max.gev.rl)
summary(lm_model)
print(cor(ns_model_GMST_diff_no_max.gev.rl$return_level_diff, predict(lm_model))^2)

RL_plot = ggplot() +
  geom_point(aes(x=var, y=return_level_diff, color=ns_model), 
             data = ns_model_GMST_diff_no_max.gev.rl) + 
  geom_line(aes(ns_model_GMST_diff_no_max.gev.rl$var, predict.lm(lm_model)), size=1.2, color='darkorange') +
  geom_point(aes(x=var, y=return_level_diff, color=ns_model), 
             data = ns_model_EMST_diff_no_max.gev.rl) + 
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +

  #geom_point(aes(x=ns_model_GMST_no_hist.gev.params$r2, y=ns_model_GMST_no_hist.gev.rl$return_level, color='No', ns_mod='M110')) + 
  labs(x="Temperature difference between maximums[°C]", 
       y='Return level difference [°C]', 
       color='Scenario',
       shape='Covariate',
       title='100y return level diff between the models without and with the max')+
  #ylim(-2,0) +
  xlim(0, 4)+
  #facet_wrap(~scenario) +
  theme_minimal()

Histogram_plot = ggplot() +
  geom_bar(aes(x=diff_to_max, y=p, fill='GMST'), alpha =0.4, stat="identity",data=p_above_diff_max_GMST) +
  geom_bar(aes(x=diff_to_max, y=p, fill='EMST'), alpha =0.4, stat="identity",data=p_above_diff_max_EMST) +
  labs(x="Temperature difference between maximums [°C]", 
       y="Percentage", 
       fill="Covariate",
       title = 'Models for which Max>Upper bound without max') +
  xlim(0, 4)+
  theme_minimal()

cowplot::plot_grid(RL_plot+theme(axis.text.x = element_blank(), 
                                 axis.ticks.x = element_blank(), 
                                 axis.title.x = element_blank()), 
                   Histogram_plot, 
                   nrow=2, 
                   rel_heights = c(2,1),
                   labels = c('', 
                              ''))
#ggsave(paste(fig_path,"100y_return_level_2100_diff_no_max_original_GMST_fit_and_histogram_max_sup_UB.png", sep=""), width=7, height=4)
```

```{r, GEV - Plot 100y non stationary as a function of year and model}
sc = 'ssp585'
ns_mod = 'M110'
ggplot() +
  geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color='2100-EMST-no max'), alpha=0.5, data=ns_model_EMST_no_max.gev.rl %>% filter(scenario==sc, ns_model==ns_mod))+
  geom_point(aes(x = CMIP_model, y=return_level, color='2100-EMST-no max'),size=2.5, alpha=0.5, data=ns_model_EMST_no_max.gev.rl %>% filter(scenario==sc, ns_model==ns_mod))+
  
  geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color='2100-EMST'), alpha=0.5, data=ns_model_EMST.gev.rl %>% filter(scenario==sc, ns_model==ns_mod))+
  geom_point(aes(x = CMIP_model, y=return_level, color='2100-EMST'), size=2.5, alpha=0.5, data=ns_model_EMST.gev.rl %>% filter(scenario==sc, ns_model==ns_mod))+
  
  #geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color='2050-EMST'), alpha=0.5, data=ns_model_EMST_2050.gev.rl %>% filter(scenario==sc, ns_model==ns_mod))+
  #geom_point(aes(x = CMIP_model, y = return_level, color='2050-EMST'), size=2.5, alpha=0.5, data=ns_model_EMST_2050.gev.rl %>% filter(scenario==sc, ns_model==ns_mod))+
  
  #geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color='2050-EMST-no max'), alpha=0.5, data=ns_model_EMST_no_max_2050.gev.rl %>% filter(scenario==sc, ns_model==ns_mod))+
  #geom_point(aes(x = CMIP_model, y = return_level, color='2050-EMST-no max'), alpha=0.5, data=ns_model_EMST_no_max_2050.gev.rl %>% filter(scenario==sc,ns_model==ns_mod))+
  geom_point(aes(x=CMIP_model, y=var), color='blue', data = TX_adjust_stations_max %>% filter(scenario==sc)) +
  theme_minimal() +
  ylim(35,75) +
  ylab('Maximum Temperature [°C]') +
  facet_wrap(~station) +
  scale_x_discrete(guide = guide_axis(angle=60)) +
  #scale_color_gradient2(low = 'red', high='firebrick4', mid='yellow', midpoint=2015) +
  ggtitle(paste('100y return level- GEV M(110) EMST - ssp585'))

#ggsave(paste(fig_path,"100y_return_level_most_extreme_value_EMST_M110_ssp585.png", sep=""), height = 6, width = 8)
```

```{r, GEV - Plot 100y non stationary as a function of year and model}
sc = 'ssp585'
ns_mod = 'M110'
ggplot() +
  geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color='2100-GMST-no max'), alpha=0.5, data=ns_model_GMST_no_max.gev.rl %>% filter(scenario==sc, ns_model==ns_mod))+
  geom_point(aes(x = CMIP_model, y=return_level, color='2100-GMST-no max'),size=2.5, alpha=0.5, data=ns_model_GMST_no_max.gev.rl %>% filter(scenario==sc, ns_model==ns_mod))+
  
  geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color='2100-GMST'), alpha=0.5, data=ns_model_GMST.gev.rl %>% filter(scenario==sc, ns_model==ns_mod))+
  geom_point(aes(x = CMIP_model, y=return_level, color='2100-GMST'), size=2.5, alpha=0.5, data=ns_model_GMST.gev.rl %>% filter(scenario==sc, ns_model==ns_mod))+
  
  #geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color='2050-GMST'), alpha=0.5, data=ns_model_GMST_2050.gev.rl %>% filter(scenario==sc, ns_model==ns_mod))+
  #geom_point(aes(x = CMIP_model, y = return_level, color='2050-GMST'), size=2.5, alpha=0.5, data=ns_model_GMST_2050.gev.rl %>% filter(scenario==sc, ns_model==ns_mod))+
  
  #geom_errorbar(aes(x = CMIP_model, ymin = return_level_low, ymax = return_level_high, color='2050-GMST-no max'), alpha=0.5, data=ns_model_GMST_no_max_2050.gev.rl %>% filter(scenario==sc, ns_model==ns_mod))+
  #geom_point(aes(x = CMIP_model, y = return_level, color='2050-GMST-no max'), alpha=0.5, data=ns_model_GMST_no_max_2050.gev.rl %>% filter(scenario==sc,ns_model==ns_mod))+
  geom_point(aes(x=CMIP_model, y=var), color='blue', data = TX_adjust_stations_max %>% filter(scenario==sc)) +
  theme_minimal() +
  ylim(35,75) +
  ylab('Maximum Temperature [°C]') +
  facet_wrap(~station) +
  scale_x_discrete(guide = guide_axis(angle=60)) +
  #scale_color_gradient2(low = 'red', high='firebrick4', mid='yellow', midpoint=2015) +
  ggtitle(paste('100y return level- GEV M(110) - ssp585'))

#ggsave(paste(fig_path,"100y_return_level_most_extreme_value_GMST_M110_ssp585.png", sep=""), height = 6, width = 8)
```

```{r, GEV - Multimodel mean return level vs historical record}
ns_mod = c('M110', 'M-110')

ns_model_GMST_final.gev.rl.mean = ns_model_GMST_final.gev.rl %>% filter(ns_model%in%ns_mod) %>% 
  group_by(station, scenario) %>% 
  summarise(mean_rl = mean(return_level), 
            max_rl = max(return_level), 
            min_rl = min(return_level),
            n = length(return_level),
            .groups='drop')

ggplot() +
  geom_point(aes(x=scenario, y=mean_rl, color=scenario), data = ns_model_GMST_final.gev.rl.mean)+
  geom_errorbar(aes(x=scenario, ymin=min_rl, ymax=max_rl, color=scenario), data = ns_model_GMST_final.gev.rl.mean) +
  geom_point(aes(x=scenario, y=TX, shape='Historical record'), data = TX_record_stations) +
  facet_wrap(~station) +
  #ylim(39,60)+
  labs(x='Scenarios', 
       y='Return level [°C]', 
       colour = 'Scenario', 
       shape='', 
       title='Multi-model mean 100y return level horizon 2100, M110, M-110, GMST') +
  scale_x_discrete(guide = guide_axis(angle=45)) +
  theme_minimal()
#ggsave(paste(fig_path,"100y_return_level_2100_multimodel_mean_M110_M-110_GMST.png", sep=""), width=7, height=4)
```

```{r, GEV - Multimodel mean return level vs historical record}
ns_mod = c('M110', 'M-110')

ns_model_GMST_final.gev.rl.mean = ns_model_GMST_final.gev.rl %>% filter(ns_model%in%ns_mod) %>% 
  group_by(station, scenario) %>% 
  summarise(mean_rl = mean(return_level), 
            max_rl = max(return_level), 
            min_rl = min(return_level),
            n = length(return_level),
            .groups='drop')

ggplot() +
  geom_point(aes(x=scenario, y=n, color=scenario), data = ns_model_GMST_final.gev.rl.mean)+
  #geom_errorbar(aes(x=scenario, ymin=min_rl, ymax=max_rl, color=scenario), data = ns_model_GMST_final.gev.rl.mean) +
  #geom_point(aes(x=scenario, y=TX, shape='Historical record'), data = TX_record_stations) +
  facet_wrap(~station) +
  #ylim(35,60)+
  labs(x='Scenarios', 
       y='Return level [°C]', 
       colour = 'Scenario', 
       shape='', 
       title='Multi-model mean 100y return level horizon 2100, M-110, M110, GMST') +
  scale_x_discrete(guide = guide_axis(angle=45)) +
  theme_minimal()
#ggsave(paste(fig_path,"100y_return_level_2100_multimodel_mean_M110_M-110_GMST_no_final.png", sep=""), width=7, height=4)
```

```{r, GEV - TASMIN- Multimodel mean return level vs historical record}
ns_mod = 'M110'

ns_model_tasmin_GMST_no_max.gev.rl.mean = ns_model_tasmin_GMST_final.gev.rl %>% filter(ns_model%in%ns_mod) %>% 
  group_by(station, scenario) %>% 
  summarise(mean_rl = mean(return_level), 
            max_rl = max(return_level), 
            min_rl = min(return_level), 
            .groups='drop')

ggplot() +
  geom_point(aes(x=scenario, y=mean_rl, color=scenario), data = ns_model_tasmin_GMST_no_max.gev.rl.mean)+
  geom_errorbar(aes(x=scenario, ymin=min_rl, ymax=max_rl, color=scenario), data = ns_model_tasmin_GMST_no_max.gev.rl.mean) +
  geom_point(aes(x=scenario, y=TN, shape='Historical record'), data = TN_record_stations) +
  facet_wrap(~station) +
  labs(x='Scenarios', 
       y='Return level [°C]', 
       colour = 'Scenario', 
       shape='', 
       title='Multi-model mean 100y return level horizon 2100, M(110), GMST') +
  scale_x_discrete(guide = guide_axis(angle=45)) +
  theme_minimal()
#ggsave(paste(fig_path,"100y_return_level_2100_multimodel_mean_M110_GMST.png", sep=""), width=7, height=4)
```
